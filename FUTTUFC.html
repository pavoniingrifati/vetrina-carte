<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FUT Fantaballa Tik Tok</title>
<meta name="description" content="Pack unico diviso per 'game' (Gotham City). Pacchetti finiti: Wonderkid (3 carte), Patatine (1 carta, pesato), Gotham Tots (3 carte), Legend (3 carte). Nuovo: Oggetti (3 carte, infinito). Login e salvataggio inventario invariati." />

<!-- Font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#e6f0ff; --panel:#f9fbff; --card:#ffffff; --card-2:#f0f6ff;
  --text:#123366; --muted:#6c87b5; --accent:#3399ff; --radius:18px;
  --g-comune:rgba(100,160,255,.25); --g-non-comune:rgba(80,140,255,.35);
  --g-rara:rgba(60,120,255,.45); --g-epica:rgba(40,100,255,.55);
  --g-ultra-rara:rgba(20,80,255,.65); --g-season:rgba(100,180,255,.7);

  --bg:#0b0f19; --panel:#0f1526; --card:#121a2e; --card-2:#0d1325; --text:#ecf0ff; --muted:#a7b0d3; --accent:#6ee7ff; --radius:18px;
  --g-comune:rgba(154,163,178,.30); --g-non-comune:rgba(52,211,153,.35); --g-rara:rgba(96,165,250,.45);
  --g-epica:rgba(167,139,250,.55); --g-ultra-rara:rgba(251,191,36,.65); --g-season:rgba(239,68,68,.7);
}
*{box-sizing:border-box} html,body{height:100%}
body{ margin:0; background: radial-gradient(1200px 800px at 10% -10%, #132040, transparent), var(--bg);
  color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow-x:hidden }
a{color:var(--accent); text-decoration:none}
header{ position:sticky; top:0; z-index:20; backdrop-filter: blur(10px);
  background:linear-gradient(180deg, rgba(13,19,37,.9), rgba(13,19,37,.6)); border-bottom:1px solid rgba(255,255,255,.06)}
.wrap{max-width:1200px; margin:0 auto; padding:20px}
.title{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
h1{margin:0; font-size:clamp(20px,3.6vw,34px)} .subtitle{color:var(--muted)}
.toolbar{display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; align-items:center}
.pill{display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:var(--text)}
.btn{background:linear-gradient(180deg,#1b2a4d,#152141); border:1px solid rgba(110,231,255,.35);
  border-radius:12px; color:#fff; padding:12px 16px; cursor:pointer}
.btn:disabled{opacity:.6; cursor:not-allowed}

/* FLASH */
.flash-line,.flash-screen{position:fixed; inset:0; pointer-events:none; z-index:40; opacity:0}
.flash-line::before{content:""; position:absolute; top:0; bottom:0; width:32vw;
  background:linear-gradient(90deg,transparent,rgba(255,230,120,.55),rgba(255,201,44,.8),rgba(255,230,120,.55),transparent);
  filter:blur(8px); transform:translateX(-40vw) skewX(-12deg)}
.flash-line.active{animation:sweep .75s ease-out forwards}
@keyframes sweep{0%{opacity:0}10%{opacity:1}100%{opacity:1}}
.flash-line.active::before{animation:sweepMove .75s ease-out forwards}
@keyframes sweepMove{to{transform:translateX(120vw) skewX(-12deg)}}
.flash-screen{background:radial-gradient(circle at 50% 50%, rgba(255,232,120,.45), transparent 55%)}
.flash-screen.active{animation:flash .35s ease-out forwards}
@keyframes flash{0%{opacity:0}30%{opacity:1}100%{opacity:0}}

/* GAME PICKER */
.choices{ display:flex; gap:14px; margin-top:12px; flex-wrap:wrap }
.choice{ display:flex; align-items:center; gap:10px; padding:8px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03); border-radius:14px; cursor:pointer; }
.choice[aria-selected="true"]{ outline:2px solid rgba(110,231,255,.5); background:rgba(255,255,255,.06) }
.prev{ width:90px; aspect-ratio: 690/987; border-radius:12px; background-size:cover; background-position:center;
  box-shadow:0 6px 16px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.08) }
.meta{ display:flex; flex-direction:column; line-height:1.15 }
.meta .name{ font-weight:700 }
.meta .price{ color:var(--muted); font-size:12px }

/* PACK */
.packArea{display:flex; align-items:center; justify-content:center; min-height:min(76vh,900px); position:relative}
.pack{ width:min(520px,86vw); aspect-ratio:690/987; background: center/cover no-repeat;
  border-radius:var(--radius); box-shadow:0 8px 24px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.08);
  transition:transform .2s ease, box-shadow .2s ease, filter .2s ease; position:relative; isolation:isolate; will-change:transform,filter }
.pack:hover{ transform:translateY(-2px); box-shadow:0 20px 60px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.12); filter:brightness(1.05)}
.pack.shake{animation:shake .35s ease-in-out 1}
@keyframes shake{0%,100%{transform:translateX(0) rotate(0)}25%{transform:translateX(-6px) rotate(-1deg)}50%{transform:translateX(5px) rotate(1deg)}75%{transform:translateX(-3px) rotate(-.6deg)}}
.pack.opening{animation:packOpen .9s cubic-bezier(.16,.84,.29,1) forwards}
@keyframes packOpen{0%{transform:scale(1) translateY(0); opacity:1}55%{transform:scale(.92) translateY(6px); filter:brightness(1.08)}75%{transform:scale(1.02) translateY(-6px); filter:brightness(1.25)}100%{transform:scale(.88) translateY(-12px); opacity:0}}

/* STAGE */
.stageWrap{display:none}
.stageWrap.show{display:block; animation:stageIn .5s ease .25s both}
@keyframes stageIn{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:none}}
.stage{margin:22px 0 40px; display:grid; gap:16px; grid-template-columns:repeat(1,minmax(0,1fr))}
@media(min-width:720px){.stage{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(min-width:1100px){.stage{grid-template-columns:repeat(3,minmax(0,1fr))}}

.cCard{position:relative; width:100%; aspect-ratio:690/987; border-radius:var(--radius); transform-style:preserve-3d; perspective:1200px}
.scene{position:absolute; inset:0; border-radius:inherit; transform-style:preserve-3d; transition:transform .7s cubic-bezier(.22,.75,.2,1);
  transform:rotateY(0deg); box-shadow:0 10px 28px rgba(0,0,0,.45); background:var(--card); will-change:transform}
.face{position:absolute; inset:0; border-radius:inherit; overflow:hidden; backface-visibility:hidden; border:1px solid rgba(255,255,255,.08);
  display:flex; align-items:center; justify-content:center}
.back img, .front img { width:100%; height:100%; object-fit:cover; display:block; aspect-ratio:690/987; }
.back img{filter:drop-shadow(0 10px 30px rgba(0,0,0,.45))}
.front{transform:rotateY(180deg)}

.drop{opacity:0; transform:translateY(-40px) scale(.96)}
.drop.in { animation: dropIn .5s cubic-bezier(.2,.8,.2,1) forwards; opacity: 1; }
@keyframes dropIn{0%{opacity:0; transform:translateY(-50px) scale(.96)}70%{opacity:1; transform:translateY(6px) scale(1.02)}100%{opacity:1; transform:translateY(0) scale(1)}}

.cCard[data-state="back"] .scene{transform:rotateY(0deg)}
.cCard[data-state="front"] .scene{transform:rotateY(180deg)}

/* Raggi + scintille */
.rays{position:absolute; inset:-10%; background:conic-gradient(from 0deg at 50% 50%, transparent, rgba(255,255,255,.05), transparent);
  filter:blur(16px); opacity:.7; mix-blend-mode:overlay; pointer-events:none}
.spark{position:absolute; inset:0; pointer-events:none}
.spark i{position:absolute; width:6px; height:6px; border-radius:999px; background:rgba(255,255,255,.9);
  filter:blur(1px); transform:translate(-50%,-50%) rotate(var(--rot)); animation:spark 1.2s ease-out forwards}
@keyframes spark{ 0%{opacity:0; transform:translate(-50%,-50%) rotate(var(--rot))}
  6%{opacity:1} 100%{opacity:0; transform:translate(calc(-50% + var(--xEnd)), calc(-50% - 120px)) rotate(var(--rot))} }

/* Rarit√† (glow) */
.cCard.r-comune .scene{box-shadow: 0 0 0 1px rgba(255,255,255,.08), 0 0 18px var(--g-comune)}
.cCard.r-non-comune .scene{box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 0 22px var(--g-non-comune)}
.cCard.r-rara .scene{box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 0 26px var(--g-rara)}
.cCard.r-epica .scene{box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 0 30px var(--g-epica)}
.cCard.r-ultra-rara .scene{box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 0 36px var(--g-ultra-rara)}
.cCard.r-season .scene{box-shadow:0 0 0 1px rgba(255,255,255,.08), 0 0 42px var(--g-season)}

.badge{position:absolute; top:10px; left:10px; padding:6px 8px; border-radius:10px; background:rgba(0,0,0,.35); font-size:12px}

.log{margin-top:8px; font-size:13px; color:var(--muted)}
footer{border-top:1px solid rgba(255,255,255,.06); background:linear-gradient(0deg, rgba(13,19,37,.85), rgba(13,19,37,.6))}
.foot{max-width:1200px; margin:0 auto; padding:12px 20px; font-size:13px; color:var(--muted)}
.pillFoot{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03)}

@media(max-width:600px){.wrap{padding:12px} .stage{grid-template-columns:1fr}}
</style>
<style>
/* ===== Legendary FX ===== */
.legend-fx{position:fixed;inset:0;pointer-events:none;z-index:9999;display:flex;align-items:center;justify-content:center;overflow:hidden}
.legend-fx .halo{position:absolute;width:40vmin;height:40vmin;border-radius:50%;box-shadow:0 0 30px 10px rgba(255,215,0,.6), 0 0 120px 40px rgba(255,140,0,.35), inset 0 0 60px rgba(255,255,255,.4);animation:legendHalo 1800ms ease-out forwards}
.legend-fx .rays{position:absolute;width:70vmin;height:70vmin;background:conic-gradient(from 0deg, rgba(255,215,0,.0), rgba(255,215,0,.9), rgba(255,215,0,.0) 25%);mix-blend-mode:screen;filter:blur(2px);animation:legendRays 2200ms linear forwards}
.legend-fx .burst{position:absolute;width:14vmin;height:14vmin;border-radius:50%;background:radial-gradient(circle, rgba(255,255,255,.95) 0%, rgba(255,215,0,.9) 45%, rgba(255,140,0,.0) 70%);animation:legendBurst 900ms cubic-bezier(.2,.8,.2,1) forwards}
.legend-fx .title{position:relative;font-family:inherit;font-weight:900;letter-spacing:.2em;padding:.6em 1em;border-radius:1em;text-transform:uppercase;background:linear-gradient(90deg,#fff,#ffd700,#ffa500,#fff);-webkit-background-clip:text;background-clip:text;color:transparent;text-shadow:0 2px 12px rgba(255,215,0,.6);animation:legendTitle 1600ms ease-out forwards}
.legend-fx .confetti{position:absolute;width:.8vmin;height:2.2vmin;opacity:0;will-change:transform,opacity;mix-blend-mode:screen}
.legend-body-glow{box-shadow:inset 0 0 120vmax rgba(255,215,0,.05);} 
.card.legendaryPulse .front{box-shadow:0 0 12px rgba(255,215,0,.9), 0 0 28px rgba(255,140,0,.7)}
@keyframes legendHalo{0%{transform:scale(.2);opacity:0}60%{opacity:1}100%{transform:scale(1.35);opacity:.0}}
@keyframes legendRays{0%{transform:rotate(0deg) scale(.7);opacity:.0}40%{opacity:1}100%{transform:rotate(220deg) scale(1.15);opacity:0}}
@keyframes legendBurst{0%{transform:scale(.2);opacity:0}70%{opacity:1}100%{transform:scale(2.6);opacity:0}}
@keyframes legendTitle{0%{transform:translateY(20px);filter:blur(8px);opacity:0}60%{opacity:1;filter:blur(0)}100%{transform:translateY(0)}}
</style>

<style>

/* ===== Stylish balance cards ===== */
.fc-balance-bar {
  display: flex;
  gap: 28px;
  justify-content: center;
  align-items: center;
  margin: 20px 0;
}

.fc-balance {
  display: flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  padding: 14px 22px;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.18);
  box-shadow: 0 6px 18px rgba(0,0,0,.4);
  transition: transform .2s ease, box-shadow .2s ease;
}

.fc-balance:hover {
  transform: translateY(-3px) scale(1.03);
  box-shadow: 0 12px 28px rgba(0,0,0,.55), 0 0 12px rgba(110,231,255,.25);
}

.fc-balance b {
  font-size: 1.6rem;
  font-weight: 700;
  min-width: 70px;
  text-align: right;
  letter-spacing: .5px;
}

.fc-ico {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  flex-shrink: 0;
}

.fc-coin {
  background: radial-gradient(circle at 30% 30%, #fff8, #ffcc00);
  box-shadow: 0 0 14px #ffcc00;
}

.fc-like {
  background: radial-gradient(circle at 30% 30%, #fff8, #ff4d6d);
  box-shadow: 0 0 14px #ff4d6d;
}

#balanceCenter b[contenteditable="true"]{
  outline: none;
  border-bottom: 1px dashed rgba(255,255,255,.18);
  padding: 0 4px;
  cursor: text;
}
#balanceCenter b[contenteditable="true"]:focus{
  border-bottom-color: rgba(110,231,255,.6);
}


/* ===== Sticky horizontal packs menu ===== */
.packs-sticky{
  position: sticky;
  top: calc(var(--fcbar-h) + 6px);
  z-index: 48;
  background: linear-gradient(180deg, rgba(10,16,38,.95), rgba(10,16,38,.82));
  border-bottom: 1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(8px);
}
.packs-sticky .featured-carousel{
  padding-top: .6rem;
  padding-bottom: .7rem;
}
@media(max-width: 980px){
  .packs-sticky{ top: calc(var(--fcbar-h) + 4px); }
}

/* ===== FC25-LIKE DASHBOARD LAYOUT (additive, non-breaking) ===== */
body{ --fcbar-h:56px; --side-w:240px; }
.fc-topbar{
  position:sticky; top:0; z-index:50; height:var(--fcbar-h);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 16px; gap:16px;
  background:linear-gradient(180deg, rgba(10,16,38,.96), rgba(10,16,38,.72));
  border-bottom:1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(10px);
}
.fc-topbar .fc-left{ display:flex; gap:24px; align-items:center; }
.fc-brand{ display:flex; gap:10px; align-items:center; color:#eaf0ff; font-weight:800; letter-spacing:.2px }
.fc-shield{ display:inline-grid; place-items:center; width:28px;height:28px;border-radius:8px;
  background:linear-gradient(180deg,#1f2a4a,#121a36); border:1px solid rgba(255,255,255,.18); font-weight:900 }
.fc-nav a{ color:#c8d2ff; padding:10px 12px; border-radius:10px; cursor:default }
.fc-nav a.is-active{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1) }
.fc-right{ display:flex; gap:16px; align-items:center }
.fc-balance{ display:flex; gap:6px; align-items:center; color:#eaf0ff; background:rgba(255,255,255,.06);
  padding:6px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.10) }
.fc-ico{ width:16px; height:16px; display:inline-block; border-radius:50% }
.fc-coin{ background: radial-gradient(circle at 30% 30%, #fff8, #ffcc00); box-shadow:0 0 8px #ffcc00 }
.fc-like{ background: radial-gradient(circle at 30% 30%, #fff8, #6ee7ff); box-shadow:0 0 8px #6ee7ff }
.fc-prof{ width:28px; height:28px; border-radius:999px; background:linear-gradient(180deg,#29345a,#111833); border:1px solid rgba(255,255,255,.12); display:grid; place-items:center }
.fc-prof .dot{ width:6px; height:6px; border-radius:999px; background:#6ee7ff; box-shadow:0 0 8px #6ee7ff }

/* Sidebar */
.fc-sidebar{
  position:fixed; top:var(--fcbar-h); left:0; bottom:0; width:var(--side-w);
  background:linear-gradient(180deg, rgba(12,18,40,.92), rgba(12,18,40,.76));
  border-right:1px solid rgba(255,255,255,.08);
  padding:14px 10px; z-index:30; backdrop-filter: blur(6px);
}
.fc-sidebar ul{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:4px }
.fc-sidebar li{ color:#c6d0f8; padding:10px 12px; border-radius:10px; cursor:default }
.fc-sidebar li.title{ color:#94a2d8; font-weight:700; text-transform:uppercase; font-size:12px; letter-spacing:.6px; margin-top:8px }
.fc-sidebar li.active{ background: rgba(110,231,255,.08); border:1px solid rgba(110,231,255,.28); color:#eaf3ff }

/* Shift existing layout to make room */
header{ top: var(--fcbar-h); }
.wrap{ max-width: 1200px; margin-left: calc(var(--side-w) + 16px); }
@media(max-width: 980px){
  .fc-sidebar{ display:none }
  .wrap{ margin-left: auto }
}

/* Game picker as strip cards */
.choices{ display:flex; gap:16px; overflow:auto; padding-bottom:8px }
.choice{
  min-width: 320px;
  border-radius:14px; padding:10px; align-items:center;
  background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)) !important;
}
.choice .prev{ width:120px; border-radius:12px }
.choice .meta .name{ font-weight:800; }
.choice .meta .price{ margin-top:4px; color:#aeb7db }
</style>


<style>
.featured-carousel {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  gap: 1rem;
  padding: 1rem;
}
.featured-carousel::-webkit-scrollbar {
  height: 8px;
}
.featured-carousel::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}
.featured-card {
  flex: 0 0 auto;
  width: 160px;
  scroll-snap-align: start;
  text-align: center;
  background: #1e1e1e;
  border-radius: 10px;
  padding: 10px;
  cursor: pointer;
  transition: transform 0.2s;
}
.featured-card:hover {
  transform: scale(1.05);
}
.featured-card img {
  width: 100%;
  border-radius: 8px;
}
.featured-cost {
  margin-top: 5px;
  font-weight: bold;
  color: #fff;
}
</style>
<style>
/* === STORE SECTIONS (clickable navigation enabled) === */
.fc-sidebar li { user-select: none; }
.fc-sidebar li[data-section] { cursor:pointer; pointer-events:auto; }
</style>


<style id="hide-old-picker">
/* Nasconde la visualizzazione precedente (game picker) mantenendo intatto il resto */
#gamePicker, .choices { display: none !important; }
</style>


<!-- Fantaballa FC background -->
<style id="fanta-bg">
  body {
    margin:0;
    background:
      linear-gradient(180deg, rgba(240,245,255,.9), rgba(220,235,255,.95) 40%, rgba(200,225,255,.98)),
      url('sfondo-fanta.png') center bottom / cover no-repeat fixed,
      var(--bg) !important;
    color: var(--text);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    overflow-x: hidden;
  }
</style>

<style>

/* === Visual Refresh (non-breaking) ===================================== */
:root{
  --bg: #0b0f1a;
  --fg: #e6e8ef;
  --muted: #aab1c3;
  --card: rgba(255,255,255,.06);
  --card-border: rgba(255,255,255,.12);
  --brand: #6ee7ff;
  --brand-strong: #22d3ee;
  --accent: #c084fc;
  --gold: #ffcc4d;
  --silver: #d1d5db;
  --bronze: #d39f6a;
  --shadow: 0 10px 30px rgba(0,0,0,.35);
}

html,body{
  background: radial-gradient(1200px 800px at 15% -10%, rgba(110,231,255,.12), transparent 60%),
              radial-gradient(1000px 800px at 120% 10%, rgba(192,132,252,.10), transparent 60%),
              var(--bg);
  color: var(--fg);
  font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  letter-spacing: .2px;
}

.wrap{ max-width: 1200px; margin-inline: auto; }

/* Pill badges & counters */
.pill, .pill-ghost{
  backdrop-filter: blur(8px);
  background: var(--card);
  border: 1px solid var(--card-border);
  border-radius: 999px;
  padding: .45rem .85rem;
  box-shadow: var(--shadow);
  color: var(--fg);
}

/* Featured carousel cards */
.featured-carousel .card, .featured-carousel .pack-card, .stageWrap .card {
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
  border: 1px solid var(--card-border);
  border-radius: 18px;
  box-shadow: var(--shadow);
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.featured-carousel .card:hover, .featured-carousel .pack-card:hover, .stageWrap .card:hover{
  transform: translateY(-4px) scale(1.01);
  border-color: rgba(255,255,255,.24);
}

/* Buttons */
button, .btn {
  border-radius: 14px;
  border: 0;
  padding: .9rem 1.1rem;
  font-weight: 700;
  letter-spacing: .3px;
  transition: transform .14s ease, filter .14s ease, box-shadow .14s ease;
  box-shadow: var(--shadow);
}
button:active, .btn:active { transform: translateY(1px) scale(.99); }

#openBtn, #myCardsBtn, #bonusBtn, #resetPacksBtn {
  background: linear-gradient(135deg, var(--brand), var(--accent));
  color: #0b0f1a;
}
#openBtn:hover, #myCardsBtn:hover, #bonusBtn:hover, #resetPacksBtn:hover {
  filter: brightness(1.05);
}

/* Balance bar */
.fc-balance-bar {
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border: 1px solid var(--card-border);
  border-radius: 16px;
  box-shadow: var(--shadow);
}

/* Stage (where packs/cards appear) */
.stageWrap, .stage {
  background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.00));
  border-radius: 18px;
}

/* Tier accents */
[data-tier="Gold"], .tag-gold { box-shadow: 0 0 0 1px rgba(255,204,77,.4) inset, 0 6px 20px rgba(255,204,77,.20); }
[data-tier="Silver"], .tag-silver { box-shadow: 0 0 0 1px rgba(209,213,219,.45) inset, 0 6px 20px rgba(209,213,219,.20); }
[data-tier="Bronze"], .tag-bronze { box-shadow: 0 0 0 1px rgba(211,159,106,.45) inset, 0 6px 20px rgba(211,159,106,.18); }

/* Subtle card shine */
.card-shine {
  position: relative;
  overflow: hidden;
}
.card-shine::after{
  content:"";
  position:absolute; inset:-40%;
  background: conic-gradient(from 180deg at 50% 50%, rgba(255,255,255,.0), rgba(255,255,255,.14), rgba(255,255,255,.0));
  transform: rotate(0deg);
  animation: shine 6s linear infinite;
  pointer-events:none;
}
@keyframes shine {
  to { transform: rotate(360deg); }
}

/* Flash screen lines during open */
#flashScreen { backdrop-filter: blur(6px); }
#flashLine {
  height: 3px;
  background: linear-gradient(90deg, transparent, var(--brand-strong), transparent);
  filter: drop-shadow(0 0 8px var(--brand-strong));
}

/* Table/list tweaks */
table, .table-like {
  border-collapse: separate;
  border-spacing: 0;
}
table td, table th {
  border-bottom: 1px solid rgba(255,255,255,.08);
  padding: .6rem .7rem;
}

/* Tooltip flavor (if any) */
[role="tooltip"], .tooltip {
  background: #111827;
  border: 1px solid rgba(255,255,255,.08);
  color: #e5e7eb;
  border-radius: 10px;
  padding: .35rem .55rem;
  box-shadow: 0 10px 30px rgba(0,0,0,.45);
}
/* ===================================================================== */

</style>
</head>
<body>

<!-- FC25-like Dashboard UI -->
<div class="fc-topbar">
  <div class="fc-left">
    <div class="fc-brand"><span class="fc-shield">UT</span><strong>EA SPORTS FC 25</strong></div>
    <nav class="fc-nav">
      <a class="is-active">Home</a>
      <a>Store</a>
      <a>Browse</a>
    </nav>
  </div>
  <div class="fc-right">
    <div class="fc-prof"><span class="dot"></span></div>
  </div>
  </div>
</div>

<aside class="fc-sidebar">
  <ul>
    <li class="title">Store</li>
    <li class="active" data-section="featured">Featured</li>
    <li data-section="new">Ultimi arrivi</li>
    <li data-section="base">Pacchetti base</li>
    <li data-section="all">Tutti i pacchi</li>
  </ul>
</aside>

<script>
// === Sezioni Store (solo etichette, nessuna navigazione attiva) ===
window.STORE_SECTIONS = {
  featured: ['Wonderkid','Patatine'],
  new: ['Wonderkid'], // Ultimi arrivi
  base: ['Gold','Silver','Bronze'], // Pacchetti base
  all: (typeof VALID_GAMES !== 'undefined' ? VALID_GAMES.slice() : ['Wonderkid','Patatine','Gold','Silver','Bronze','Strumenti'])
};
</script>

<!-- /FC25-like Dashboard UI -->

<div class="flash-line" id="flashLine" aria-hidden="true"></div>
<div class="flash-screen" id="flashScreen" aria-hidden="true"></div>

<header>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>FUTTUFC ‚Äì Pack Unico</h1>
        <div class="subtitle">
          Pacchetti esclusivi <b>Fantaballa FC</b> .
        </div>

        <span class="pill" id="pricePill">üí∞ Costo: ‚Äî</span>
        <span class="pill" id="pointsBadge">Punti: ‚Äî</span>
        <button id="openBtn" class="btn">üéÅ Apri pacchetto</button>
        <a href="https://pavoniingrifati.github.io/vetrina-carte/my-cards" class="btn" id="myCardsBtn">üóÇÔ∏è Le mie carte</a><button id="bonusBtn" class="btn">üéÅ Ottieni 1 punto</button>
        <a href="https://pavoniingrifati.github.io/vetrina-carte/" class="btn">üè† Torna alla Home</a>
      </div>
    </div>

    <div class="toolbar">
      <span class="pill" id="fairnessNote">üì¶ Pacchetti disponibili:</span>
      <button id="resetPacksBtn" class="btn">‚ôªÔ∏è Reset pacchetti</button>
    </div>

<div class="fc-balance-bar" id="balanceCenter" aria-label="Saldo">
  <div class="fc-balance"><span class="fc-ico fc-coin"></span><b id="fc-coins" contenteditable="true">5,360</b></div>
  <div class="fc-balance"><span class="fc-ico fc-like"></span><b id="fc-likes" contenteditable="true">550</b></div>
</div>
<!-- Game picker -->
    <div class="choices" id="gamePicker" aria-label="Seleziona game"></div>

    <div class="log" id="log" role="status" aria-live="polite"></div>
  </div>
</header>

<!-- Sticky packs menu -->
<div class="packs-sticky">
  <div class="wrap">
    <div id="packsStrip" class="featured-carousel" aria-label="Pacchetti"></div>
  </div>
</div>


<main class="wrap">
  <section class="packArea" id="packArea">
    <div class="pack" id="pack" title="Apri pacchetto"></div>
  </section>

  <section class="stageWrap" id="stageWrap">
    <div id="stage" class="stage" aria-live="polite"></div>
  </section>
</main>

<footer>
  <div class="foot">
    <span class="pillFoot">‚ÑπÔ∏è Resta tutto invariato: login Google, salvataggio inventario, condivisione.</span>
  </div>
</footer>

<!-- Template carta -->
<template id="tplCard">
  <article class="cCard drop" data-state="back">
    <div class="rays"></div>
    <div class="scene">
      <div class="face back">
        <img src="Deck%20back%20wonderkid.png" alt="Retro carta" loading="eager" decoding="async" />
      </div>
      <div class="face front">
        <span class="badge"></span>
        <img alt="" loading="lazy" decoding="async">
      </div>
    </div>
    <div class="veil"></div>
    <div class="spark"></div>
  </article>
</template><!-- Firebase (v8) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDv23gasgBuAtPeDJeztyJ5P2S7NWq1svo",
  authDomain: "fantaball-9e19c.firebaseapp.com",
  projectId: "fantaball-9e19c",
  storageBucket: "fantaball-9e19c.appspot.com",
  messagingSenderId: "683304379837",
  appId: "1:683304379837:web:d2bbe7a814e2e40e075ed4",
  measurementId: "G-C8Q8K5B52C"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
</script>

<script type="module">
// Firestore
const db = firebase.firestore();

/** =========================
 *  CONFIG PER GAME
 *  ========================= */
const VALID_GAMES = ['Wonderkid','Patatine','Gotham Tots','Legend','Oggetti','Gold','Silver','Bronze', 'Cosmetic', 'Strumenti', 'Frutto del Diavolo'];
const PACK_BACK_BY_GAME = {
  'Wonderkid': 'Deck%20back%20wonderkid.png',
  'Patatine': 'patatrine.png',
  'Gotham Tots': 'Deck%20back%20Tots.png',
  'Legend': 'Back%20legend.png',
  'Oggetti': 'Deck%20back%20tactcs.png',
  'Gold': 'Deck%20back%20ORO.png',
  'Silver': 'Deck%20back%20argento.png',
  'Bronze': 'Deck%20back%20bronzo.png',
  'Strumenti': 'Deck%20back%20strumenti.png',
  'Cosmetic': 'Deck%20back%20cosmetic.png',
  'Frutto del Diavolo': 'Back%20Deck%20ONE.png'
};


const PACK_COST_PER_GAME = {
  'Wonderkid': 1800,
  'Patatine': 0,
  'Gotham Tots': 0,
  'Legend': 0,
  'Oggetti': 0,
  'Gold': 0,
  'Silver': 0,
  'Bronze': 0,
  'Strumenti': 0,
  'Cosmetic': 0,
  'Frutto del Diavolo': 0
};

const PACK_SIZE_PER_GAME = {
  'Wonderkid': 3,
  'Patatine': 1,
  'Gotham Tots': 3,
  'Legend': 3,
  'Oggetti': 3,
  'Gold': 9,
  'Silver': 9,
  'Bronze': 9,
  'Strumenti': 3,
  'Cosmetic': 1,
  'Frutto del Diavolo': 3
};

const CONFIG = { CARDS_JSON: 'cards.json', FETCH_TIMEOUT_MS: 8000 };

/** =========================
 *  AUTH
 *  ========================= */
async function ensureGoogleUser() {
  const auth = firebase.auth();
  const u = auth.currentUser;
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });
  try {
    if (!u) {
      const { user } = await auth.signInWithPopup(provider);
      await user.getIdToken(true);
      return user;
    }
    if (u.isAnonymous) {
      const { user } = await u.linkWithPopup(provider);
      await user.getIdToken(true);
      return user;
    }
    await u.getIdToken(true);
    return u;
  } catch (e) {
    if (e.code === 'auth/popup-blocked' || e.code === 'auth/operation-not-supported-in-this-environment') {
      if (!u) { await firebase.auth().signInWithRedirect(provider); throw new Error('redirecting'); }
      if (u.isAnonymous) { await u.linkWithRedirect(provider); throw new Error('redirecting'); }
    }
    throw e;
  }
}

/** =========================
 *  WALLET
 *  ========================= */
async function ensureWallet10() {
  const uid = firebase.auth().currentUser.uid;
  const ref = db.collection('users').doc(uid);
  await db.runTransaction(async (tx) => {
    const snap = await tx.get(ref);
    if (!snap.exists) {
      const now = firebase.firestore.FieldValue.serverTimestamp();
      tx.set(ref, { points: 10, createdAt: now, updatedAt: now });
    }
  });
}
async function debitPackCostOrThrow(cost) {
  if (cost <= 0) return (await getCurrentPoints()); // gratis ‚Üí non addebitare
  const uid = firebase.auth().currentUser && firebase.auth().currentUser.uid;
  if (!uid) throw new Error('login-required');
  const ref = db.collection('users').doc(uid);
  return await db.runTransaction(async (tx) => {
    const snap = await tx.get(ref);
    if (!snap.exists) throw new Error('wallet-missing');
    const pts = Number(snap.data().points || 0);
    if (pts < cost) { const e = new Error('no-points'); e.code = 'no-points'; throw e; }
    const now = firebase.firestore.FieldValue.serverTimestamp();
    tx.update(ref, { points: pts - cost, updatedAt: now });
    return pts - cost;
  });
}
async function getCurrentPoints(){
  const u = firebase.auth().currentUser;
  if (!u) return 0;
  const snap = await db.collection('users').doc(u.uid).get();
  return snap.exists ? Number(snap.data().points || 0) : 0;
}

/** =========================
 *  PUNTI UI
 *  ========================= */
const pointsBadge = document.getElementById('pointsBadge');
const openBtn = document.getElementById('openBtn');
const bonusBtn = document.getElementById('bonusBtn');
let unsubPoints = null;
let lastDailyAtMs = 0;

function formatHhMm(ms){
  const s = Math.max(0, Math.floor(ms / 1000));
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}
function updateBonusUI(){
  if (!bonusBtn) return;
  const DAY_MS = 24*60*60*1000;
  const now = Date.now();
  const elapsed = lastDailyAtMs ? (now - lastDailyAtMs) : Infinity;
  const canClaim = elapsed >= DAY_MS;
  bonusBtn.textContent = canClaim ? 'üéÅ Apri' : `‚è±Ô∏è Attendi ${formatHhMm(DAY_MS - elapsed)}`;
  bonusBtn.disabled = false;
  bonusBtn.style.display = '';
}
setInterval(updateBonusUI, 60*1000);

async function initPointsUI() {
  try {
    const user = firebase.auth().currentUser;
    if (!user || user.isAnonymous) {
      pointsBadge.innerHTML = 'üîê Accedi con Google';
      pointsBadge.style.cursor = 'pointer';
      pointsBadge.onclick = async () => {
        try {
          const u = await ensureGoogleUser();
          if (!u) return;
          await ensureWallet10();
          setTimeout(initPointsUI, 0);
        } catch (e) {
          if (e.message !== 'redirecting') console.error(e);
        }
      };
      openBtn.disabled = true;
      updateBonusUI();
      return;
    }

    await ensureWallet10();
    const ref = db.collection('users').doc(user.uid);
    if (unsubPoints) unsubPoints();
    unsubPoints = ref.onSnapshot((snap) => {
      const data = snap.exists ? snap.data() : {};
      const pts = Number(data.points || 0);
      const last = data.lastDailyAt;
      const lastMs = last && typeof last.toMillis === 'function' ? last.toMillis() : (typeof last === 'number' ? last : 0);
      pointsBadge.textContent = `Punti: ${pts}`;
      lastDailyAtMs = lastMs || 0;
      updateBonusUI();
      updateOpenBtnEnabled();
    });
  } catch (e) {
    if (e.message === 'redirecting') return;
    console.error('[initPointsUI]', e);
    if (pointsBadge) pointsBadge.textContent = 'Punti: ‚Äî';
    if (openBtn) openBtn.disabled = true;
  }
}

if (bonusBtn) {
  bonusBtn.addEventListener('click', async () => {
    const log = document.getElementById('log');
    try {
      let u = firebase.auth().currentUser;
      if (!u || u.isAnonymous) u = await ensureGoogleUser();
      await ensureWallet10();
      const ref = db.collection('users').doc(u.uid);
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) throw new Error('wallet-missing');
        const pts = Number(snap.data().points || 0);
        const now = firebase.firestore.FieldValue.serverTimestamp();
        tx.update(ref, { points: pts + 1, lastDailyAt: now, updatedAt: now });
      });
      lastDailyAtMs = Date.now();
      updateBonusUI();
      log.textContent = 'üéâ Bonus ottenuto! (max 1 ogni 24h)';
      bonusBtn.disabled = true;
    } catch (e) {
      if ((e && e.code) === 'permission-denied') {
        document.getElementById('log').textContent = '‚è±Ô∏è Bonus gi√† usato nelle ultime 24 ore.';
      } else {
        document.getElementById('log').textContent = '‚ö†Ô∏è Impossibile ottenere il bonus ora.';
        console.error(e);
      }
    } finally {
      setTimeout(()=>{ bonusBtn.disabled = false; }, 800);
    }
  });
}

/** =========================
 *  UTILS + AUDIO
 *  ========================= */
const $ = (s,el=document)=>el.querySelector(s);
const delay = ms => new Promise(r=>setTimeout(r,ms));
const rarityRank={'Comune':0,'Non Comune':1,'Rara':2,'Epica':3,'Ultra Rara':4,'Season':5,'Leggendaria':6};
const norm = (v)=>String(v||'').trim().toLowerCase();

let audioCtx=null;
function ensureAudio(){ try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)() }catch{} }
function tone(f,d=.15,g=.08,t='sine'){ if(!audioCtx) return; const o=audioCtx.createOscillator(),A=audioCtx.createGain(); o.type=t; o.frequency.value=f; A.gain.value=g; o.connect(A).connect(audioCtx.destination); o.start(); A.gain.setTargetAtTime(0,audioCtx.currentTime+d,.3); o.stop(audioCtx.currentTime+d+.08) }
function noiseBoom(d=.5,g=.15){ if(!audioCtx) return; const N=audioCtx.sampleRate*d, b=audioCtx.createBuffer(1,N,audioCtx.sampleRate), x=b.getChannelData(0); for(let i=0;i<N;i++) x[i]=(Math.random()*2-1)*Math.pow(1-i/N,2); const s=audioCtx.createBufferSource(); s.buffer=b; const A=audioCtx.createGain(); A.gain.value=g; const F=audioCtx.createBiquadFilter(); F.type='lowpass'; F.frequency.value=400; s.connect(F).connect(A).connect(audioCtx.destination); s.start(); A.gain.setTargetAtTime(0,audioCtx.currentTime+d*.7,2) }
function playByRarity(r){ if(r==='Comune'||r==='Non Comune'){ tone(520,.07,.06,'triangle'); tone(660,.07,.05,'triangle') } else if(r==='Rara'){ tone(660,.12,.08,'sine'); tone(880,.16,.06,'sine') } else if(r==='Epica'){ tone(660,.18,.09,'sine'); tone(990,.22,.08,'sine'); tone(1320,.24,.06,'sine') } else if(r==='Ultra Rara'||r==='Season'){ noiseBoom(.7,.18); tone(880,.18,1,'square'); tone(1320,.22,.08,'square') } else if (r==='Leggendaria'){ noiseBoom(.9,.22); tone(1320,.22,.9,'square'); tone(1760,.26,.09,'square') } }

/** =========================
 *  INVENTARIO
 *  ========================= */
const safeDocId = (id) => String(id || Math.random().toString(36).slice(2)).replace(/[\/#?\[\]]/g, '_').slice(0, 120);
async function saveInventario(cards) {
  const u = firebase.auth().currentUser;
  if (!u || u.isAnonymous) throw new Error('login-required');
  const batch = db.batch();
  const now = firebase.firestore.FieldValue.serverTimestamp();
  for (const c of cards) {
    const ref = db.collection('users').doc(u.uid).collection('inventory').doc(safeDocId(c.id));
    batch.set(ref, {
      name: c.name, rarity: c.rarity, series: c.series || '', img: c.img || '',
      count: firebase.firestore.FieldValue.increment(1), updatedAt: now
    }, { merge: true });
  }
  await batch.commit();
}

/** =========================
 *  DATI CARTE + PACCHETTI (FINITI)
 *  ========================= */
const GAME_STATE = {
  selected: 'Wonderkid',
  pools:    { 'Wonderkid': [], 'Patatine': [], 'Gotham Tots': [], 'Legend': [], 'Oggetti': [], 'Gold': [], 'Silver': [], 'Bronze': [], 'Strumenti': [], 'Cosmetic': [], 'Frutto del Diavolo': []},
  packs:    { 'Wonderkid': [], 'Patatine': [], 'Gotham Tots': [], 'Legend': [], 'Oggetti': [], 'Gold': [], 'Silver': [], 'Bronze': [], 'Strumenti': [], 'Cosmetic': [], 'Frutto del Diavolo': []},
  cursor:   { 'Wonderkid': 0,   'Patatine': 0,   'Gotham Tots': 0,   'Legend': 0,   'Oggetti': 0,   'Gold': 0, 'Silver': 0, 'Bronze': 0, 'Strumenti': 0, 'Cosmetic': 0, 'Frutto del Diavolo': 0}
};


function shuffleInPlace(a){
  for (let i=a.length-1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}
function buildFinitePacks(cards, size){
  const arr = shuffleInPlace(cards.slice());
  const packs = [];
  for (let i=0; i<arr.length; i+=size){ packs.push(arr.slice(i,i+size)); }
  if (size>1 && packs.length>1 && packs[packs.length-1].length===1){
    const prev = packs[packs.length-2];
    const last = packs[packs.length-1];
    if (prev.length>2){ last.unshift(prev.pop()); } // 3+1 => 2+2
  }
  return packs.filter(p=>p.length>0);
}

async function loadCards(){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),CONFIG.FETCH_TIMEOUT_MS);
  try{
    const res=await fetch(CONFIG.CARDS_JSON,{cache:'no-store',signal:ctrl.signal});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json=await res.json();
    if(!Array.isArray(json)) throw new Error('Formato non valido (atteso array)');

    // ====== Normalizzazione e pulizia ======
    const cleaned=[]; const ids=new Set();
    for(const c of json){
      if(!c||typeof c!=='object') continue;
      const id=c.id ?? `${(c.name||'card')}-${Math.random().toString(36).slice(2,8)}`;
      const name=String(c.name||''); const rarity=String(c.rarity||''); const img=String(c.img||'');
      const series=String(c.series||''); const game=String(c.game||''); const text=String(c.text||''); const tags=Array.isArray(c.tags)? c.tags.map(String):[];
      if(!name||!rarity||!img) continue;
      if(ids.has(id)) continue; ids.add(id);
      cleaned.push({id,name,rarity,img,series,game,text,tags});
    }

    // ====== Helper ======
    const isGotham = (x)=> norm(x)==='gotham city';
const isFantaballa = (x)=> norm(x)==='fantaballa fc';

    // ====== Pools per game ======

    // Wonderkid (come prima)
    GAME_STATE.pools['Wonderkid'] = cleaned.filter(c => isGotham(c.game) && norm(c.series)==='wonderkid');

    // Patatine ‚Äî QUALUNQUE carta di Fantaballa FC, esclusa la serie "Leggendaria"
    GAME_STATE.pools['Patatine'] = cleaned.filter(c =>
      isFantaballa(c.game) &&
      norm(c.series) !== 'leggendaria'
    );
// Gotham Tots (come prima)
    GAME_STATE.pools['Gotham Tots'] = cleaned.filter(c => isFantaballa(c.game) && norm(c.series)==='tots');

    // Legend (come prima)
    const legendPoolAll = cleaned.filter(c =>
      isGotham(c.game) &&
      ['rara','epica','ultra rara','leggendaria'].includes(norm(c.rarity))
    );
    const legendNonLegend = legendPoolAll.filter(c => norm(c.rarity) !== 'leggendaria');
    const legendOnlyLegend = legendPoolAll.filter(c => norm(c.rarity) === 'leggendaria');
    GAME_STATE.pools['Legend'] = legendPoolAll;

    // Oggetti ‚Äî NEW: prende qualsiasi card con series = "Oggetto" (game: qualunque)
    GAME_STATE.pools['Oggetti'] = cleaned.filter(c => norm(c.series)==='oggetto');

    
    

    // Frutto del Diavolo ‚Äî FINITO: solo carte con text="Frutto del diavolo"
        const fruttoPool = cleaned.filter(c => norm(c.text) === 'frutto del diavolo');
        GAME_STATE.pools['Frutto del Diavolo'] = fruttoPool;

        // Pacchetti STRICT: gruppi da 3 esatti, nessun doppione interno, e combinazioni tutte diverse tra loro
        (function(){
          const SZ = PACK_SIZE_PER_GAME['Frutto del Diavolo'] || 3;
          const arr = shuffleInPlace(fruttoPool.slice());
          const tmp = [];
          for (let i = 0; i + SZ <= arr.length; i += SZ) {
            const slice = arr.slice(i, i + SZ);
            const seen = new Set();
            const unique = slice.filter(x => x && x.id && !seen.has(x.id) && (seen.add(x.id), true));
            if (unique.length === SZ) tmp.push(unique);
          }
          // tutte combinazioni uniche
          const sig = (p) => [...new Set(p.map(x => x.id))].sort().join('+');
          const used = new Set();
          const uniquePacks = [];
          for (const p of tmp) { const s = sig(p); if (!used.has(s)) { used.add(s); uniquePacks.push(p); } }
          GAME_STATE.packs['Frutto del Diavolo'] = uniquePacks;
        })();

    // Cosmetic ‚Äî INFINITO: prende qualsiasi card con series = \"Cosmetic\" (game: qualunque)
    GAME_STATE.pools['Cosmetic'] = cleaned.filter(c => norm(c.series)==='cosmetic');
// Strumenti ‚Äî FINITO: prende solo series="Strumento" e game="Gotham City"; 2 copie per carta, pacchetti da 3 (ultimo 2+2 se serve)
    const baseStrumenti = cleaned.filter(c => isGotham(c.game) && norm(c.series)==='strumento');
    const strumentiDoubled = baseStrumenti.flatMap(c => [c, c]); // doppione
    GAME_STATE.pools['Strumenti'] = strumentiDoubled.slice();

    // pacchetti finiti e tutti diversi tra loro (no doppie della stessa carta dentro il pacco)
    GAME_STATE.packs['Strumenti'] = buildFinitePacks(GAME_STATE.pools['Strumenti'], PACK_SIZE_PER_GAME['Strumenti']).map(p => {
      const seen = new Set();
      return p.filter(x => !seen.has(x.id) && seen.add(x.id));
    });
    (function ensureUniquePackCombos(){
      const sig = (p) => [...new Set(p.map(x=>x.id))].sort().join('+');
      const used = new Set();
      for (let i=0; i<GAME_STATE.packs['Strumenti'].length; i++){
        let pack = GAME_STATE.packs['Strumenti'][i];
        let s = sig(pack);
        if (!used.has(s)){ used.add(s); continue; }
        const next = GAME_STATE.packs['Strumenti'][i+1];
        if (next && next.length && pack.length && next.length){
          const a = pack[pack.length-1], b = next[next.length-1];
          if (a.id !== b.id){
            pack[pack.length-1] = b;
            next[next.length-1] = a;
            s = sig(pack);
          }
        }
        used.add(s);
      }
    })();
    


    

// === AUTO B/S/G PACKS (generated from JSON) ===
const oggettiPoolAll = cleaned.filter(c => norm(c.series)==='oggetto');

// === Injected: Infinite Bronze pack generation ===
function generateBSGOnTheFly(seriesName) {
  try {
    const oggPool = GAME_STATE?.pools?.[seriesName + '_oggs'] || [];
    const mainPool = GAME_STATE?.pools?.[seriesName + '_main'] || [];
    // Reuse existing pickDistinct (assumed present) to get 3 + 6
    const oggs = pickDistinct(oggPool, 3);
    const mains = pickDistinct(mainPool, 6);
    const combined = [...oggs, ...mains];
    // Fallback: Se non raggiunge 9, rimpiazza con carte casuali, ma non aggiungere oggetti oltre il limite di 3
if (combined.length < 9) {
  const need = 9 - combined.length;
  const oggCount = combined.filter(card => oggs.includes(card)).length; // Conta gli oggetti gi√† nel pacchetto
  const maxOggsToAdd = 3 - oggCount; // Numero di oggetti che possiamo ancora aggiungere

  // Se ci sono posti liberi per gli oggetti, seleziona fino a maxOggsToAdd oggetti
  const oggsToAdd = pickDistinct(oggPool, Math.min(maxOggsToAdd, need));

  // Se ci sono ancora posti liberi, aggiungi carte principali (ma non pi√π di quelle necessarie)
  const mainsToAdd = pickDistinct(mainPool, need - oggsToAdd.length);

  // Aggiungi oggetti e carte principali al pacchetto
  combined.push(...oggsToAdd, ...mainsToAdd);
}
    return combined;
  } catch (e) {
    console.error('generateBronzeOnTheFly error', e);
    return [];
  }
}
// === End Injected ===
function pickDistinct(source, n) {
  const arr = source.slice();
  shuffleInPlace(arr);
  const seen = new Set();
  const out = [];
  for (const c of arr) {
    if (!c || !c.id) continue;
    if (!seen.has(c.id)) { out.push(c); seen.add(c.id); if (out.length>=n) break; }
  }
  while (out.length < n && arr.length) {
    const c = arr[Math.floor(Math.random()*arr.length)];
    if (c && c.id && !seen.has(c.id)) { out.push(c); seen.add(c.id); }
  }
  return out.slice(0, n);
}
function buildBSGAutoPacks(seriesName, count=80) {
  const seriesPool = cleaned.filter(c => isFantaballa(c.game) && norm(c.series)===norm(seriesName));
  const packs = [];
  for (let i=0; i<count; i++){
    const oggs = pickDistinct(oggettiPoolAll, 3);
    const mains = pickDistinct(seriesPool, 6);
    const pack = [...oggs, ...mains]; // Oggetti first
    packs.push(pack);
  }
  const poolUnion = Array.from(new Set([...oggettiPoolAll, ...seriesPool]));
  return { packs, pool: poolUnion , oggPool: oggettiPoolAll, mainPool: seriesPool };
}
const autoGold   = buildBSGAutoPacks('Gold', 80);
GAME_STATE.pools['Bronze_oggs'] = cleaned.filter(c => norm(c.series) === 'oggetto');
GAME_STATE.pools['Silver_oggs'] = cleaned.filter(c => norm(c.series) === 'oggetto');
GAME_STATE.pools['Gold_oggs']   = cleaned.filter(c => norm(c.series) === 'oggetto');
GAME_STATE.pools['Bronze_main'] = cleaned.filter(c => isFantaballa(c.game) && norm(c.series) === 'bronze');
GAME_STATE.pools['Silver_main'] = cleaned.filter(c => isFantaballa(c.game) && norm(c.series) === 'silver');
GAME_STATE.pools['Gold_main']   = cleaned.filter(c => isFantaballa(c.game) && norm(c.series) === 'gold');
GAME_STATE.pools['Gold'] = cleaned.filter(c => isFantaballa(c.game) && norm(c.series)==='gold');
const autoSilver = buildBSGAutoPacks('Silver', 80);
const autoBronze = buildBSGAutoPacks('Bronze', 80);
GAME_STATE.packs['Gold']   = autoGold.packs;
GAME_STATE.packs['Silver'] = autoSilver.packs;
GAME_STATE.packs['Bronze'] = autoBronze.packs;
GAME_STATE.pools['Gold']   = autoGold.pool;
GAME_STATE.pools['Silver'] = autoSilver.pool;
GAME_STATE.pools['Bronze'] = autoBronze.pool;
// === END AUTO B/S/G PACKS ===


/* Validazione + mapping ID -> carte */
/* Validazione + mapping ID -> carte ‚Äî FIX Gold */
const packsGoldCards = autoGold.packs.flat();
/* Pool: somma delle carte usate (giusto per i contatori UI) ‚Äî usiamo i pacchetti auto-generati */
// ====== Costruzione pacchetti finiti ======
    GAME_STATE.packs['Wonderkid']   = buildFinitePacks(GAME_STATE.pools['Wonderkid'],   PACK_SIZE_PER_GAME['Wonderkid']);
    GAME_STATE.packs['Patatine']    = buildFinitePacks(GAME_STATE.pools['Patatine'],    PACK_SIZE_PER_GAME['Patatine']);   // size=1
    GAME_STATE.packs['Gotham Tots'] = buildFinitePacks(GAME_STATE.pools['Gotham Tots'], PACK_SIZE_PER_GAME['Gotham Tots']);
    /* packs Gold set by auto */
    
    
    // ===== Legend ‚Äî Fantaballa-only (rarit√† >= Rara) with keyword-weighted injection =====
    // Pool: solo game = Fantaballa FC e rarit√† in ['Rara','Epica','Ultra Rara','Leggendaria']
    const fantaballaRarPlus = cleaned.filter(c => isFantaballa(c.game) && ['rara','epica','ultra rara','leggendaria'].includes(norm(c.rarity)));

    function matchesWord(c, re){
      const inName = re.test(String(c.name||''));
      const inTags = Array.isArray(c.tags) && c.tags.some(t => re.test(String(t||'')));
      return inName || inTags;
    }
    const reSenatore = /senatore/i;
    const reLegend = /\blegend\b/i;
    const reHoF = /hall\s*of\s*fame/i;

    const poolSenatore = fantaballaRarPlus.filter(c => matchesWord(c, reSenatore));
    const poolLegend   = fantaballaRarPlus.filter(c => matchesWord(c, reLegend));
    const poolHoF      = fantaballaRarPlus.filter(c => matchesWord(c, reHoF));

    // Base pool = Fantaballa rar+ senza le parole chiave
    const poolBase = fantaballaRarPlus.filter(c => !matchesWord(c, reSenatore) && !matchesWord(c, reLegend) && !matchesWord(c, reHoF));

    function drawFromBagNonDup(bag, pack){
      if (!bag || !bag.length) return null;
      for (let tries=0; tries<bag.length; tries++){
        const i = Math.floor(Math.random()*bag.length);
        const c = bag[i];
        if (!pack.some(x=>x.id===c.id)){
          bag.splice(i,1);
          bag.push(c);
          return c;
        }
      }
      return null;
    }

    const baseLegendPacks = buildFinitePacks(poolBase, PACK_SIZE_PER_GAME['Legend']).map(p => p.slice(0, PACK_SIZE_PER_GAME['Legend']));
    const senatoreBag = poolSenatore.slice();
    const legendNameBag = poolLegend.slice();
    const hofBag = poolHoF.slice();
    const P_SENATORE = 1/5, P_LEGEND = 1/10, P_HOF = 1/15;

    for (const p of baseLegendPacks){
      let injected = false;
      if (!injected && Math.random() < P_SENATORE && senatoreBag.length){
        const card = drawFromBagNonDup(senatoreBag, p);
        if (card){ p[Math.floor(Math.random()*p.length)] = card; injected = true; }
      }
      if (!injected && Math.random() < P_LEGEND && legendNameBag.length){
        const card = drawFromBagNonDup(legendNameBag, p);
        if (card){ p[Math.floor(Math.random()*p.length)] = card; injected = true; }
      }
      if (!injected && Math.random() < P_HOF && hofBag.length){
        const card = drawFromBagNonDup(hofBag, p);
        if (card){ p[Math.floor(Math.random()*p.length)] = card; injected = true; }
      }
    }

    // === Ensure all Legend packs are unique across the whole set ===
    function packSignature(p){
      return [...new Set(p.map(x=>x && x.id))].filter(Boolean).sort().join('+');
    }
    const usedLegendSigs = new Set();
    const uniqueLegendPacks = [];
    for (const p of baseLegendPacks){
      const sig = packSignature(p);
      if (!usedLegendSigs.has(sig)){
        usedLegendSigs.add(sig);
        uniqueLegendPacks.push(p);
      }
    }
    GAME_STATE.packs['Legend'] = uniqueLegendPacks;


    // Oggetti ‚Äî INFINITO: niente buildFinitePacks, lasciamo packs vuoto
    GAME_STATE.packs['Oggetti'] = [];

    
    // Cosmetic ‚Äî INFINITO: niente buildFinitePacks, lasciamo packs vuoto
    GAME_STATE.packs['Cosmetic'] = [];
// ====== Ripristino cursori ======
    try{
      const saved = JSON.parse(localStorage.getItem('futtu_cursors')||'{}');
      if (saved && typeof saved==='object'){
        for (const g of VALID_GAMES) {
          if (typeof saved[g] !== 'undefined') GAME_STATE.cursor[g] = Number(saved[g]||0);
        }
      }
    }catch{}

    // ====== Fingerprint dei pacchetti GOLD (reset automatico se cambi PACKS_GOLD) ======
try {
  // Usa la definizione che hai messo per "Soluzione 1"
  // (PACKS_GOLD √® l'array di array di ID che definisce i tuoi pacchetti manuali)
  const GOLD_FP_KEY = 'futtu_gold_fp';
  const newFp = JSON.stringify(PACKS_GOLD); // firma stabile del contenuto/ordine dei pacchi
  const oldFp = localStorage.getItem(GOLD_FP_KEY);

  if (oldFp !== newFp) {
    // contenuto cambiato -> ricomincia da capo i pacchi Gold
    GAME_STATE.cursor['Gold'] = 0;

    // aggiorna subito il salvataggio cursori
    const saved = JSON.parse(localStorage.getItem('futtu_cursors')||'{}');
    saved['Gold'] = 0;
    localStorage.setItem('futtu_cursors', JSON.stringify(saved));

    // salva la nuova firma
    localStorage.setItem(GOLD_FP_KEY, newFp);
  }
} catch (e) {
  console.warn('Fingerprint Gold non applicato', e);
}

    // ====== UI info ======
    renderGamePicker();
    applyPackVisual();
    updateOpenBtnEnabled();
 document.getElementById('log').textContent =
  `Caricate: Wonderkid ${GAME_STATE.pools['Wonderkid'].length}, Patatine ${GAME_STATE.pools['Patatine'].length}, `+
  `TOTS ${GAME_STATE.pools['Gotham Tots'].length}, Legend ${GAME_STATE.pools['Legend']?.length||0}, `+
  `Oggetti ${GAME_STATE.pools['Oggetti'].length}, Gold ${GAME_STATE.pools['Gold'].length}, Strumenti ${GAME_STATE.pools['Strumenti']?.length||0}.`;


  }catch(err){
    console.error('Errore cards.json:', err?.message||err);
    document.getElementById('log').textContent = '‚ö†Ô∏è Errore nel caricamento delle carte.';
  }finally{ clearTimeout(t) }
}

/** =========================
 *  UI
 *  ========================= */
const pricePill = document.getElementById('pricePill');
const resetPacksBtn = document.getElementById('resetPacksBtn');
const gamePicker = document.getElementById('gamePicker');
const packEl = document.getElementById('pack');



/** =========================
 *  STRISCIA ORIZZONTALE: tutti i pacchetti in fila con scrollbar
 *  ========================= */
function renderPacksStrip(){
  try {
    const strip = document.getElementById('packsStrip');
    if (!strip) return;
    strip.innerHTML = '';
    const frag = document.createDocumentFragment();
    for (const game of VALID_GAMES){
      const imgSrc = PACK_BACK_BY_GAME[game] || 'patatrine.png';
      const cost = Number(PACK_COST_PER_GAME[game] || 0);
      const totalPacks = (GAME_STATE.packs[game] || []).length;
      const left = ((game==='Oggetti')||(game==='Cosmetic')||(game==='Bronze')||(game==='Silver')||(game==='Gold')) ? '‚àû' : String(Math.max(0, totalPacks - (GAME_STATE.cursor[game] || 0)));
      const cardsCount = ((game==='Bronze'||game==='Silver'||game==='Gold') ? ((GAME_STATE.pools[game + '_main']?.length || 0) + (GAME_STATE.pools[game + '_oggs']?.length || 0)) : (GAME_STATE.pools[game]?.length || 0));
      const subtitle = ((game==='Oggetti')||(game==='Cosmetic')||(game==='Bronze')||(game==='Silver')||(game==='Gold'))
        ? `${cardsCount} carte`
        : `${left}/${totalPacks} pacchi ‚Ä¢ ${cardsCount} carte`;

      const card = document.createElement('div');
      card.className = 'featured-card';
      card.setAttribute('data-game', game);
      card.innerHTML = `
        <img src="${imgSrc}" alt="${game}" />
        <div class="featured-cost">${game}</div>
        <div class="featured-cost">${cost > 0 ? (cost + ' pts') : 'Gratis'}</div>
        <div class="featured-sub" style="margin-top:4px; color:#cfd6ff; font-size:12px;">${subtitle}</div>
      `;
      card.addEventListener('click', ()=>{
        GAME_STATE.selected = game;
        applyPackVisual();
        updateOpenBtnEnabled();
        // evidenzia selezione nella strip
        document.querySelectorAll('#packsStrip .featured-card').forEach(c=>c.style.outline='');
        card.style.outline = '2px solid rgba(110,231,255,.5)';
      }, {passive:true});
      frag.appendChild(card);
    }
    strip.appendChild(frag);
  } catch(e){
    console.warn('[renderPacksStrip]', e);
  }
}

function packsLeft(game){ return Math.max(0, (GAME_STATE.packs[game]||[]).length - (GAME_STATE.cursor[game]||0)); }

function renderGamePicker(){
  const frag=document.createDocumentFragment();
  for (const game of VALID_GAMES){
    const totalCards = ((game==='Bronze'||game==='Silver'||game==='Gold') ? ((GAME_STATE.pools[game + '_main']?.length || 0) + (GAME_STATE.pools[game + '_oggs']?.length || 0)) : (GAME_STATE.pools[game]?.length || 0));
    const totalPacks = (GAME_STATE.packs[game]||[]).length;
    const left = packsLeft(game);
    const btn=document.createElement('button');
    btn.type='button'; btn.className='choice';
    btn.setAttribute('data-game',game);
    btn.setAttribute('aria-selected', String(GAME_STATE.selected===game));
    const back = PACK_BACK_BY_GAME[game] || 'patatrine.png';

    const subtitle = ((game==='Oggetti')||(game==='Cosmetic')||(game==='Bronze')||(game==='Silver')||(game==='Gold'))
      ? `‚àû pacchetti ‚Ä¢ ${totalCards} carte`
      : `${left}/${totalPacks} pacchetti ‚Ä¢ ${totalCards} carte`;

    btn.innerHTML = `
      <div class="prev" style="background-image:url('${back}')"></div>
      <div class="meta">
        <span class="name">${game}</span>
        <span class="price">${subtitle}</span>
      </div>`;
    btn.addEventListener('click', ()=>{
      GAME_STATE.selected = game;
      applyPackVisual();
      [...gamePicker.querySelectorAll('.choice')].forEach(c=>c.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      updateOpenBtnEnabled();
    });
    frag.appendChild(btn);
  }
  gamePicker.innerHTML='';
  gamePicker.appendChild(frag);

  pricePill.textContent = `üí∞ Costo: ${PACK_COST_PER_GAME[GAME_STATE.selected]}`;
}

function applyPackVisual(){
  const back = PACK_BACK_BY_GAME[GAME_STATE.selected] || 'patatrine.png';
  packEl.style.backgroundImage = `url('${back}')`;
  pricePill.textContent = `üí∞ Costo: ${PACK_COST_PER_GAME[GAME_STATE.selected]}`;
}

function updateOpenBtnEnabled(){
  const game = GAME_STATE.selected;
  let left = packsLeft(game);
  const cost = PACK_COST_PER_GAME[game] || 0;
  const badgeText = pointsBadge.textContent || 'Punti: 0';
  const pts = Number((badgeText.split(':')[1]||'0').trim()) || 0;
  const noLimit = ((game==='Oggetti')||(game==='Cosmetic')||(game==='Bronze')||(game==='Silver')||(game==='Gold'));

  openBtn.disabled = (!noLimit && left <= 0) || (cost > 0 && pts < cost);
  renderGamePicker();
  renderPacksStrip();

}

// Reset cursori ‚Üí 0 per tutti i game (Oggetti non usa i pacchetti, ma lasciamo uguale)
resetPacksBtn.addEventListener('click', async ()=>{
  try{
    document.getElementById('log').textContent = '‚ôªÔ∏è Mischio i pacchetti...';
    // Azzera cursori e pacchetti (Oggetti non usa pacchetti, ma azzerarlo non fa male)
    for (const g of VALID_GAMES){ GAME_STATE.cursor[g]=0; GAME_STATE.packs[g]=[]; }
    try{ localStorage.removeItem('futtu_cursors'); }catch{}
    await loadCards(); // ricarica + rimescola tutto
    document.getElementById('log').textContent = '‚úÖ Pacchetti rimescolati.';
    renderGamePicker(); updateOpenBtnEnabled(); applyPackVisual();
  }catch(e){
    console.warn('reset failed', e); document.getElementById('log').textContent = '‚ö†Ô∏è Reset non riuscito.';
  }
});

/** =========================
 *  CARTE UI
 *  ========================= */
function makeCardEl(d,isFinal){
  const tpl=document.getElementById('tplCard');
  const n=tpl.content.firstElementChild.cloneNode(true);
  const backImg = n.querySelector('.back img');
  if (backImg) {
    const back = PACK_BACK_BY_GAME[GAME_STATE.selected] || 'patatrine.png';
    backImg.src = back;
    backImg.alt = `Retro carta ‚Äì ${GAME_STATE.selected}`;
  }
  const rslug=String(d.rarity||'').toLowerCase().replace(/\s+/g,'-');
  if(rslug) n.classList.add('r-'+rslug);
  if(isFinal) n.classList.add('final');
  const front=n.querySelector('.front img');
  front.src=d.img||''; front.alt=`Carta ${d.name||''}`; front.loading='lazy'; front.decoding='async';
  n.querySelector('.badge').textContent=d.rarity||'';
  n.dataset.state='back';
  n.addEventListener('click',()=>{ 
    if(n.dataset.state==='back'){ revealCard(n,d) } 
    else { n.dataset.state='back'; n.classList.remove('revealed') } 
  },{passive:true});
  return n;
}
function addSparks(el,n=10){
  let cont=el.querySelector('.spark');
  if(!cont){ cont=document.createElement('div'); cont.className='spark'; el.appendChild(cont) }
  cont.innerHTML=''; const frag=document.createDocumentFragment();
  for(let i=0;i<n;i++){
    const s=document.createElement('i');
    const x=10+Math.random()*80, xEnd=x+(-8+Math.random()*16), rot=-15+Math.random()*30;
    s.style.setProperty('--x',x+'%'); s.style.setProperty('--xEnd',xEnd+'%'); s.style.setProperty('--rot',rot+'deg');
    s.style.left=x+'%'; s.style.top=(5+Math.random()*20)+'%';
    frag.appendChild(s)
  }
  cont.appendChild(frag)
}
function revealCard(n,d){
  const front=n.querySelector('.front img');
  if(front && !front.src) front.src=d.img||'';
  n.dataset.state='front'; n.classList.add('revealed');
  const rank=rarityRank[d.rarity] ?? 0;
  addSparks(n,Math.min(6+rank*4,28));
  playByRarity(d.rarity);
  if ((String(d.rarity||'').toLowerCase()==='leggendaria')) { n.classList.add('legendaryPulse'); }
}
function setDropIn(el,i,extra=0){ el.classList.add('drop'); setTimeout(()=>el.classList.add('in'),120*i+extra) }
function showStage(cards){
  const wrap=document.getElementById('stageWrap'), stage=document.getElementById('stage');
  stage.innerHTML=''; wrap.classList.add('show');
  const last=cards.length-1; const frag=document.createDocumentFragment();
  cards.forEach((c,i)=>{ const el=makeCardEl(c,i===last); frag.appendChild(el); setDropIn(el,i) });
  stage.appendChild(frag);
  
  document.getElementById('log').textContent='Pacchetto pronto. Tocca le carte per rivelarle.';
}

/** =========================
 *  OPEN PACK (con caso speciale Oggetti infinito)
 *  ========================= */
const flashLine = document.getElementById('flashLine');
const flashScreen = document.getElementById('flashScreen');
const packArea = document.getElementById('packArea');
const packBox = document.getElementById('pack');
document.addEventListener('click', ()=>{ try{ ensureAudio() }catch{} }, {once:true});

openBtn.addEventListener('click', async () => {
  const BTN = openBtn;
  const game = GAME_STATE.selected;
  const cost = PACK_COST_PER_GAME[game] || 0;

  // Login + Wallet (se serve) + eventuale addebito
  let newPts = await getCurrentPoints();
  try {
    let u = firebase.auth().currentUser;
    if (!u || u.isAnonymous) u = await ensureGoogleUser();
    await ensureWallet10();
    newPts = await debitPackCostOrThrow(cost);
    const txt = cost>0 ? `‚úÖ ${cost} punti scalati. Punti rimasti: ${newPts}` : 'üÜì Pacchetto gratuito aperto.';
    document.getElementById('log').textContent = txt;
  } catch (e) {
    if (e.message === 'redirecting') return;
    const code = e.code || e.message || 'unknown';
    let msg = '‚ö†Ô∏è Errore durante la scalatura punti.';
    if (code === 'login-required') msg = 'üîê Accedi con Google per aprire un pacchetto.';
    else if (code === 'no-points') msg = `üòï Punti insufficienti (costo: ${cost}).`;
    else if (code === 'permission-denied') msg = '‚õî Permessi Firestore insufficienti per scrivere sul wallet.';
    else if (code === 'unavailable') msg = 'üì° Sei offline o Firestore non √® raggiungibile.';
    else if (code === 'cancelled' || code === 'aborted') msg = '‚è≥ Transazione annullata. Riprova tra poco.';
    else if (code === 'failed-precondition') msg = '‚öôÔ∏è Versione offline non attiva. Ricarica la pagina.';
    document.getElementById('log').textContent = msg + ' (' + code + ')';
    console.error('[OPEN BTN ERROR]', code, e);
    return;
  }

  // Carica carte (se non gi√†)
if (!GAME_STATE.packs['Wonderkid'].length && 
    !GAME_STATE.packs['Patatine'].length && 
    !GAME_STATE.packs['Gotham Tots'].length &&
    !GAME_STATE.packs['Gold'].length &&
    !GAME_STATE.pools['Oggetti']?.length) {
  await loadCards();
}


  // Animazioni apertura
  packBox.classList.add('shake'); await delay(360); packBox.classList.remove('shake');
  flashLine.classList.add('active'); flashScreen.classList.add('active'); packBox.classList.add('opening');
  await delay(900); packArea.style.display='none';

  // Scelta carte
  let chosen;
  if ((game==='Oggetti')||(game==='Cosmetic')) {
     // Pacchetto infinito: X carte random dalla serie corrispondente (anche doppioni)
    const pool = GAME_STATE.pools[game] || [];
    const size = PACK_SIZE_PER_GAME[game] || 1;
    if (!pool.length) {
      document.getElementById('log').textContent = '‚ö†Ô∏è Nessuna carta disponibile nella serie Oggetto.';
      return;
    }
    chosen = Array.from({ length: size }, () => pool[Math.floor(Math.random() * pool.length)]);
  } else if ((game==='Bronze')||(game==='Silver')||(game==='Gold')) {
    const og = GAME_STATE.pools[game + '_oggs'] || [];
    const mn = GAME_STATE.pools[game + '_main'] || [];
    if (!og.length || !mn.length) {
      // fallback ai pacchetti predefiniti (finito) se i pool non sono pronti
      const list = GAME_STATE.packs[game] || [];
      const idx  = GAME_STATE.cursor[game] || 0;
      if (idx < list.length) {
        chosen = list[idx].slice();
        GAME_STATE.cursor[game] = idx + 1;
        try{ localStorage.setItem('futtu_cursors', JSON.stringify(GAME_STATE.cursor)); }catch{}
      } else {
        document.getElementById('log').textContent = '‚ö†Ô∏è ' + game + ': sorgenti non pronte.';
        return;
      }
    } else {
      chosen = generateBSGOnTheFly(game);
    }
  } else {
    // Estrai il prossimo pacchetto finito (comportamento standard)
    const list = GAME_STATE.packs[game] || [];
    const idx = GAME_STATE.cursor[game] || 0;
    if (idx >= list.length){
      document.getElementById('log').textContent = '‚ùå Pacchetti esauriti per questo game.';
      return;
    }
    chosen = list[idx].slice();

    // Avanza cursore e salva su localStorage (solo per game finiti)
    GAME_STATE.cursor[game] = idx + 1;
    try{ localStorage.setItem('futtu_cursors', JSON.stringify(GAME_STATE.cursor)); }catch{}
  }
// Ordinamento / raggruppamento + FX
const hasLegend = chosen.some(c => (String(c.rarity||'').toLowerCase()==='leggendaria'));

// Per Bronze/Silver/Gold manteniamo l'ordine "3 Oggetti, poi 6 main" senza rimescolare per rarit√†
if (['Bronze','Silver','Gold'].includes(game)) {
  const isOggetto = (c) => (String(c.series||'').trim().toLowerCase() === 'oggetto');
  const oggs  = chosen.filter(isOggetto);
  const mains = chosen.filter(c => !isOggetto(c));
  // preserva l'ordine originale generato (oggetti gi√† primi), forziamo comunque il grouping
  chosen = [...oggs, ...mains];
} else {
  // per gli altri giochi va bene ordinare per rarit√† (basso -> alto)
  chosen.sort((a,b)=> (rarityRank[a.rarity]||0) - (rarityRank[b.rarity]||0) );
}

if (hasLegend) { try{ triggerLegendFX(); }catch{} }

// Mostra in scena
showStage(chosen);

  // Aggiorna UI
  renderGamePicker();
  updateOpenBtnEnabled();

  // Salva inventario
  try {
    await saveInventario(chosen);
    const msgTail = `<a href="https://pavoniingrifati.github.io/vetrina-carte/my-cards">Vai alle mie carte ‚Üí</a>`;
    document.getElementById('log').innerHTML =
      (cost>0 ? `‚úÖ Pacchetto salvato. Punti rimasti: <b>${newPts}</b>. ` : '‚úÖ Pacchetto salvato. ') + msgTail;
  } catch (e) {
    if (e.message === 'login-required') {
      document.getElementById('log').textContent = 'üîí Accedi con Google per salvare le carte in "Le mie carte".';
    } else {
      document.getElementById('log').textContent = '‚ö†Ô∏è Errore nel salvataggio. Riprova.';
      console.error(e);
    }
  }
});

/** =========================
 *  INIT
 *  ========================= */
window.addEventListener('DOMContentLoaded', async ()=>{
  // Precarica cover pack
  Object.values(PACK_BACK_BY_GAME).forEach(src=>{ const im=new Image(); im.decoding='async'; im.src=src; });
  applyPackVisual();
  initPointsUI();
  await loadCards();
  document.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !openBtn.disabled) openBtn.click() });
  document.getElementById('pack').addEventListener('click', ()=>{ if(!openBtn.disabled) openBtn.click() }, {passive:true});
});
</script>
<script>
function triggerLegendFX(){
  try{
    const fx=document.createElement('div'); fx.className='legend-fx';
    fx.innerHTML=`<div class="halo"></div><div class="rays"></div><div class="burst"></div><div class="title">LEGEND!</div>`;
    document.body.appendChild(fx); document.body.classList.add('legend-body-glow');
    const N=80; for(let i=0;i<N;i++){ const s=document.createElement('div'); s.className='confetti'; s.style.left=(Math.random()*100)+'vw'; s.style.top='-4vh'; s.style.background=`hsl(${Math.floor(40+Math.random()*40)} 100% 60%)`; s.style.opacity='0.9'; fx.appendChild(s); const dx=(-40+Math.random()*80); const dur=1200+Math.random()*1200; setTimeout(()=>{ s.animate([{transform:`translate(${dx*.2}vw, 0vh) rotate(0deg)`, opacity:.95},{transform:`translate(${dx}vw, 110vh) rotate(${180+Math.random()*360}deg)`, opacity:.2}],{duration:dur,easing:'cubic-bezier(.2,.8,.2,1)',fill:'forwards'}); }, Math.random()*200); }
    setTimeout(()=>{ fx.remove(); document.body.classList.remove('legend-body-glow'); }, 2500);
  }catch(e){ console.warn('legend fx failed', e); }
}
</script>

<script>
function renderFeaturedCarousel(packs) {
  const featuredDiv = document.getElementById('featured');
  featuredDiv.innerHTML = '<div class="featured-carousel" id="featuredCarousel"></div>';
  const carousel = document.getElementById('featuredCarousel');
  packs.forEach((pack, index) => {
    const card = document.createElement('div');
    card.className = 'featured-card';
    card.innerHTML = `
      <img src="${pack.image}" alt="${pack.name}">
      <div class="featured-cost">Costo: ${pack.cost}</div>
    `;
    card.addEventListener('click', () => {
      // seleziona e apre direttamente il pack cliccato
      selectedGame = pack;
      updateOpenBtnEnabled();
      document.getElementById('openPackBtn').click();
    });
    carousel.appendChild(card);
  });
}

// ===== Striscia orizzontale dei pacchetti (tipo carosello) =====
const packsStrip = document.getElementById('packsStrip');

function renderPacksStrip(){
  if (!packsStrip) return;
  packsStrip.innerHTML = '';

  VALID_GAMES.forEach((game) => {
    const back = PACK_BACK_BY_GAME[game] || 'patatrine.png';
    const left = packsLeft(game);
    const total = (GAME_STATE.packs[game] || []).length;

    const card = document.createElement('button');
    card.type = 'button';
    card.className = 'featured-card';
    if (GAME_STATE.selected === game) card.setAttribute('aria-current', 'true');

    const subtitle = ((game==='Oggetti')||(game==='Cosmetic')||(game==='Bronze')||(game==='Silver')||(game==='Gold'))
      ? '‚àû pacchetti'
      : `${Math.max(0, left)}/${total} pacchetti`;

    card.innerHTML = `
      <img src="${back}" alt="${game}">
      <div class="featured-cost">${game} ‚Ä¢ ${subtitle}</div>
    `;

    card.addEventListener('click', () => {
      GAME_STATE.selected = game;
      applyPackVisual();
      updateOpenBtnEnabled();
      renderPacksStrip();
    });

    packsStrip.appendChild(card);
  });

  // drag-to-scroll (mouse + touch)
  let isDown = false, startX = 0, startScroll = 0;
  const start = (x) => { isDown = true; startX = x; startScroll = packsStrip.scrollLeft; };
  const move  = (x) => { if (isDown) packsStrip.scrollLeft = startScroll - (x - startX); };
  const stop  = () => { isDown = false; };

  packsStrip.onmousedown = (e) => start(e.pageX);
  packsStrip.onmousemove = (e) => move(e.pageX);
  packsStrip.onmouseup = packsStrip.onmouseleave = stop;

  packsStrip.ontouchstart = (e) => start(e.touches[0].pageX);
  packsStrip.ontouchmove  = (e) => { move(e.touches[0].pageX); };
  packsStrip.ontouchend   = stop;
}


// === Featured strip rendering (only: Wonderkid, Patatine) ===
function renderPacksStrip(){
  const strip = document.getElementById('packsStrip');
  if (!strip) return;
  const FEATURED_LIST = ['Wonderkid','Patatine']; // solo quelli richiesti
  strip.innerHTML='';
  const frag = document.createDocumentFragment();
  FEATURED_LIST.forEach(game => {
    if (!PACK_BACK_BY_GAME[game]) return;
    const card = document.createElement('div');
    card.className = 'featured-card';
    card.setAttribute('data-game', game);
    card.innerHTML = `
      <img src="${PACK_BACK_BY_GAME[game]}" alt="${game}" loading="lazy" decoding="async" />
      <div>${game}</div>
      <div class="featured-cost">Costo: ${PACK_COST_PER_GAME[game] || 0}</div>
    `;
    card.addEventListener('click', () => {
      GAME_STATE.selected = game;
      applyPackVisual();
      updateOpenBtnEnabled();
      // evidenzia selezione
      [...strip.children].forEach(el => el.classList.remove('is-selected'));
      card.classList.add('is-selected');
    }, {passive:true});
    frag.appendChild(card);
  });
  strip.appendChild(frag);
}

</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  try{ renderPacksStrip(); }catch(e){ console.warn('renderPacksStrip missing?', e); }
});
</script>


<script>
// === Navigation and section rendering ===
(function(){
  // Keep a reference to title element if it exists
  const titleEl = document.querySelector('.fc-title') || document.querySelector('.section-title') || null;
  const strip = document.getElementById('packsStrip');

  function renderSection(sectionKey){
    if (!strip || !window.STORE_SECTIONS) return;
    const list = (window.STORE_SECTIONS[sectionKey] || []).slice();
    strip.innerHTML='';
    const frag = document.createDocumentFragment();
    list.forEach(game => {
      if (!window.PACK_BACK_BY_GAME || !PACK_BACK_BY_GAME[game]) return;
      const card = document.createElement('div');
      card.className = 'featured-card';
      card.setAttribute('data-game', game);
      card.innerHTML = `
        <img src="${PACK_BACK_BY_GAME[game]}" alt="${game}" loading="lazy" decoding="async" />
        <div>${game}</div>
        <div class="featured-cost">Costo: ${PACK_COST_PER_GAME[game] || 0}</div>
      `;
      card.addEventListener('click', () => {
        GAME_STATE.selected = game;
        applyPackVisual();
        updateOpenBtnEnabled();
        [...strip.children].forEach(el => el.classList.remove('is-selected'));
        card.classList.add('is-selected');
      }, {passive:true});
      frag.appendChild(card);
    });
    strip.appendChild(frag);
    // Update title text to reflect section (optional)
    if (titleEl){
      const map = {
        featured: 'Featured',
        new: 'Ultimi arrivi',
        base: 'Pacchetti base',
        all: 'Tutti i pacchi'
      };
      titleEl.textContent = map[sectionKey] || 'Store';
    }
  }

  // Add click handlers to sidebar items
  function bindSidebar(){
    const sidebar = document.querySelector('.fc-sidebar');
    if (!sidebar) return;
    sidebar.querySelectorAll('li[data-section]').forEach(li => {
      li.addEventListener('click', () => {
        // Active state
        sidebar.querySelectorAll('li').forEach(x => x.classList.remove('active'));
        li.classList.add('active');
        const key = li.getAttribute('data-section');
        renderSection(key);
      }, {passive:true});
    });
  }

  // Expose for other scripts if needed
  window.renderSection = renderSection;

  // Initialize
  document.addEventListener('DOMContentLoaded', function(){
    try{
      bindSidebar();
      renderSection('featured'); // default view
    }catch(e){ console.warn('nav init error', e); }
  });
})();
</script>


<script>
// === Selettore sezione + filtro giochi ===
window.CURRENT_SECTION = 'featured'; // default

function getVisibleGames(){
  const all = (typeof VALID_GAMES !== 'undefined') ? VALID_GAMES : [];
  const sec = (window.CURRENT_SECTION && window.STORE_SECTIONS && window.STORE_SECTIONS[CURRENT_SECTION])
    ? window.STORE_SECTIONS[CURRENT_SECTION]
    : all;
  // Se la sezione richiede "tutti i pacchi", prendi tutti quelli disponibili ora
  if (window.CURRENT_SECTION === 'all') return all;
  // Normalizza mantenendo solo quelli che esistono
  const set = new Set(all);
  return (sec || []).filter(g => set.has(g));
}

// Attiva la sezione sulla sidebar e rinfresca la UI
function activateSection(section){
  window.CURRENT_SECTION = section || 'featured';

  // Aggiorna stato "active" sulla sidebar
  document.querySelectorAll('.fc-sidebar li[data-section]').forEach(li => {
    li.classList.toggle('active', li.getAttribute('data-section') === window.CURRENT_SECTION);
  });

  // Se il selezionato attuale non √® visibile, rimpiazza con il primo della lista
  const visible = getVisibleGames();
  if (!visible.length) return; // niente da mostrare
  if (!visible.includes(GAME_STATE.selected)) {
    GAME_STATE.selected = visible[0];
    applyPackVisual();
  }

  // Rerender controlli dipendenti
  renderGamePicker();
  renderPacksStrip && renderPacksStrip();
  updateOpenBtnEnabled();
}

// Wire dei click alla sidebar
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.fc-sidebar li[data-section]').forEach(li => {
    li.addEventListener('click', () => activateSection(li.getAttribute('data-section')));
  });
  // Avvio: rispetta la voce gi√† marcata .active
  const activeLi = document.querySelector('.fc-sidebar li[data-section].active');
  activateSection(activeLi ? activeLi.getAttribute('data-section') : 'featured');
});

// Patch: renderGamePicker usa il filtro della sezione attuale
const _renderGamePicker_orig = typeof renderGamePicker === 'function' ? renderGamePicker : null;
window.renderGamePicker = function(){
  const list = getVisibleGames();
  const frag = document.createDocumentFragment();
  const gamePicker = document.getElementById('gamePicker');
  if (!gamePicker) return;

  gamePicker.innerHTML='';
  list.forEach(game => {
    const totalCards = ((game==='Bronze'||game==='Silver'||game==='Gold') ? ((GAME_STATE.pools[game + '_main']?.length || 0) + (GAME_STATE.pools[game + '_oggs']?.length || 0)) : ((GAME_STATE.pools[game]||[]).length));
    const totalPacks = (GAME_STATE.packs[game]||[]).length;
    const left = Math.max(0, totalPacks - (GAME_STATE.cursor[game]||0));
    const btn=document.createElement('button');
    btn.type='button'; btn.className='choice';
    btn.setAttribute('data-game',game);
    btn.setAttribute('aria-selected', String(GAME_STATE.selected===game));
    const back = PACK_BACK_BY_GAME[game] || 'patatrine.png';
    const subtitle = ((game==='Oggetti')||(game==='Cosmetic')||(game==='Bronze')||(game==='Silver')||(game==='Gold'))
      ? `‚àû pacchetti ‚Ä¢ ${totalCards} carte`
      : `${left}/${totalPacks} pacchetti ‚Ä¢ ${totalCards} carte`;
    btn.innerHTML = `
      <div class="prev" style="background-image:url('${back}')"></div>
      <div class="meta">
        <span class="name">${game}</span>
        <span class="price">${subtitle}</span>
      </div>`;
    btn.addEventListener('click', ()=>{
      GAME_STATE.selected = game;
      applyPackVisual();
      [...gamePicker.querySelectorAll('.choice')].forEach(c=>c.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      updateOpenBtnEnabled();
    }, {passive:true});
    frag.appendChild(btn);
  });
  gamePicker.appendChild(frag);
  pricePill.textContent = `üí∞ Costo: ${PACK_COST_PER_GAME[GAME_STATE.selected]}`;
};

// Patch: renderPacksStrip (se definito) filtra in base alla sezione
const _renderPacksStrip_orig = typeof renderPacksStrip === 'function' ? renderPacksStrip : null;
window.renderPacksStrip = function(){
  const container = document.getElementById('packsStrip');
  if (!container) return;
  const games = getVisibleGames();
  container.innerHTML = '';
  games.forEach(game => {
    // Piccola card per ogni pacco disponibile nel gioco selezionato
    const totalPacks = (GAME_STATE.packs[game]||[]).length;
    const left = Math.max(0, totalPacks - (GAME_STATE.cursor[game]||0));
    const card = document.createElement('div');
    card.className = 'featured-card';
    const back = PACK_BACK_BY_GAME[game] || 'patatrine.png';
    card.innerHTML = `
      <img src="${back}" alt="Anteprima ${game}">
      <div style="margin-top:6px;font-weight:700">${game}</div>
      <div class="featured-cost">${game==='Oggetti' ? '‚àû' : `${left}/${totalPacks}`} pacchi</div>
    `;
    card.addEventListener('click', ()=>{
      GAME_STATE.selected = game;
      applyPackVisual();
      updateOpenBtnEnabled();
      // evidenzia corrispondente chip
      document.querySelectorAll('#gamePicker .choice').forEach(c=>c.setAttribute('aria-selected','false'));
      const chip = document.querySelector(`#gamePicker .choice[data-game="${CSS.escape(game)}"]`);
      if (chip) chip.setAttribute('aria-selected','true');
      // Scroll a vista
      const pack = document.getElementById('pack'); 
      if (pack) pack.scrollIntoView({behavior:'smooth', block:'center'});
    }, {passive:true});
    container.appendChild(card);
  });
};
</script>

<script>
// ===== Editable Coins & Likes =====
(function(){
  const coinsEl = document.getElementById('fc-coins');
  const likesEl = document.getElementById('fc-likes');

  function parseNumber(s){
    if (!s) return 0;
    return Number(String(s).replace(/[^0-9]/g,'')) || 0;
  }
  function formatNumber(n){
    try{ return n.toLocaleString('it-IT'); } catch { return String(n); }
  }
  function load(){
    const c = localStorage.getItem('fc_coins');
    const l = localStorage.getItem('fc_likes');
    if (c!==null) coinsEl.textContent = formatNumber(parseNumber(c));
    if (l!==null) likesEl.textContent = formatNumber(parseNumber(l));
  }
  function saveCoins(){ localStorage.setItem('fc_coins', String(parseNumber(coinsEl.textContent))); }
  function saveLikes(){ localStorage.setItem('fc_likes', String(parseNumber(likesEl.textContent))); }

  function onEdit(el, saver){
    el.addEventListener('input', ()=>{
      // keep only digits while typing
      const pos = window.getSelection && window.getSelection().anchorOffset;
      const v = el.textContent;
      const num = parseNumber(v);
      el.textContent = String(num);
      // restore caret at end
      const range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges(); sel.addRange(range);
    });
    el.addEventListener('blur', ()=>{
      el.textContent = formatNumber(parseNumber(el.textContent));
      saver();
      // reflect to topbar if there are mirrored elements
      const mirrorId = el.id === 'fc-coins' ? 'fc-coins' : 'fc-likes';
      document.querySelectorAll('#'+mirrorId).forEach((m)=>{ if (m!==el) m.textContent = el.textContent; });
      updateOpenBtnEnabled && updateOpenBtnEnabled();
    });
    el.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){ e.preventDefault(); el.blur(); }
    });
  }

  if (coinsEl && likesEl){
    load();
    onEdit(coinsEl, saveCoins);
    onEdit(likesEl, saveLikes);
  }
})();
</script>
<script>

// === Visual micro-interactions (non-breaking) ============================
(function(){
  const POP_CLASS = 'pop-in';
  const style = document.createElement('style');
  style.textContent = `
  .${POP_CLASS} { animation: popIn .28s ease-out both; }
  @keyframes popIn { from { transform: scale(.92); opacity:.0 } to { transform: scale(1); opacity:1 } }
  `;
  document.head.appendChild(style);

  // Simple confetti (tiny, no deps)
  function confettiBurst(x=window.innerWidth/2, y=120) {
    const colors = ['#22d3ee','#06b6d4','#c084fc','#a78bfa','#f472b6','#f59e0b'];
    const N = 60;
    for (let i=0;i<N;i++){
      const el = document.createElement('i');
      Object.assign(el.style, {
        position:'fixed', left:`${x}px`, top:`${y}px`, width:'6px', height:'6px',
        background: colors[Math.floor(Math.random()*colors.length)],
        transform: `translate(-50%,-50%) rotate(${Math.random()*360}deg)`,
        borderRadius: '2px', pointerEvents:'none', zIndex: 9999,
        boxShadow: '0 2px 8px rgba(0,0,0,.35)'
      });
      document.body.appendChild(el);
      const dx = (Math.random()-.5) * 280;
      const dy = (Math.random()*-240) - 80;
      const rot = (Math.random()-.5) * 720;
      el.animate([
        { transform:`translate(-50%,-50%)`, opacity:1 },
        { transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg)`, opacity:0 }
      ], { duration: 1200 + Math.random()*500, easing: 'cubic-bezier(.21,1,.22,1)' }).onfinish = () => el.remove();
    }
  }

  // Hook into the existing "Open Pack" button for the burst + pop on resulting cards
  window.addEventListener('DOMContentLoaded', () => {
    const openBtn = document.getElementById('openBtn');
    if (openBtn){
      openBtn.addEventListener('click', () => {
        setTimeout(() => confettiBurst(window.innerWidth/2, 140), 250);
        setTimeout(() => {
          // add pop-in to visible cards (best-effort, non-breaking)
          document.querySelectorAll('.stageWrap .card, .stage .card, .featured-carousel .card')
            .forEach(el => { el.classList.add(POP_CLASS); setTimeout(()=>el.classList.remove(POP_CLASS), 400); });
        }, 320);
      });
    }
  });
})();
// ========================================================================

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantaballa ‚Äì Open Pack</title>
  <meta name="description" content="Simulatore apertura pacchetti con rarit√†, animazioni e reveal progressivo (dati locali da cards.json)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f19;
      --panel: #0f1526; 
      --card: #121a2e;
      --card-2: #0d1325;
      --text: #ecf0ff;
      --muted: #a7b0d3;
      --accent: #6ee7ff;
      --danger: #ff6b6b;
      --radius: 16px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% -10%, #132040, transparent), var(--bg);
      color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    a{color:var(--accent); text-decoration:none}
    header{
      position:sticky; top:0; z-index:100; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(13,19,37,.9), rgba(13,19,37,.6));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto; padding: 20px;}
    .title{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{font-size: clamp(20px, 3.6vw, 34px); margin:0}
    .subtitle{color:var(--muted); margin-top:6px}

    /* Toolbar impostazioni pack */
    .toolbar{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:16px;}
    @media (min-width: 900px){ .toolbar{grid-template-columns: .7fr .7fr .7fr 1fr auto} }
    .control{
      background: linear-gradient(180deg, #121a2e, #0d1325);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px; color: var(--text);
      padding:12px 14px; display:flex; align-items:center; gap:12px;
    }
    .control input[type="number"], .control select{
      flex:1; background:transparent; border:none; color:var(--text); outline:none;
    }
    .btn{
      background: linear-gradient(180deg, #1b2a4d, #152141);
      border:1px solid rgba(110,231,255,.35);
      border-radius:12px; color:white; padding:12px 16px; cursor:pointer;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* Tavolo pack */
    .stage{margin:22px 0 40px; display:grid; gap:16px; grid-template-columns: repeat(1, minmax(0,1fr))}
    @media(min-width:600px){.stage{grid-template-columns: repeat(2, minmax(0,1fr))}}
    @media(min-width:900px){.stage{grid-template-columns: repeat(3, minmax(0,1fr))}}
    @media(min-width:1200px){.stage{grid-template-columns: repeat(4, minmax(0,1fr))}}

    /* Carta (fronte/retro) */
    .card{
      position:relative; border-radius: var(--radius);
      transform-style: preserve-3d; transition: transform .6s ease;
      cursor: pointer; min-height: 320px; box-shadow: 0 6px 18px rgba(0,0,0,.35);
    }
    .card.flip{ transform: rotateY(180deg); }
    .face{
      position:absolute; inset:0; border-radius:var(--radius); overflow:hidden;
      backface-visibility: hidden;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,0) 60%), var(--card);
      display:flex; align-items:center; justify-content:center;
    }
    .back{
      background: radial-gradient(800px 500px at 20% -10%, rgba(110,231,255,.15), transparent), var(--card-2);
      border:1px solid rgba(110,231,255,.25);
      box-shadow: inset 0 0 40px rgba(110,231,255,.18), 0 14px 40px rgba(0,0,0,.5);
      font-weight:700; letter-spacing:.5px; color:#a7e9ff;
    }
    .front{ transform: rotateY(180deg); display:grid; grid-template-rows: auto 1fr auto }
    .front img{ width:100%; height:100%; object-fit:cover; aspect-ratio:3/4; background:#0b0f19 }
    .front .meta{ padding:10px 12px; font-size:13px; color:#aeb7d9; display:flex; gap:8px; flex-wrap:wrap }
    .front .name{ padding:10px 12px 0; font-weight:600 }
    .badge{
      position:absolute; top:10px; right:10px; z-index:2;
      padding:6px 8px; border-radius:999px; font-size:12px; font-weight:700; color:white;
      border:1px solid rgba(255,255,255,.15);
    }

    /* Colori badge per rarit√† */
    .r-comune      .badge{ background: rgba(154,163,178,.85)}
    .r-non-comune  .badge{ background: rgba(52,211,153,.85)}
    .r-rara        .badge{ background: rgba(96,165,250,.85)}
    .r-ultra-rara  .badge{ background: rgba(251,191,36,.9); color:#000}
    .r-epica       .badge{ background: rgba(167,139,250,.9)}
    .r-season      .badge{ background: rgba(239,68,68,.9)}

    /* Glow per rarit√† sul bordo */
    .r-comune      { box-shadow: 0 0 0 1px rgba(154,163,178,.35), 0 12px 30px rgba(0,0,0,.45) }
    .r-non-comune  { box-shadow: 0 0 0 1px rgba(52,211,153,.35), 0 12px 30px rgba(0,0,0,.45) }
    .r-rara        { box-shadow: 0 0 0 1px rgba(96,165,250,.35), 0 12px 30px rgba(0,0,0,.45) }
    .r-ultra-rara  { box-shadow: 0 0 0 1px rgba(251,191,36,.45), 0 12px 30px rgba(0,0,0,.45) }
    .r-epica       { box-shadow: 0 0 0 1px rgba(167,139,250,.45), 0 12px 30px rgba(0,0,0,.45) }
    .r-season      { box-shadow: 0 0 0 1px rgba(239,68,68,.55), 0 12px 30px rgba(0,0,0,.45) }

    /* Effetti */
    .pulse{ animation: pulse 1.2s ease-in-out infinite }
    @keyframes pulse{ 0%,100%{transform:scale(1)} 50%{transform:scale(1.02)} }
    .hidden{ visibility:hidden }

    /* Box log */
    .log{
      margin-top:8px; font-size:13px; color:var(--muted);
    }

    footer{border-top:1px solid rgba(255,255,255,.06); background:linear-gradient(0deg, rgba(13,19,37,.85), rgba(13,19,37,.6)); position:sticky; bottom:0}
    .foot{max-width:1200px; margin:0 auto; padding:12px 20px; font-size:13px; color:var(--muted)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03)}

    /* Mobile tweaks */
    @media (max-width: 500px) {
      .wrap { padding: 10px; }
      .toolbar { overflow-x: auto; display:flex; gap:8px; }
      .toolbar > * { flex:0 0 auto }
      .card { min-height: 280px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>Open Pack ‚Äì Fantaballa</h1>
          <div class="subtitle">Simulatore apertura pacchetti (demo offline, usa <code>cards.json</code>)</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <a href="index.html" class="pill">‚¨ÖÔ∏è Torna alla vetrina</a>
        </div>
      </div>

      <div class="toolbar" aria-label="Impostazioni pacchetto">
        <div class="control">
          Dimensione pacchetto
          <input id="packSize" type="number" min="3" max="12" value="6" />
        </div>
        <div class="control">
          Reveal
          <select id="revealMode">
            <option value="seq">Sequenziale</option>
            <option value="all">Tutte insieme</option>
          </select>
        </div>
        <div class="control">
          Garanzia Rara+
          <select id="guarantee">
            <option value="1" selected>Attiva</option>
            <option value="0">Disattiva</option>
          </select>
        </div>
        <div class="control" title="Probabilit√† predefinite: Comune 60, Non Comune 20, Rara 10, Epica 6, Ultra 3, Season 1">
          Preset probabilit√†
          <select id="weightsPreset">
            <option value="default" selected>Standard</option>
            <option value="juicy">Pi√π ricco</option>
            <option value="harsh">Pi√π raro</option>
          </select>
        </div>
        <button id="openBtn" class="btn">üéÅ Apri pacchetto</button>
      </div>
      <div class="log" id="log"></div>
    </div>
  </header>

  <main class="wrap">
    <section id="stage" class="stage" aria-live="polite"></section>
  </main>

  <footer>
    <div class="foot">
      <span class="pill">‚ÑπÔ∏è Demo: nessun backend. I risultati non vengono salvati online.</span>
    </div>
  </footer>

  <template id="tplCard">
    <div class="card pulse">
      <div class="face back">Tocca per rivelare</div>
      <div class="face front">
        <div class="badge"></div>
        <img alt="">
        <div class="name"></div>
        <div class="meta"></div>
      </div>
    </div>
  </template>

  <script>
    // ============== Utils
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]);

    // ============== Caricamento dati
    let ALL = [];
    async function loadData(){
      try{
        const res = await fetch('cards.json', { cache:'no-store' });
        if(!res.ok) throw new Error('cards.json non trovato');
        ALL = await res.json();
      }catch(e){
        console.error(e);
        ALL = [];
      }
    }

    // ============== Pesi rarit√†
    function getWeights(preset){
      if(preset==='juicy')   return { 'Season':2, 'Ultra Rara':5, 'Epica':8, 'Rara':15, 'Non Comune':25, 'Comune':45 };
      if(preset==='harsh')   return { 'Season':1, 'Ultra Rara':2, 'Epica':4, 'Rara':8,  'Non Comune':15, 'Comune':70 };
      // default
      return { 'Season':1, 'Ultra Rara':3, 'Epica':6, 'Rara':10, 'Non Comune':20, 'Comune':60 };
    }

    function pickRarity(weights){
      const entries = Object.entries(weights);
      const total = entries.reduce((s,[,w])=>s+w,0);
      let r = Math.random()*total;
      for(const [rar,w] of entries){
        if(r < w) return rar;
        r -= w;
      }
      return 'Comune';
    }

    function pickCardByRarity(rarity, usedIds=new Set()){
      // Prova stessa rarit√†; fallback a qualsiasi se vuoto
      let pool = ALL.filter(c => (c.rarity === rarity) && !usedIds.has(c.id));
      if(!pool.length) pool = ALL.filter(c => !usedIds.has(c.id));
      if(!pool.length) return null;
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function ensureAtLeastRare(cards){
      const hasRarePlus = cards.some(c => ['Rara','Epica','Ultra Rara','Season'].includes(c.rarity));
      if(hasRarePlus) return cards;
      // upgrade: rimpiazza una carta random con una Rara+ se esiste
      const pool = ALL.filter(c => ['Rara','Epica','Ultra Rara','Season'].includes(c.rarity));
      if(!pool.length) return cards;
      const idx = Math.floor(Math.random()*cards.length);
      cards[idx] = pool[Math.floor(Math.random()*pool.length)];
      return cards;
    }

    // ============== Rendering carte placeholder + reveal
    function makePlaceholder(){
      const node = $('#tplCard').content.firstElementChild.cloneNode(true);
      return node;
    }

    function renderPackPlaceholders(n){
      const stage = $('#stage');
      stage.innerHTML = '';
      for(let i=0;i<n;i++){
        const ph = makePlaceholder();
        stage.appendChild(ph);
      }
      return $$('#stage .card');
    }

    function revealCard(cardEl, data){
      // classe rarit√† per glow/badge
      const slug = (data.rarity||'').toLowerCase().replace(/\s+/g,'-');
      if(slug) cardEl.classList.add('r-'+slug);
      // front
      cardEl.querySelector('.badge').textContent = data.rarity;
      const img = cardEl.querySelector('img');
      img.src = data.img; img.alt = `Carta ${data.name}`;
      cardEl.querySelector('.name').textContent = data.name;
      cardEl.querySelector('.meta').textContent = `${data.game} ‚Ä¢ ${data.series} ‚Ä¢ ${data.role||'‚Äî'}`;
      // flip
      cardEl.classList.add('flip');
      cardEl.classList.remove('pulse');
      // al tocco dopo il flip: apri/chiudi per rivedere il retro
      let toggled = false;
      cardEl.addEventListener('click', ()=>{
        toggled = !toggled;
        cardEl.classList.toggle('flip', toggled);
      });
      // avvia in stato "fronte visibile"
      setTimeout(()=>{ cardEl.classList.add('flip'); },0);
    }

    async function openPack(){
      const openBtn = $('#openBtn');
      openBtn.disabled = true;
      $('#log').textContent = 'Estrazione in corso‚Ä¶';

      const size = Math.max(3, Math.min(12, parseInt($('#packSize').value||6,10)));
      const mode = $('#revealMode').value; // "seq" | "all"
      const weights = getWeights($('#weightsPreset').value);
      const guarantee = $('#guarantee').value === '1';

      if(!ALL.length) await loadData();
      if(!ALL.length){
        $('#log').textContent = 'Nessuna carta in cards.json';
        openBtn.disabled = false;
        return;
      }

      // Selezione logica
      const used = new Set();
      let chosen = [];
      for(let i=0;i<size;i++){
        const rar = pickRarity(weights);
        const card = pickCardByRarity(rar, used) || pickCardByRarity('Comune', used);
        if(!card) break;
        used.add(card.id);
        chosen.push(card);
      }
      if(guarantee) chosen = ensureAtLeastRare(chosen);

      // Placeholders in scena
      const cardsEls = renderPackPlaceholders(chosen.length);

      // Reveal
      if(mode==='all'){
        // Riempi e gira tutte insieme
        chosen.forEach((c, i)=> revealCard(cardsEls[i], c));
      }else{
        // Sequenziale: una ogni ~450ms
        for(let i=0;i<chosen.length;i++){
          await new Promise(r=> setTimeout(r, i===0? 300: 450));
          revealCard(cardsEls[i], chosen[i]);
        }
      }

      // Messaggio di esito
      const counts = chosen.reduce((acc,c)=>{ acc[c.rarity]=(acc[c.rarity]||0)+1; return acc; },{});
      const summary = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${v}√ó ${k}`).join(' ‚Ä¢ ');
      $('#log').textContent = `Pacchetto: ${summary}`;

      openBtn.disabled = false;
    }

    // ============== Init
    $('#openBtn').addEventListener('click', openPack);
    // Apri subito un pacchetto per demo
    loadData().then(openPack);
  </script>
</body>
</html>

<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Open Pack â€“ TOTS Fix</title>
  <style>
    :root{
      --bg:#0b0f1a;--panel:#121a2b;--muted:#7b8aa8;--accent:#37d3ff;--ok:#22c55e;--warn:#f59e0b;--txt:#e6edf7;
      --card-w:170px;--card-h:250px;--r:16px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,#13203a 0,#0b0f1a 40%),var(--bg);color:var(--txt);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
    .wrap{max-width:1100px;margin-inline:auto;padding:24px}
    header{display:flex;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:18px}
    .title{font-size:clamp(18px,2.4vw,24px);font-weight:700;letter-spacing:.2px}

    /* scelte pacchetti */
    .choices{display:flex;gap:10px;flex-wrap:wrap}
    .choice{appearance:none;border:1px solid #223150;background:linear-gradient(180deg,#172342,#0f1730);color:var(--txt);padding:8px 14px;border-radius:999px;cursor:pointer;transition:.2s transform,.2s background,.2s border-color}
    .choice:hover{transform:translateY(-1px)}
    .choice[aria-selected="true"]{background:linear-gradient(180deg,#173e6b,#0e294b);border-color:#2a7bbf;box-shadow:0 0 0 2px #0b2a48 inset}

    .pill{margin-left:auto;display:inline-flex;align-items:center;gap:10px;background:linear-gradient(180deg,#183a2b,#0d241a);border:1px solid #1f5a40;color:#d2ffe7;padding:8px 12px;border-radius:999px}
    .pill .dot{width:8px;height:8px;border-radius:999px;background:var(--ok)}

    /* area pack */
    .panel{background:linear-gradient(180deg,#111a2e,#0c1322);border:1px solid #1b2a49;border-radius:20px;padding:18px}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .btn{appearance:none;border:1px solid #264e7a;background:linear-gradient(180deg,#144168,#0d2a44);color:#e7f5ff;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(var(--card-w),1fr));gap:14px}

    /* carta */
    .card{position:relative;width:var(--card-w);height:var(--card-h);perspective:1000px;margin-inline:auto}
    .inner{position:absolute;inset:0;transform-style:preserve-3d;transition:transform .7s cubic-bezier(.2,.7,.1,1)}
    .card.revealed .inner{transform:rotateY(180deg)}
    .face{position:absolute;inset:0;backface-visibility:hidden;border-radius:var(--r);overflow:hidden;border:1px solid #2a3a66;box-shadow:0 10px 30px rgba(0,0,0,.45);background:linear-gradient(180deg,#132038,#0e1527)}
    .face img{width:100%;height:100%;object-fit:cover;display:block;image-rendering:auto}
    .back{transform:rotateY(180deg)}

    .hint{color:var(--muted);font-size:14px;margin-top:6px}
  .face.loading::after{content:"";position:absolute;inset:0;animation:shimmer 1.2s linear infinite;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);}
    @keyframes shimmer{from{transform:translateX(-100%)}to{transform:translateX(100%)}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Apertura Pacchetti</div>
      <div class="choices" id="choices" role="tablist" aria-label="Tipo pacchetto">
        <button class="choice" role="tab" data-pack="random" aria-selected="true">Random</button>
        <button class="choice" role="tab" data-pack="tots">TOTS</button>
        <button class="choice" role="tab" data-pack="wonderkid">Wonderkid</button>
      </div>
      <div class="pill" id="pricePill" title="Prezzo pacchetto">
        <span class="dot"></span>
        <span><strong id="priceVal">1000</strong> crediti</span>
      </div>
    </header>

    <section class="panel">
      <div class="toolbar">
        <div>
          <button class="btn" id="openBtn">Apri pacchetto</button>
        </div>
        <div class="hint">Suggerimento: clicca una carta per girarla</div>
      </div>
      <div class="grid" id="grid" aria-live="polite"></div>
    </section>
  </div>

  <script>
    // --- Utility robusta per confrontare stringhe serie ---
    const norm = v => String(v ?? '').trim().toLowerCase();
    const seriesIs = (c, v) => norm(c.series) === norm(v);

    // --- Config pacchetti ---
    const PACKS = {
      random: { price: 1000, filter: _ => true },
      tots: { price: 1400, filter: c => seriesIs(c, 'Tots') },
      wonderkid: { price: 1600, filter: c => seriesIs(c, 'Wonderkid') }
    };

    const BACK_BY_SERIES = {
      tots: 'Deck%20back%20Tots.png',
      wonderkid: 'Deck%20back%20wonderkid.png',
      oro: 'Deck%20back%20ORO.png' // default
    };

    // --- Stato ---
    const state = {
      selectedPack: 'random',
      allCards: [],
      pool: []
    };

    // --- Elementi ---
    const $choices = document.getElementById('choices');
    const $priceVal = document.getElementById('priceVal');
    const $grid = document.getElementById('grid');
    const $openBtn = document.getElementById('openBtn');

    // --- Carica JSON una sola volta ---
    async function loadCards(){
      if(state.allCards.length) return state.allCards;
      try{
        const res = await fetch('cards.json',{cache:'no-store'});
        if(!res.ok) throw new Error('Impossibile caricare cards.json');
        const data = await res.json();
        // Accettiamo sia array semplice che oggetto {cards:[...]}
        const arr = Array.isArray(data) ? data : (Array.isArray(data.cards) ? data.cards : []);
        state.allCards = arr;
        return arr;
      }catch(err){
        console.error(err);
        alert('Errore nel caricamento delle carte. Controlla cards.json');
        return [];
      }
    }

    // --- UI: selezione pacchetto (FIX spread) ---
    $choices.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('.choice');
      if(!btn) return;
      const next = btn.dataset.pack;
      if(!PACKS[next]) return;

      // FIX: spread corretto per rimuovere selezione precedente
      [...$choices.querySelectorAll('.choice')].forEach(c => c.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');

      state.selectedPack = next;
      $priceVal.textContent = PACKS[next].price;
      // Aggiorna il pool appena l'utente cambia pack
      buildPool();
    });

    function buildPool(){
      const def = PACKS[state.selectedPack];
      state.pool = state.allCards.filter(def.filter);
    }

    // --- Utilities ---
    function randInt(n){ return Math.floor(Math.random()*n); }

    function pickMany(arr, n){
      if(arr.length <= n) return [...arr];
      const copy = [...arr];
      const out = [];
      for(let i=0;i<n;i++) out.push(copy.splice(randInt(copy.length),1)[0]);
      return out;
    }

    // Crea DOM carta con fronte/retro
    function createCardEl(card){
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="inner">
          <div class="face front loading"><img alt="${(card.name||'')}" loading="lazy" referrerpolicy="no-referrer"></div>
          <div class="face back"><img alt="Retro" loading="lazy"></div>
        </div>`;
      const front = el.querySelector('.front img');
      const back = el.querySelector('.back img');

      // --- immagini ---
      const PLACEHOLDER =
        'data:image/svg+xml;utf8,'+
        encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="340" height="500">
          <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#18243f"/><stop offset="1" stop-color="#0f1a2e"/></linearGradient></defs>
          <rect width="100%" height="100%" fill="url(#g)"/>
          <g fill="#5da9ff" font-family="system-ui,Segoe UI,Roboto" font-size="20" opacity=".9">
            <text x="50%" y="50%" text-anchor="middle">Immagine non disponibile</text>
          </g>
        </svg>`);

      const rawUrl = card.img || card.image || '';
      const safeUrl = rawUrl ? encodeURI(rawUrl) : '';
      const s = norm(card.series);
      back.src = s && BACK_BY_SERIES[s] ? BACK_BY_SERIES[s] : BACK_BY_SERIES.oro;

      // Precarica per evitare carte invisibili se il download fallisce/lenta
      front.style.visibility = 'hidden';
      const wrapperFront = el.querySelector('.front');

      const img = new Image();
      img.referrerPolicy = 'no-referrer';
      img.loading = 'lazy';
      img.decoding = 'async';
      img.onload = () => {
        front.src = img.src;
        front.style.visibility = '';
        wrapperFront.classList.remove('loading');
      };
      img.onerror = () => {
        // Fallback: placeholder visibile, mai carta "invisibile"
        front.src = PLACEHOLDER;
        front.style.visibility = '';
        wrapperFront.classList.remove('loading');
      };
      img.src = safeUrl || PLACEHOLDER;

      // interazione: click per girare
      el.addEventListener('click', ()=>{
        el.classList.toggle('revealed');
      });
      return el;
    }

    async function openPack(){
      $openBtn.disabled = true;
      try{
        await loadCards();
        buildPool();
        const pool = state.pool.length ? state.pool : state.allCards;
        if(!pool.length){
          alert('Nessuna carta disponibile nel pool.');
          return;
        }
        // scegli 5 carte
        const drawn = pickMany(pool, 5);

        // reset griglia
        $grid.innerHTML = '';
        const els = drawn.map(createCardEl);
        els.forEach(el => $grid.appendChild(el));

        // animazione rivelazione ritardata
        setTimeout(()=>{
          els.forEach((el, i)=> setTimeout(()=> el.classList.add('revealed'), i*140));
        }, 300);
      } finally {
        // riabilita pulsante dopo un attimo per evitare doppi click
        setTimeout(()=> $openBtn.disabled = false, 800);
      }
    }

    $openBtn.addEventListener('click', openPack);

    // bootstrap
    (async function init(){
      await loadCards();
      buildPool();
    })();
  </script>
</body>
</html>

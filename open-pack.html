<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantaballa – Open Pack</title>
  <meta name="description" content="Pack opening con flash dorato, click-to-flip, glow per rarità, particelle, suoni e screenshot. Include anteprime pacchetti e prezzi. Usa cards.json (series=Wonderkid/Tots)." />

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- (RIMOSSO: html2canvas non più necessario per lo screenshot) -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script> -->

  <style>
    :root{ --bg:#0b0f19; --panel:#0f1526; --card:#121a2e; --card-2:#0d1325; --text:#ecf0ff; --muted:#a7b0d3; --accent:#6ee7ff; --radius:18px; --g-comune:rgba(154,163,178,.30); --g-non-comune:rgba(52,211,153,.35); --g-rara:rgba(96,165,250,.45); --g-epica:rgba(167,139,250,.55); --g-ultra-rara:rgba(251,191,36,.65); --g-season:rgba(239,68,68,.7) }
    *{box-sizing:border-box} html,body{height:100%}
    body{ margin:0; background: radial-gradient(1200px 800px at 10% -10%, #132040, transparent), var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow-x:hidden }
    a{color:var(--accent); text-decoration:none}
    header{ position:sticky; top:0; z-index:20; backdrop-filter: blur(10px); background:linear-gradient(180deg, rgba(13,19,37,.9), rgba(13,19,37,.6)); border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:1200px; margin:0 auto; padding:20px}
    .title{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    h1{margin:0; font-size:clamp(20px,3.6vw,34px)} .subtitle{color:var(--muted)}
    .toolbar{display:flex; gap:12px; margin-top:14px; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:var(--text)}
    .btn{background:linear-gradient(180deg,#1b2a4d,#152141); border:1px solid rgba(110,231,255,.35); border-radius:12px; color:#fff; padding:12px 16px; cursor:pointer}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* FLASH */
    .flash-line,.flash-screen{position:fixed; inset:0; pointer-events:none; z-index:40; opacity:0} /* FIX: aggiunto il punto davanti a flash-screen */
    .flash-line::before{content:""; position:absolute; top:0; bottom:0; width:32vw; background:linear-gradient(90deg,transparent,rgba(255,230,120,.55),rgba(255,201,44,.8),rgba(255,230,120,.55),transparent); filter:blur(8px); transform:translateX(-40vw) skewX(-12deg)}
    .flash-line.active{animation:sweep .75s ease-out forwards}
    @keyframes sweep{0%{opacity:0}10%{opacity:1}100%{opacity:1}}
    .flash-line.active::before{animation:sweepMove .75s ease-out forwards}
    @keyframes sweepMove{to{transform:translateX(120vw) skewX(-12deg)}}
    .flash-screen{background:radial-gradient(circle at 50% 50%, rgba(255,232,120,.45), transparent 55%)}
    .flash-screen.active{animation:flash .35s ease-out forwards}
    @keyframes flash{0%{opacity:0}30%{opacity:1}100%{opacity:0}}

    /* CHOICES (anteprime pacchetti) */
    .choices{ display:flex; gap:14px; margin-top:12px; flex-wrap:wrap }
    .choice{ display:flex; align-items:center; gap:10px; padding:8px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03); border-radius:14px; cursor:pointer; }
    .choice[aria-selected="true"]{ outline:2px solid rgba(110,231,255,.5); background:rgba(255,255,255,.06) }
    .prev{
      width:90px; aspect-ratio: 690/987; border-radius:12px;
      background-size:cover; background-position:center;
      box-shadow:0 6px 16px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.08);
    }
    .meta{ display:flex; flex-direction:column; line-height:1.15 }
    .meta .name{ font-weight:700 }
    .meta .price{ color:var(--muted); font-size:12px }

    /* PACK */
    .packArea{display:flex; align-items:center; justify-content:center; min-height:min(76vh,900px); position:relative}
    .pack{
      width:min(520px,86vw); aspect-ratio:690/987;
      background: center/cover no-repeat;  /* impostata da JS */
      border-radius:var(--radius); box-shadow:0 8px 24px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.08);
      transition:transform .2s ease, box-shadow .2s ease, filter .2s ease; position:relative; isolation:isolate; will-change:transform,filter
    }
    .pack:hover{ transform:translateY(-2px); box-shadow:0 20px 60px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.12); filter:brightness(1.05)}
    .pack.shake{animation:shake .35s ease-in-out 1}
    @keyframes shake{0%,100%{transform:translateX(0) rotate(0)}25%{transform:translateX(-6px) rotate(-1deg)}50%{transform:translateX(5px) rotate(1deg)}75%{transform:translateX(-3px) rotate(-.6deg)}}
    .pack.opening{animation:packOpen .9s cubic-bezier(.16,.84,.29,1) forwards}
    @keyframes packOpen{0%{transform:scale(1) translateY(0); opacity:1}55%{transform:scale(.92) translateY(6px); filter:brightness(1.08)}75%{transform:scale(1.02) translateY(-6px); filter:brightness(1.25)}100%{transform:scale(.88) translateY(-12px); opacity:0}}

    /* STAGE */
    .stageWrap{display:none}
    .stageWrap.show{display:block; animation:stageIn .5s ease .25s both}
    @keyframes stageIn{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:none}}
    .stage{margin:22px 0 40px; display:grid; gap:16px; grid-template-columns:repeat(1,minmax(0,1fr))}
    @media(min-width:720px){.stage{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1100px){.stage{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .cCard{position:relative; width:100%; aspect-ratio:690/987; border-radius:var(--radius); transform-style:preserve-3d; perspective:1200px}
    .scene{position:absolute; inset:0; border-radius:inherit; transform-style:preserve-3d; transition:transform .7s cubic-bezier(.22,.75,.2,1); transform:rotateY(0deg); box-shadow:0 10px 28px rgba(0,0,0,.45); background:var(--card); will-change:transform}
    .face{position:absolute; inset:0; border-radius:inherit; overflow:hidden; backface-visibility:hidden; border:1px solid rgba(255,255,255,.08); display:flex; align-items:center; justify-content:center}
    .back img, .front img { width:100%; height:100%; object-fit:cover; display:block; aspect-ratio:690/987; }
    .front{ transform:rotateY(180deg) }
    .cCard.revealed .scene{ transform:rotateY(180deg) }

    .veil{ position:absolute; inset:0; pointer-events:none; opacity:0; background:radial-gradient(120% 120% at 50% -20%, rgba(255,255,255,.12), transparent 55%) }
    .cCard.revealed .veil{ animation:veil .6s ease both } @keyframes veil{from{opacity:0}to{opacity:1}}
    .spark{ position:absolute; inset:-14% -14%; pointer-events:none; opacity:0; background:conic-gradient(from 0deg at 50% 50%, rgba(255,255,255,.22), transparent 40%, rgba(255,255,255,.22) 80%, transparent) }
    .cCard.revealed .spark{ animation:spark 1.1s ease .05s both } @keyframes spark{0%{opacity:0; transform:scale(.9) rotate(0)}100%{opacity:1; transform:scale(1) rotate(1turn)}}

    .badge{ position:absolute; top:10px; left:10px; padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06) }
    .front .badge{ right:10px; left:auto }
    .front .badge[data-rarity="Comune"]{ background:var(--g-comune) }
    .front .badge[data-rarity="Non Comune"]{ background:var(--g-non-comune) }
    .front .badge[data-rarity="Rara"]{ background:var(--g-rara) }
    .front .badge[data-rarity="Epica"]{ background:var(--g-epica) }
    .front .badge[data-rarity="Ultra Rara"]{ background:var(--g-ultra-rara) }
    .front .badge[data-rarity="Season"]{ background:var(--g-season) }

    .rays{ position:absolute; inset:-18%; pointer-events:none; opacity:0; background: conic-gradient(from 0deg at 50% 50%, rgba(255,230,120,.12), transparent 40%, rgba(255,230,120,.12) 80%, transparent) }
    .cCard.is-final .rays{ animation:rays 1.2s ease .15s both } @keyframes rays{0%{opacity:0; transform:scale(.8) rotate(0)}100%{opacity:1; transform:scale(1) rotate(1turn)}}

    .drop{ transform:translateY(10px); opacity:0 }
    .drop.in{ animation:drop .5s ease both } @keyframes drop{to{transform:none; opacity:1}}

    .log{margin-top:8px; font-size:13px; color:var(--muted)}
    footer{border-top:1px solid rgba(255,255,255,.06); background:linear-gradient(0deg, rgba(13,19,37,.85), rgba(13,19,37,.6))}
    .foot{max-width:1200px; margin:0 auto; padding:12px 20px; font-size:13px; color:var(--muted)}
    .pillFoot{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03)}

    @media(max-width:600px){.wrap{padding:12px} .stage{grid-template-columns:1fr}}

    /* Share modal (fallback desktop) */
    .shareModal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50; background:rgba(0,0,0,.45)}
    .shareModal.show{display:flex}
    .shareCard{background:var(--panel); border:1px solid rgba(255,255,255,1); border-radius:16px; padding:16px; width:min(520px,92vw); box-shadow:0 12px 40px rgba(0,0,0,.5)}
    .shareHeader{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
    .shareRow{display:flex; gap:8px; flex-wrap:wrap}
    .shareItem{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); border-radius:12px}
    .shareActions{display:flex; gap:8px; margin-top:12px; justify-content:flex-end}
    .inputLike{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.03); color:var(--text)}
  </style>
</head>
<body>
  <div class="flash-line" id="flashLine" aria-hidden="true"></div>
  <div class="flash-screen" id="flashScreen" aria-hidden="true"></div>

  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>Open Pack – Fantaballa</h1>
          <div class="subtitle">Scegli il pacchetto → flash dorato → carte in ordine di rarità (click to flip).</div>
        </div>
        <span class="pill" id="pricePill">💰 Costo: 1000</span>
        <span class="pill" id="pointsBadge">Punti: —</span> <!-- FIX: aggiunto badge -->
        <button id="openBtn" class="btn">🎁 Apri pacchetto</button>
        <button id="shareBtn" class="btn" disabled>🔗 Condividi pacchetto</button>
        <a href="https://pavoniingrifati.github.io/vetrina-carte/" class="btn">🏠 Torna alla Home</a>
      </div>

      <div class="toolbar">
        <span class="pill" id="fairnessNote">🎲 Probabilità bilanciate • Garanzia Rara+ attiva</span>
      </div>

      <!-- Anteprime pacchetti -->
      <div class="choices" id="choices"></div>

      <div class="log" id="log" role="status" aria-live="polite"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="packArea" id="packArea">
      <div class="pack" id="pack" title="Apri pacchetto"></div>
    </section>

    <section class="stageWrap" id="stageWrap">
      <div id="stage" class="stage" aria-live="polite"></div>
    </section>
  </main>

  <footer>
    <div class="foot">
      <span class="pillFoot">ℹ️Prossimo aggiornamento: Collezione carte.</span>
    </div>
  </footer>

  <!-- Template carta -->
  <template id="tplCard">
    <article class="cCard drop" data-state="back">
      <div class="rays"></div>
      <div class="scene">
        <div class="face back">
          <img src="Deck%20back%20ORO.png" alt="Retro carta" loading="eager" decoding="async" />
        </div>
        <div class="face front">
          <span class="badge"></span>
          <img alt="" loading="lazy" decoding="async">
        </div>
      </div>
      <div class="veil"></div>
      <div class="spark"></div>
    </article>
  </template>

  <!-- Share Fallback Modal -->
  <div class="shareModal" id="shareModal" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="shareCard">
      <div class="shareHeader">
        <strong>Condividi pacchetto</strong>
        <button type="button" class="btn" id="closeShare">✖️ Chiudi</button>
      </div>
      <div class="shareRow" style="margin-bottom:10px">
        <a class="shareItem" id="waShare" target="_blank" rel="noopener">WhatsApp</a>
        <a class="shareItem" id="xShare" target="_blank" rel="noopener">X (Twitter)</a>
        <a class="shareItem" id="fbShare" target="_blank" rel="noopener">Facebook</a>
        <a class="shareItem" id="tgShare" target="_blank" rel="noopener">Telegram</a>
      </div>
      <input class="inputLike" id="shareLink" readonly />
      <div class="shareActions">
        <button type="button" class="btn" id="copyLink">📋 Copia</button>
        <button type="button" class="btn" id="shareOk">OK</button>
      </div>
    </div>
  </div>

  <!-- Firebase (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // Config
    const firebaseConfig = {
      apiKey: "AIzaSyDv23gasgBuAtPeDJeztyJ5P2S7NWq1svo",
      authDomain: "fantaball-9e19c.firebaseapp.com",
      projectId: "fantaball-9e19c",
      storageBucket: "fantaball-9e19c.appspot.com",
      messagingSenderId: "683304379837",
      appId: "1:683304379837:web:d2bbe7a814e2e40e075ed4",
      measurementId: "G-C8Q8K5B52C"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  </script>

  <script type="module">
    // 1) db prima di tutto
    const db = firebase.firestore();

    // === Auth helpers (open-pack) ===
    async function ensureGoogleUser() {
      const auth = firebase.auth();
      const u = auth.currentUser;
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: 'select_account' });

      try {
        if (!u) {
          const { user } = await auth.signInWithPopup(provider);
          await user.getIdToken(true);
          return user;
        }
        if (u.isAnonymous) {
          const { user } = await u.linkWithPopup(provider);
          await user.getIdToken(true);
          return user;
        }
        await u.getIdToken(true);
        return u;
      } catch (e) {
        // Fallback Safari / popup bloccati
        if (e.code === 'auth/popup-blocked' || e.code === 'auth/operation-not-supported-in-this-environment') {
          if (!u) { await firebase.auth().signInWithRedirect(provider); throw new Error('redirecting'); } // FIX
          if (u.isAnonymous) { await u.linkWithRedirect(provider); throw new Error('redirecting'); }       // FIX
        }
        throw e;
      }
    }

    // === Wallet (open-pack) ===
    async function ensureWallet10() {
      const uid = firebase.auth().currentUser.uid;
      const ref = db.collection('users').doc(uid);
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) {
          const now = firebase.firestore.FieldValue.serverTimestamp();
          tx.set(ref, { points: 10, createdAt: now, updatedAt: now });
        }
      });
    }

    async function getPoints() {
      const uid = firebase.auth().currentUser.uid;
      const snap = await db.collection('users').doc(uid).get();
      return snap.exists ? (snap.data().points || 0) : 0;
    }

    async function debitOnePointOrThrow() {
      const uid = firebase.auth().currentUser.uid;
      const ref = db.collection('users').doc(uid);
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        const pts = snap.exists ? (snap.data().points || 0) : 0;
        if (pts <= 0) throw new Error('no-points');
        const now = firebase.firestore.FieldValue.serverTimestamp();
        tx.update(ref, { points: pts - 1, updatedAt: now });
      });
    }

    // === Badge punti (near "Apri pacchetto") ===
    const pointsBadge = document.getElementById('pointsBadge');
    const openBtn = document.getElementById('openBtn');
    let unsubPoints = null;

    async function initPointsUI() {
      try {
        const user = await ensureGoogleUser();
        if (user.isAnonymous) {
          pointsBadge.textContent = 'Accedi con Google';
          openBtn.disabled = true;
          return;
        }
        await ensureWallet10();
        const ref = db.collection('users').doc(user.uid);
        if (unsubPoints) unsubPoints();
        unsubPoints = ref.onSnapshot((snap) => {
          const pts = snap.exists ? (snap.data().points || 0) : 0;
          pointsBadge.textContent = `Punti: ${pts}`;
          openBtn.disabled = pts <= 0;
        });
      } catch (e) {
        if (e.message === 'redirecting') return;
        console.error('[initPointsUI]', e);
        if (pointsBadge) pointsBadge.textContent = 'Punti: —';
        if (openBtn) openBtn.disabled = true;
      }
    }
    initPointsUI(); /* una sola volta all’avvio */  /* :contentReference[oaicite:6]{index=6} */

    // helper per ID documento sicuro
    const safeDocId = (id) =>
      String(id || Math.random().toString(36).slice(2))
        .replace(/[\/#?\[\]]/g, '_')
        .slice(0, 120);

    // Salva le carte estratte nell’inventario dell’utente
    async function saveInventario(cards) {
      const u = firebase.auth().currentUser;
      if (!u || u.isAnonymous) throw new Error('login-required');

      const batch = db.batch();
      const now = firebase.firestore.FieldValue.serverTimestamp();

      for (const c of cards) {
        const ref = db.collection('users').doc(u.uid).collection('inventory').doc(safeDocId(c.id));
        batch.set(ref, {
          name: c.name,
          rarity: c.rarity,
          series: c.series || '',
          img: c.img || '',
          count: firebase.firestore.FieldValue.increment(1),
          updatedAt: now
        }, { merge: true });
      }

      await batch.commit();
    }

    /* =======================
       Config / Dati / Utilità
       ======================= */
    const CONFIG = {
      COUNT: 5,
      FAIR_RARE_PLUS: true,
      CARDS_JSON: 'cards.json',
      FETCH_TIMEOUT_MS: 4500
    };

    const DEFAULT_PACK_KEY = 'wonderkid';
    const PACKS = {
      wonderkid: {
        key: 'wonderkid',
        label: 'Wonderkid Pack',
        cost: 1000,
        back: 'Deck%20back%20wonderkid.png',
        filter: c => String(c.series||'').trim().toLowerCase()==='wonderkid'
      },
      tots: {
        key: 'tots',
        label: 'TOTS Pack',
        cost: 1000,
        back: 'Deck%20back%20Tots.png',
        filter: c => String(c.series||'').trim().toLowerCase()==='tots'
      },
      gold: {
        key: 'gold',
        label: 'Gold Pack',
        cost: 1000,
        back: 'Deck%20back%20ORO.png',
        filter: _ => true
      }
    };

    const FALLBACK_CARDS = [
      {id:'c1',  name:'Base 1',      rarity:'Comune',     img:'Deck%20back%20ORO.png'},
      {id:'c2',  name:'Base 2',      rarity:'Non Comune', img:'Deck%20back%20ORO.png'},
      {id:'r3',  name:'Base 3',      rarity:'Rara',       img:'Deck%20back%20ORO.png'},
      {id:'r4',  name:'Base 4',      rarity:'Epica',      img:'Deck%20back%20ORO.png'},
      {id:'u5',  name:'Base 5',      rarity:'Ultra Rara', img:'Deck%20back%20ORO.png'},
      {id:'s6',  name:'Base 6',      rarity:'Season',     img:'Deck%20back%20ORO.png'},
    ];

    // === Utilità
    const $ = (s,el=document)=>el.querySelector(s);
    const delay = ms => new Promise(r=>setTimeout(r,ms));
    const rarityRank={'Comune':0,'Non Comune':1,'Rara':2,'Epica':3,'Ultra Rara':4,'Season':5};
    const norm = v => String(v||'').trim().toLowerCase();

    // Audio opzionale
    let audioCtx=null;
    function ensureAudio(){ try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)() }catch{} }
    function tone(f,d=.15,g=.08,t='sine'){ if(!audioCtx) return; const o=audioCtx.createOscillator(),A=audioCtx.createGain(); o.type=t; o.frequency.value=f; A.gain.value=g; o.connect(A).connect(audioCtx.destination); o.start(); A.gain.setTargetAtTime(0,audioCtx.currentTime+d,.3); o.stop(audioCtx.currentTime+d+.08) }
    function noiseBoom(d=.5,g=.15){ if(!audioCtx) return; const N=audioCtx.sampleRate*d, b=audioCtx.createBuffer(1,N,audioCtx.sampleRate), x=b.getChannelData(0); for(let i=0;i<N;i++) x[i]=(Math.random()*2-1)*Math.pow(1-i/N,2); const s=audioCtx.createBufferSource(); s.buffer=b; const A=audioCtx.createGain(); A.gain.value=g; const F=audioCtx.createBiquadFilter(); F.type='lowpass'; F.frequency.value=400; s.connect(F).connect(A).connect(audioCtx.destination); s.start(); A.gain.setTargetAtTime(0,audioCtx.currentTime+d*.7,2) }
    function playByRarity(r){ if(r==='Comune'||r==='Non Comune'){ tone(520,.07,.06,'triangle'); tone(660,.07,.05,'triangle') } else if(r==='Rara'){ tone(660,.12,.08,'sine'); tone(880,.16,.06,'sine') } else if(r==='Epica'){ tone(660,.18,.09,'sine'); tone(990,.22,.08,'sine'); tone(1320,.24,.06,'sine') } else if(r==='Ultra Rara'||r==='Season'){ noiseBoom(.7,.18); tone(880,.18,1,'square'); tone(1320,.22,.08,'square') } }

    class PackOpener{
      constructor(){
        this.ALL=[]; this.used=new Set();
        this.currentPackKey = DEFAULT_PACK_KEY;

        this.$openBtn=$('#openBtn'); this.$shareBtn=$('#shareBtn');
        this.$packArea=$('#packArea'); this.$pack=$('#pack');
        this.$flashLine=$('#flashLine'); this.$flashScreen=$('#flashScreen');
        this.$stageWrap=$('#stageWrap'); this.$stage=$('#stage'); this.$log=$('#log');
        this.$pricePill=$('#pricePill'); this.$choices=$('#choices');

        this.bind(); this.prewarm();
        this.renderChoices();
        this.applyPackVisual();
      }
      bind(){
        this.$openBtn.addEventListener('click',()=>this.doOpen());
        this.$pack.addEventListener('click',()=>this.$openBtn.click(),{passive:true});
        this.$shareBtn.addEventListener('click',()=>this.doShare());
        ['click','keydown','touchstart'].forEach(e=>window.addEventListener(e,()=>{ensureAudio()}, {once:true}));
      }
      prewarm(){
        // Precarica immagini retro
        ['Deck%20back%20ORO.png','Deck%20back%20Tots.png','Deck%20back%20wonderkid.png'].forEach(src=>{ const im=new Image(); im.decoding='async'; im.src=src; });
        this.loadData().catch(()=>{});
      }
      async loadData(){
        if(this.ALL.length) return;
        const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),CONFIG.FETCH_TIMEOUT_MS);
        try{
          const res=await fetch(CONFIG.CARDS_JSON,{cache:'no-store',signal:ctrl.signal});
          if(!res.ok) throw new Error(`HTTP ${res.status}`);
          const json=await res.json();
          if(!Array.isArray(json)) throw new Error('Formato non valido (atteso array)');
          const cleaned=[]; const ids=new Set();
          for(const c of json){
            if(!c||typeof c!=='object') continue;
            const id=c.id??`${c.name||'card'}-${Math.random().toString(36).slice(2,8)}`;
            const name=String(c.name||'');
            const rarity=String(c.rarity||'');
            const img=String(c.img||'');
            const series=String(c.series||'');
            if(!name||!rarity||!img) continue;
            if(ids.has(id)) continue; ids.add(id);
            cleaned.push({id,name,rarity,img,series});
          }
          if(!cleaned.length) throw new Error('Nessuna carta valida in cards.json');
          this.ALL=cleaned; this.$log.textContent=`Caricate ${this.ALL.length} carte.`;
        }catch(err){
          console.warn('cards.json non caricato, uso fallback:', err?.message||err);
          this.ALL = FALLBACK_CARDS;
          this.$log.textContent='⚠️ Non trovo cards.json, uso carte di esempio.';
        }finally{ clearTimeout(t) }
      }

      // UI anteprime
      renderChoices(){
        const frag=document.createDocumentFragment();
        Object.values(PACKS).forEach(p=>{
          const btn=document.createElement('button');
          btn.type='button';
          btn.className='choice';
          btn.setAttribute('data-pack',p.key);
          btn.setAttribute('aria-selected', String(p.key===this.currentPackKey));
          btn.innerHTML = `
            <div class="prev" style="background-image:url('${p.back}')"></div>
            <div class="meta">
              <span class="name">${p.label}</span>
              <span class="price">Costo: ${p.cost}</span>
            </div>`;
          btn.addEventListener('click', ()=>{
            this.currentPackKey = p.key;
            this.updatePrice();
            this.applyPackVisual();
            // aggiorna evidenziazione
            [...this.$choices.querySelectorAll('.choice')].forEach(c=>c.setAttribute('aria-selected','false')); /* FIX: spread corretto */
            btn.setAttribute('aria-selected','true');
          });
          frag.appendChild(btn);
        });
        this.$choices.innerHTML='';
        this.$choices.appendChild(frag);
        this.updatePrice();
      }
      updatePrice(){
        const pack=PACKS[this.currentPackKey];
        this.$pricePill.textContent = `💰 Costo: ${pack.cost}`;
      }
      applyPackVisual(){
        const pack=PACKS[this.currentPackKey];
        this.$pack.style.backgroundImage = `url('${pack.back}')`;
      }

      pickRarity(){
        const E=Object.entries(CONFIG.WEIGHTS||{'Comune':40,'Non Comune':30,'Rara':18,'Epica':8,'Ultra Rara':3,'Season':1});
        const tot=E.reduce((s,[,w])=>s+w,0);
        let r=Math.random()*tot;
        for(const [rar,w] of E){ if(r<w) return rar; r-=w }
        return 'Comune'
      }
      pickCardByRarity(rarity, pool){
        let candidates = pool.filter(c => c.rarity===rarity && !this.used.has(c.id));
        if(!candidates.length) candidates = pool.filter(c => !this.used.has(c.id));
        if(!candidates.length) candidates = pool; // permetti duplicati se serve
        if(!candidates.length) return null;
        return candidates[Math.floor(Math.random()*candidates.length)];
      }
      ensureRarePlus(cards, pool){
        const ok=cards.some(c=>rarityRank[c.rarity] >= rarityRank['Rara']);
        if(ok) return cards;
        const rarePool = pool.filter(c=>rarityRank[c.rarity] >= rarityRank['Rara']);
        if(!rarePool.length) return cards;
        const i=Math.floor(Math.random()*cards.length);
        cards[i] = rarePool[Math.floor(Math.random()*rarePool.length)];
        return cards;
      }

      makeCardEl(d,isFinal){
        const tpl=document.getElementById('tplCard');
        const n=tpl.content.firstElementChild.cloneNode(true);
        const back=n.querySelector('.back img'); const front=n.querySelector('.front img'); const badge=n.querySelector('.badge');
        front.alt=d.name||''; back.alt='Retro carta';
        badge.dataset.rarity=d.rarity; badge.textContent=d.rarity;
        front.src=d.img||''; // verrà rivelata su flip
        if(isFinal) n.classList.add('is-final');
        n.addEventListener('click',()=>{ if(n.dataset.state!=='front'){ this.revealCard(n,d) } }, {passive:true});
        return n;
      }
      addSparks(cont,n=12){
        const frag=document.createDocumentFragment();
        for(let i=0;i<n;i++){
          const s=document.createElement('i');
          const x=10+Math.random()*80, xEnd=x+(-8+Math.random()*16), rot=-15+Math.random()*30;
          s.style.setProperty('--x',x+'%'); s.style.setProperty('--xEnd',xEnd+'%'); s.style.setProperty('--rot',rot+'deg');
          s.style.left=x+'%'; s.style.top=(5+Math.random()*20)+'%';
          frag.appendChild(s)
        }
        cont.appendChild(frag)
      }
      revealCard(n,d){
        const front=n.querySelector('.front img');
        if(front && !front.src) front.src=d.img||'';
        n.dataset.state='front'; n.classList.add('revealed');
        const rank=rarityRank[d.rarity]??0;
        this.addSparks(n,Math.min(6+rank*4,28));
        playByRarity(d.rarity)
      }
      setDropIn(el,i,extra=0){ el.classList.add('drop'); setTimeout(()=>el.classList.add('in'),120*i+extra) }
      showStage(cards){
        const wrap=this.$stageWrap, stage=this.$stage;
        stage.innerHTML=''; wrap.classList.add('show');
        const last=cards.length-1; const frag=document.createDocumentFragment();
        cards.forEach((c,i)=>{ const el=this.makeCardEl(c,i===last); frag.appendChild(el); this.setDropIn(el,i) });
        stage.appendChild(frag);
        this.$shareBtn.disabled=false;
        this.$log.textContent='Pacchetto pronto (ordine per rarità). Tocca le carte per rivelarle.';
      }

      async doOpen(){
        const BTN=this.$openBtn, SHARE=this.$shareBtn; BTN.disabled=true; SHARE.disabled=true;
        this.$log.textContent='Preparazione pacchetto…';
        await this.loadData(); if(!this.ALL.length){ this.$log.textContent='Nessuna carta disponibile'; BTN.disabled=false; return }

        const pack = PACKS[this.currentPackKey];
        const pool = this.ALL.filter(pack.filter);
        if(!pool.length){ this.$log.textContent='⚠️ Nessuna carta compatibile con questo pacchetto (controlla "series").'; BTN.disabled=false; SHARE.disabled=true; return }

        // === FIX: Gate Login + Punti (prima dell’animazione)
        try {
          const user = await ensureGoogleUser();
          await user.getIdToken(true);
          await ensureWallet10();
          await debitOnePointOrThrow();
        } catch (e) {
          if (e.message === 'redirecting') return;
          if (e.message === 'no-points') {
            const pts = await getPoints().catch(()=>0);
            this.$log.textContent = `⛔ Punti insufficienti (hai ${pts}).`;
          } else {
            this.$log.textContent = `⚠️ Errore: ${e.code || e.message}`;
            console.error(e);
          }
          BTN.disabled=false; SHARE.disabled=true; return;
        }
        // === Fine gate

        this.$pack.classList.add('shake'); await delay(360); this.$pack.classList.remove('shake');
        this.$flashLine.classList.add('active'); this.$flashScreen.classList.add('active'); this.$pack.classList.add('opening');
        await delay(900); this.$packArea.style.display='none';

        // helper: comodo per riconoscere la series "Oggetto"
        const isOggetto = c => String(c?.series || '').trim().toLowerCase() === 'oggetto';

        this.used.clear();
        let chosen = [];
        let hasOggetto = false;

        for (let i = 0; i < (CONFIG.COUNT||5); i++) {
          let card = null;
          let safety = 0;

          while (safety++ < 50) {
            const rar = this.pickRarity();
            const c = this.pickCardByRarity(rar, pool);
            if (!c) break;
            if (isOggetto(c) && hasOggetto) continue;
            card = c; break;
          }

          if (!card) break;
          if (isOggetto(card)) hasOggetto = true;
          this.used.add(card.id);
          chosen.push(card);
        }

        if (CONFIG.FAIR_RARE_PLUS) chosen = this.ensureRarePlus(chosen, pool);

        // Cintura e bretelle: se ensureRarePlus avesse inserito una 2ª Oggetto, rimpiazza.
        (()=>{
          const oggIdx = chosen.map((c,i)=>[i,c]).filter(([,c])=>isOggetto(c)).map(([i])=>i);
          if (oggIdx.length>1){
            for (let k=1;k<oggIdx.length;k++){
              const i=oggIdx[k];
              const targetRar = chosen[i].rarity;
              let repl = pool.find(c=>!isOggetto(c) && c.rarity===targetRar && !this.used.has(c.id));
              if (!repl) repl = pool.find(c=>!isOggetto(c) && !this.used.has(c.id));
              if (repl){ this.used.add(repl.id); chosen[i]=repl; }
            }
          }
        })();

        chosen.sort((a,b)=>rarityRank[a.rarity]-rarityRank[b.rarity]);
        this.showStage(chosen); /* FIX: rimossa la doppia chiamata */

        // Salvataggio inventario
        try {
          await saveInventario(chosen);
          const pts = await getPoints();
          this.$log.innerHTML = `✅ Pacchetto salvato. Punti rimasti: <b>${pts}</b>. <a href="my-cards.html">Vai alle mie carte →</a>`;
        } catch (e) {
          this.$log.textContent = `⚠️ Errore nel salvataggio: ${e.code || e.message}`;
          console.error(e);
        }
      }

      // === Condivisione
      async doShare(){
        const shareData = {
          title: 'Fantaballa – Il mio pacchetto',
          text: 'Guarda il pacchetto che ho aperto su Fantaballa!',
          url: window.location.href
        };

        if (navigator.share) {
          try {
            await navigator.share(shareData);
            return;
          } catch (err) {
            console.warn('Condivisione annullata o fallita', err);
          }
        }
        this.openShareFallback(shareData);
      }

      openShareFallback(shareData){
        const modal = $('#shareModal');
        const linkInput = $('#shareLink');
        const closeBtn = $('#closeShare');
        const okBtn = $('#shareOk');
        const copyBtn = $('#copyLink');
        const wa = $('#waShare'), x = $('#xShare'), fb = $('#fbShare'), tg = $('#tgShare');

        const url = encodeURIComponent(shareData.url);
        const text = encodeURIComponent(shareData.text);

        wa.href = `https://api.whatsapp.com/send?text=${text}%20${url}`;
        x.href  = `https://twitter.com/intent/tweet?text=${text}&url=${url}`;
        fb.href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        tg.href = `https://t.me/share/url?url=${url}&text=${text}`;

        linkInput.value = shareData.url;

        const close = ()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true') };
        closeBtn.onclick = close; okBtn.onclick = close;

        copyBtn.onclick = async ()=>{
          try{
            await navigator.clipboard.writeText(shareData.url);
            copyBtn.textContent = '✅ Copiato';
            setTimeout(()=>copyBtn.textContent='📋 Copia',1200);
          }catch{
            copyBtn.textContent = '❌ Errore';
            setTimeout(()=>copyBtn.textContent='📋 Copia',1200);
          }
        };

        modal.classList.add('show'); modal.setAttribute('aria-hidden','false');
      }
    }

    window.addEventListener('DOMContentLoaded',()=>{ new PackOpener() })
  </script>
</body>
</html>

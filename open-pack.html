<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantaballa ‚Äì Open Pack</title>
  <meta name="description" content="Simulatore apertura pacchetti con retro personalizzato, animazioni e glow (dati da cards.json)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f19;
      --panel: #0f1526; 
      --card: #121a2e;
      --card-2: #0d1325;
      --text: #ecf0ff;
      --muted: #a7b0d3;
      --accent: #6ee7ff;
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% -10%, #132040, transparent), var(--bg);
      color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    a{color:var(--accent); text-decoration:none}
    header{
      position:sticky; top:0; z-index:100; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(13,19,37,.9), rgba(13,19,37,.6));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto; padding: 20px;}
    .title{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{font-size: clamp(20px, 3.6vw, 34px); margin:0}
    .subtitle{color:var(--muted); margin-top:6px}

    .toolbar{display:grid; grid-template-columns: 1fr auto; gap:12px; margin-top:16px;}
    .pill{
      display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:var(--text)
    }
    .btn{
      background: linear-gradient(180deg, #1b2a4d, #152141);
      border:1px solid rgba(110,231,255,.35);
      border-radius:12px; color:white; padding:12px 16px; cursor:pointer;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* Griglia tavolo pack */
    .stage{margin:22px 0 40px; display:grid; gap:16px; grid-template-columns: repeat(1, minmax(0,1fr))}
    @media(min-width:700px){.stage{grid-template-columns: repeat(2, minmax(0,1fr))}}
    @media(min-width:1100px){.stage{grid-template-columns: repeat(3, minmax(0,1fr))}}

    /* Carta 690x987 */
    .card{
      position:relative; border-radius: var(--radius);
      width: 100%; aspect-ratio: 690 / 987; /* proporzione reale */
      transform-style: preserve-3d;
      transition: transform .7s cubic-bezier(.22,.75,.2,1), filter .3s ease, box-shadow .3s ease;
      cursor: pointer;
      box-shadow: 0 12px 24px rgba(0,0,0,.45);
      perspective: 1200px;
      --rarGlow: rgba(255,255,255,.25); /* base */
      --revealGlow: rgba(110,231,255,.45); /* modificata al reveal */
      --glowSize: 36px;
    }
    .card:hover{ transform: translateY(-2px) rotateX(3deg) rotateY(-3deg); }

    .scene{
      position:absolute; inset:0; border-radius: var(--radius);
      transform: translateZ(0); transform-style: preserve-3d;
    }

    .face{
      position:absolute; inset:0; border-radius:var(--radius); overflow:hidden;
      backface-visibility: hidden;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,0) 60%), var(--card);
      display:flex; align-items:center; justify-content:center;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.06),
        0 22px 50px rgba(0,0,0,.5),
        0 0 var(--glowSize) var(--revealGlow);
      transform: rotateY(0deg);
      transition: box-shadow .35s ease;
    }

    /* Retro con la tua immagine */
    .back{
      background: none; /* useremo l'img */
    }
    .back img{
      width: 100%; height: 100%; object-fit: cover;
      aspect-ratio: 690 / 987; display:block;
      filter: drop-shadow(0 10px 30px rgba(0,0,0,.45));
      transform: translateZ(1px);
      pointer-events: none;
    }

    /* Fronte */
    .front{
      transform: rotateY(180deg);
      display:grid; grid-template-rows: auto 1fr auto;
      background: var(--card);
    }
    .front img{
      width:100%; height:100%; object-fit:cover; aspect-ratio: 690 / 987; background:#0b0f19;
    }
    .front .name{ padding:10px 12px 0; font-weight:600 }
    .front .meta{ padding:10px 12px 12px; font-size:13px; color:#aeb7d9; display:flex; gap:8px; flex-wrap:wrap }

    /* Badge rarit√† */
    .badge{
      position:absolute; top:10px; right:10px; z-index:2;
      padding:6px 8px; border-radius:999px; font-size:12px; font-weight:700; color:white;
      border:1px solid rgba(255,255,255,.15);
      transform: translateZ(3px);
    }
    .r-comune      .badge{ background: rgba(154,163,178,.85)}
    .r-non-comune  .badge{ background: rgba(52,211,153,.85)}
    .r-rara        .badge{ background: rgba(96,165,250,.85)}
    .r-ultra-rara  .badge{ background: rgba(251,191,36,.9); color:#000}
    .r-epica       .badge{ background: rgba(167,139,250,.9)}
    .r-season      .badge{ background: rgba(239,68,68,.9)}

    /* Glow per rarit√† */
    .r-comune      { --rarGlow: rgba(154,163,178,.35) }
    .r-non-comune  { --rarGlow: rgba(52,211,153,.35) }
    .r-rara        { --rarGlow: rgba(96,165,250,.35) }
    .r-ultra-rara  { --rarGlow: rgba(251,191,36,.45) }
    .r-epica       { --rarGlow: rgba(167,139,250,.45) }
    .r-season      { --rarGlow: rgba(239,68,68,.55) }

    /* Stati flip */
    .card[data-state="back"] .scene{ transform: rotateY(0deg); }
    .card[data-state="front"] .scene{ transform: rotateY(180deg); }
    .card.revealing{
      animation: pop .45s ease-out;
    }
    @keyframes pop{
      0%{ transform: scale(.96) }
      60%{ transform: scale(1.02) }
      100%{ transform: scale(1) }
    }

    /* Bagliore al reveal */
    .burst::after{
      content:""; position:absolute; inset:-6px; border-radius:inherit; pointer-events:none;
      box-shadow: 0 0 42px var(--revealGlow), 0 0 86px var(--rarGlow);
      opacity:0; animation: burst .7s ease-out forwards;
    }
    @keyframes burst{
      0%{ opacity:.85 }
      100%{ opacity:0 }
    }

    .log{ margin-top:8px; font-size:13px; color:var(--muted); }

    footer{border-top:1px solid rgba(255,255,255,.06); background:linear-gradient(0deg, rgba(13,19,37,.85), rgba(13,19,37,.6)); position:sticky; bottom:0}
    .foot{max-width:1200px; margin:0 auto; padding:12px 20px; font-size:13px; color:var(--muted)}
    .pillFoot{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03)}

    @media (max-width: 600px) {
      .wrap { padding: 12px; }
      .toolbar { grid-template-columns: 1fr; }
      .stage { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>Open Pack ‚Äì Fantaballa</h1>
          <div class="subtitle">Retro personalizzato ‚Ä¢ 6 carte ‚Ä¢ flip sequenziale</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <a href="index.html" class="pill">‚¨ÖÔ∏è Torna alla vetrina</a>
        </div>
      </div>

      <div class="toolbar" aria-label="Comandi">
        <div class="pill">üé≤ Probabilit√† bilanciate ‚Ä¢ Garanzia Rara+ attiva</div>
        <button id="openBtn" class="btn">üéÅ Apri un pacchetto</button>
      </div>
      <div class="log" id="log"></div>
    </div>
  </header>

  <main class="wrap">
    <section id="stage" class="stage" aria-live="polite"></section>
  </main>

  <footer>
    <div class="foot">
      <span class="pillFoot">‚ÑπÔ∏è Assicurati di caricare anche ‚ÄúDeck back ORO.png‚Äù accanto a questo file.</span>
    </div>
  </footer>

  <template id="tplCard">
    <div class="card r-comune" data-state="back">
      <div class="scene">
        <div class="face back">
          <!-- Retro (immagine tua). Se rinomini il file, aggiorna qui il src -->
          <img src="Deck%20back%20ORO.png" alt="Retro carta" />
        </div>
        <div class="face front">
          <div class="badge"></div>
          <img alt="">
          <div class="name"></div>
          <div class="meta"></div>
        </div>
      </div>
    </div>
  </template>

  <script>
    // ===== Utils
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const delay = ms => new Promise(r=>setTimeout(r, ms));
    const randGlow = () => {
      const colors = [
        'rgba(110,231,255,0.55)',
        'rgba(251,191,36,0.55)',
        'rgba(167,139,250,0.55)',
        'rgba(52,211,153,0.55)',
        'rgba(239,68,68,0.55)',
        'rgba(96,165,250,0.55)'
      ];
      return colors[Math.floor(Math.random()*colors.length)];
    };

    // ===== Dati
    let ALL = [];
    async function loadData(){
      try{
        const res = await fetch('cards.json', { cache:'no-store' });
        if(!res.ok) throw new Error('cards.json non trovato');
        ALL = await res.json();
      }catch(e){
        console.error(e);
        ALL = [];
      }
    }

    // ===== Probabilit√†
    const WEIGHTS = { 'Season':1, 'Ultra Rara':3, 'Epica':6, 'Rara':10, 'Non Comune':20, 'Comune':60 };
    function pickRarity(){
      const entries = Object.entries(WEIGHTS);
      const tot = entries.reduce((s,[,w])=>s+w,0);
      let r = Math.random()*tot;
      for(const [rar,w] of entries){ if(r < w) return rar; r -= w; }
      return 'Comune';
    }
    function pickCardByRarity(rarity, used){
      let pool = ALL.filter(c => c.rarity===rarity && !used.has(c.id));
      if(!pool.length) pool = ALL.filter(c => !used.has(c.id));
      if(!pool.length) return null;
      return pool[Math.floor(Math.random()*pool.length)];
    }
    function ensureRarePlus(cards){
      const ok = cards.some(c => ['Rara','Epica','Ultra Rara','Season'].includes(c.rarity));
      if(ok) return cards;
      const pool = ALL.filter(c => ['Rara','Epica','Ultra Rara','Season'].includes(c.rarity));
      if(!pool.length) return cards;
      const i = Math.floor(Math.random()*cards.length);
      cards[i] = pool[Math.floor(Math.random()*pool.length)];
      return cards;
    }

    // ===== Rendering
    function makePlaceholder(){
      const node = $('#tplCard').content.firstElementChild.cloneNode(true);
      node.dataset.state = 'back';
      // glow iniziale pi√π soft
      node.style.setProperty('--revealGlow', 'rgba(255,255,255,0.08)');
      return node;
    }
    function renderPlaceholders(n){
      const stage = $('#stage'); stage.innerHTML = '';
      for(let i=0;i<n;i++) stage.appendChild(makePlaceholder());
      return $$('#stage .card');
    }

    function applyRarityStyling(cardEl, rarity){
      const slug = (rarity||'').toLowerCase().replace(/\s+/g,'-');
      cardEl.classList.remove('r-comune','r-non-comune','r-rara','r-ultra-rara','r-epica','r-season');
      if(slug) cardEl.classList.add('r-'+slug);
    }

    function revealCard(cardEl, data){
      // rarit√†, badge e contenuti
      applyRarityStyling(cardEl, data.rarity);
      cardEl.querySelector('.badge').textContent = data.rarity;
      const img = cardEl.querySelector('.front img');
      img.src = data.img; img.alt = `Carta ${data.name}`;
      cardEl.querySelector('.name').textContent = data.name;
      cardEl.querySelector('.meta').textContent = `${data.game} ‚Ä¢ ${data.series} ‚Ä¢ ${data.role || '‚Äî'}`;

      // glow casuale miscelato con glow rarit√†
      cardEl.style.setProperty('--revealGlow', `color-mix(in oklab, ${randGlow()} 60%, var(--rarGlow, rgba(255,255,255,.25)))`);

      // flip + effetti
      cardEl.classList.add('revealing','burst');
      cardEl.dataset.state = 'front';
      setTimeout(()=> cardEl.classList.remove('burst'), 750);

      // tap per ribaltare avanti/indietro
      cardEl.addEventListener('click', ()=>{
        const st = cardEl.dataset.state === 'front' ? 'back' : 'front';
        cardEl.dataset.state = st;
      });
    }

    async function openPack(){
      const BTN = $('#openBtn');
      BTN.disabled = true; $('#log').textContent = 'Estrazione in corso‚Ä¶';

      if(!ALL.length) await loadData();
      if(!ALL.length){
        $('#log').textContent = 'Nessuna carta trovata in cards.json';
        BTN.disabled = false; return;
      }

      const PACK_SIZE = 6;
      const used = new Set();
      let chosen = [];
      for(let i=0;i<PACK_SIZE;i++){
        const rar = pickRarity();
        const card = pickCardByRarity(rar, used) || pickCardByRarity('Comune', used);
        if(!card) break;
        used.add(card.id);
        chosen.push(card);
      }
      chosen = ensureRarePlus(chosen);

      const cardsEls = renderPlaceholders(chosen.length);

      // reveal sequenziale con flip (tutte partono col retro)
      for(let i=0;i<chosen.length;i++){
        await delay(i===0 ? 350 : 480);
        revealCard(cardsEls[i], chosen[i]);
      }

      // riepilogo
      const counts = chosen.reduce((acc,c)=>{ acc[c.rarity]=(acc[c.rarity]||0)+1; return acc; },{});
      const summary = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${v}√ó ${k}`).join(' ‚Ä¢ ');
      $('#log').textContent = `Pacchetto: ${summary}`;

      BTN.disabled = false;
    }

    // init
    $('#openBtn').addEventListener('click', openPack);
    // auto-apri un pacchetto all‚Äôavvio per demo
    loadData().then(openPack);
  </script>
</body>
</html>

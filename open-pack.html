<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantaballa ‚Äì Open Pack</title>
  <meta name="description" content="Simulatore apertura pacchetti con rarit√†, animazioni e reveal automatico (dati locali da cards.json)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f19;
      --panel: #0f1526; 
      --card: #121a2e;
      --card-2: #0d1325;
      --text: #ecf0ff;
      --muted: #a7b0d3;
      --accent: #6ee7ff;
      --radius: 16px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% -10%, #132040, transparent), var(--bg);
      color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    a{color:var(--accent); text-decoration:none}

    header{
      position:sticky; top:0; z-index:100; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(13,19,37,.9), rgba(13,19,37,.6));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto; padding: 20px;}
    .title{display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{font-size: clamp(20px, 3.6vw, 34px); margin:0}
    .subtitle{color:var(--muted); margin-top:6px}

    /* Toolbar impostazioni pack */
    .toolbar{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:16px;}
    @media (min-width: 980px){ .toolbar{grid-template-columns: .7fr .7fr 1fr auto} }
    .control{
      background: linear-gradient(180deg, #121a2e, #0d1325);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px; color: var(--text);
      padding:12px 14px; display:flex; align-items:center; gap:12px;
    }
    .control input[type="number"], .control select{
      flex:1; background:transparent; border:none; color:var(--text); outline:none;
    }
    .btn{
      background: linear-gradient(180deg, #1b2a4d, #152141);
      border:1px solid rgba(110,231,255,.35);
      border-radius:12px; color:white; padding:12px 16px; cursor:pointer;
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* Tavolo pack: layout elastico, centrato */
    .stage{
      margin:22px 0 40px; display:grid; gap:18px;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      justify-items:center; align-items:start;
    }

    /* Carta: contenitore a 690√ó987 (si riduce su mobile) */
    .card{
      position:relative; border-radius: var(--radius);
      transform-style: preserve-3d; transition: transform .6s ease;
      width: 690px;                /* larghezza desktop */
      aspect-ratio: 690/987;       /* mantiene il rapporto corretto */
      max-width: 100%;             /* su schermi stretti si riduce */
      cursor: default;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
      --glow: #6ee7ff;
    }

    .card.flip{ transform: rotateY(180deg); }
    .face{
      position:absolute; inset:0; border-radius:var(--radius); overflow:hidden;
      backface-visibility: hidden;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,0) 60%), var(--card);
      display:flex; align-items:center; justify-content:center;
    }
    .back{
      background: radial-gradient(800px 500px at 20% -10%, rgba(110,231,255,.18), transparent), var(--card-2);
      border:1px solid rgba(110,231,255,.28);
      box-shadow: inset 0 0 40px rgba(110,231,255,.22), 0 14px 40px rgba(0,0,0,.5);
      font-weight:700; letter-spacing:.5px; color:#a7e9ff;
    }
    .front{ transform: rotateY(180deg); display:grid; grid-template-rows: auto 1fr auto }

    /* IMMAGINE: tutta visibile, senza tagli */
    .front img{
      width: 100%;
      height: 100%;
      object-fit: contain;   /* nessun taglio/zoom */
      background:#0b0f19;
      display:block;
    }

    .front .meta{ padding:10px 12px; font-size:13px; color:#aeb7d9; display:flex; gap:8px; flex-wrap:wrap }
    .front .name{ padding:10px 12px 0; font-weight:600 }
    .badge{
      position:absolute; top:10px; right:10px; z-index:2;
      padding:6px 8px; border-radius:999px; font-size:12px; font-weight:700; color:white;
      border:1px solid rgba(255,255,255,.15);
    }

    /* Colori badge per rarit√† */
    .r-comune      .badge{ background: rgba(154,163,178,.85)}
    .r-non-comune  .badge{ background: rgba(52,211,153,.85)}
    .r-rara        .badge{ background: rgba(96,165,250,.85)}
    .r-ultra-rara  .badge{ background: rgba(251,191,36,.9); color:#000}
    .r-epica       .badge{ background: rgba(167,139,250,.9)}
    .r-season      .badge{ background: rgba(239,68,68,.9)}

    /* Glow bordo per rarit√† */
    .r-comune      { box-shadow: 0 0 0 1px rgba(154,163,178,.35), 0 12px 30px rgba(0,0,0,.45) }
    .r-non-comune  { box-shadow: 0 0 0 1px rgba(52,211,153,.35), 0 12px 30px rgba(0,0,0,.45) }
    .r-rara        { box-shadow: 0 0 0 1px rgba(96,165,250,.35), 0 12px 30px rgba(0,0,0,.45) }
    .r-ultra-rara  { box-shadow: 0 0 0 1px rgba(251,191,36,.45), 0 12px 30px rgba(0,0,0,.45) }
    .r-epica       { box-shadow: 0 0 0 1px rgba(167,139,250,.45), 0 12px 30px rgba(0,0,0,.45) }
    .r-season      { box-shadow: 0 0 0 1px rgba(239,68,68,.55), 0 12px 30px rgba(0,0,0,.45) }

    /* --- Animazioni: ventaglio all‚Äôentrata + glow pulse + flash --- */
    .fan{
      transform: translateY(10px) rotate(calc(var(--r, 0deg)));
      opacity: 0; animation: fanIn .6s ease forwards var(--delay, 0ms);
      filter: drop-shadow(0 20px 40px rgba(0,0,0,.5));
    }
    @keyframes fanIn {
      from { opacity: 0; transform: translateY(20px) rotate(calc(var(--r, 0deg) - 6deg)); }
      to   { opacity: 1; transform: translateY(0) rotate(var(--r, 0deg)); }
    }
    .pulse{ animation: glow 1.2s ease-in-out infinite; }
    @keyframes glow{
      0%,100%{ box-shadow: 0 0 0 0 rgba(110,231,255,.0), 0 12px 30px rgba(0,0,0,.45) }
      50%{    box-shadow: 0 0 20px 6px rgba(110,231,255,.25), 0 12px 30px rgba(0,0,0,.45)}
    }
    .flash::after{
      content:''; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(closest-side, rgba(255,255,255,.75), transparent 60%);
      opacity:0; transform: scale(.8);
      animation: flash .6s ease forwards;
    }
    @keyframes flash{ 0%{opacity:0} 20%{opacity:1} 100%{opacity:0; transform:scale(1)} }

    /* Ultima carta: animazione speciale (pi√π lenta + flash pi√π forte + zoom-in) */
    .last-card {
      animation: lastZoom 1s ease forwards;
    }
    @keyframes lastZoom {
      0% { transform: scale(0.9) rotateY(180deg); opacity: 0; }
      40% { opacity: 1; }
      100% { transform: scale(1) rotateY(180deg); opacity: 1; }
    }
    .flash-strong::after{
      content:''; position:absolute; inset:0; pointer-events:none;
      background: radial-gradient(closest-side, rgba(255,255,255,.95), transparent 60%);
      opacity:0; transform: scale(.8);
      animation: flashStrong .9s ease forwards;
    }
    @keyframes flashStrong { 0%{opacity:0} 25%{opacity:1} 100%{opacity:0; transform:scale(1)} }

    .log{ margin-top:8px; font-size:13px; color:var(--muted); }

    footer{border-top:1px solid rgba(255,255,255,.06); background:linear-gradient(0deg, rgba(13,19,37,.85), rgba(13,19,37,.6)); position:sticky; bottom:0}
    .foot{max-width:1200px; margin:0 auto; padding:12px 20px; font-size:13px; color:var(--muted)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03)}

    /* Mobile tweaks */
    @media (max-width: 700px) {
      .wrap { padding: 10px; }
      .toolbar { overflow-x: auto; display:flex; gap:8px; }
      .toolbar > * { flex:0 0 auto }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>Open Pack ‚Äì Fantaballa</h1>
          <div class="subtitle">Simulatore apertura pacchetti (semplice demo in sviluppo, usa <code>cards.json</code>)</div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <a href="index.html" class="pill">‚¨ÖÔ∏è Torna alla vetrina</a>
        </div>
      </div>

      <div class="toolbar" aria-label="Impostazioni pacchetto">
        <div class="control">
          Dimensione pacchetto
          <input id="packSize" type="number" min="3" max="12" value="6" />
        </div>
        <div class="control">
          Garanzia Rara+
          <select id="guarantee">
            <option value="1" selected>Attiva</option>
            <option value="0">Disattiva</option>
          </select>
        </div>
        <div class="control" title="Probabilit√† predefinite: Comune 60, Non Comune 20, Rara 10, Epica 6, Ultra 3, Season 1">
          Preset probabilit√†
          <select id="weightsPreset">
            <option value="default" selected>Standard</option>
            <option value="juicy">Pi√π ricco</option>
            <option value="harsh">Pi√π raro</option>
          </select>
        </div>
        <button id="openBtn" class="btn">üéÅ Apri pacchetto</button>
      </div>
      <div class="log" id="log"></div>
    </div>
  </header>

  <main class="wrap">
    <section id="stage" class="stage" aria-live="polite"></section>
  </main>

  <footer>
    <div class="foot">
      <span class="pill">‚ÑπÔ∏è Demo: nessun backend. I risultati non vengono salvati online.</span>
    </div>
  </footer>

  <template id="tplCard">
    <div class="card fan pulse">
      <div class="face back">‚Ä¢ ‚Ä¢ ‚Ä¢</div>
      <div class="face front">
        <div class="badge"></div>
        <img alt="">
        <div class="name"></div>
        <div class="meta"></div>
      </div>
    </div>
  </template>

  <script>
    // ============== Utils
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // ============== Caricamento dati
    let ALL = [];
    async function loadData(){
      try{
        const res = await fetch('cards.json', { cache:'no-store' });
        if(!res.ok) throw new Error('cards.json non trovato');
        ALL = await res.json();
      }catch(e){
        console.error(e);
        ALL = [];
      }
    }

    // ============== Pesi rarit√†
    function getWeights(preset){
      if(preset==='juicy')   return { 'Season':2, 'Ultra Rara':5, 'Epica':8, 'Rara':15, 'Non Comune':25, 'Comune':45 };
      if(preset==='harsh')   return { 'Season':1, 'Ultra Rara':2, 'Epica':4, 'Rara':8,  'Non Comune':15, 'Comune':70 };
      return { 'Season':1, 'Ultra Rara':3, 'Epica':6, 'Rara':10, 'Non Comune':20, 'Comune':60 };
    }

    const RANK = { 'Comune':1, 'Non Comune':2, 'Rara':3, 'Epica':4, 'Ultra Rara':5, 'Season':6 };

    function pickRarity(weights){
      const entries = Object.entries(weights);
      const total = entries.reduce((s,[,w])=>s+w,0);
      let r = Math.random()*total;
      for(const [rar,w] of entries){
        if(r < w) return rar;
        r -= w;
      }
      return 'Comune';
    }

    function pickCardByRarity(rarity, usedIds=new Set()){
      let pool = ALL.filter(c => (c.rarity === rarity) && !usedIds.has(c.id));
      if(!pool.length) pool = ALL.filter(c => !usedIds.has(c.id));
      if(!pool.length) return null;
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function ensureAtLeastRare(cards){
      const hasRarePlus = cards.some(c => RANK[c.rarity] >= RANK['Rara']);
      if(hasRarePlus) return cards;
      const pool = ALL.filter(c => RANK[c.rarity] >= RANK['Rara']);
      if(!pool.length) return cards;
      const idx = Math.floor(Math.random()*cards.length);
      cards[idx] = pool[Math.floor(Math.random()*pool.length)];
      return cards;
    }

    // ============== Rendering placeholders
    function makePlaceholder(){
      return $('#tplCard').content.firstElementChild.cloneNode(true);
    }

    function renderPackPlaceholders(n){
      const stage = $('#stage');
      stage.innerHTML = '';
      for(let i=0;i<n;i++){
        const ph = makePlaceholder();
        // ventaglio: angolo da -24¬∞ a +24¬∞, ritardo progressivo
        const spread = 24;
        const angle = (i/(n-1||1))*spread - (spread/2);
        ph.style.setProperty('--r', angle+'deg');
        ph.style.setProperty('--delay', (80 * i)+'ms');
        stage.appendChild(ph);
      }
      return $$('#stage .card');
    }

    function revealCard(cardEl, data, isLast=false){
      const slug = (data.rarity||'').toLowerCase().replace(/\s+/g,'-');
      if(slug) cardEl.classList.add('r-'+slug);

      cardEl.querySelector('.badge').textContent = data.rarity;
      const img = cardEl.querySelector('img');
      img.src = data.img; img.alt = `Carta ${data.name}`;
      cardEl.querySelector('.name').textContent = data.name;
      cardEl.querySelector('.meta').textContent = `${data.game} ‚Ä¢ ${data.series} ‚Ä¢ ${data.role||'‚Äî'}`;

      // reveal
      if(isLast){
        cardEl.classList.add('flash-strong');
        cardEl.classList.add('last-card'); // zoom + pi√π lenta
      }else{
        cardEl.classList.add('flash');
      }
      cardEl.classList.add('flip');
      cardEl.classList.remove('pulse');
    }

    async function openPack(){
      const openBtn = $('#openBtn');
      openBtn.disabled = true;
      $('#log').textContent = 'Estrazione in corso‚Ä¶';

      const size = Math.max(3, Math.min(12, parseInt($('#packSize').value||6,10)));
      const weights = getWeights($('#weightsPreset').value);
      const guarantee = $('#guarantee').value === '1';

      if(!ALL.length) await loadData();
      if(!ALL.length){
        $('#log').textContent = 'Nessuna carta in cards.json';
        openBtn.disabled = false;
        return;
      }

      // Estrazione
      const used = new Set();
      let chosen = [];
      for(let i=0;i<size;i++){
        const rar = pickRarity(weights);
        const card = pickCardByRarity(rar, used) || pickCardByRarity('Comune', used);
        if(!card) break;
        used.add(card.id);
        chosen.push(card);
      }
      if(guarantee) chosen = ensureAtLeastRare(chosen);

      // Porta la carta pi√π rara in ultima posizione
      if(chosen.length){
        let bestIdx = 0, bestRank = -1;
        for(let i=0;i<chosen.length;i++){
          const r = RANK[chosen[i].rarity] || 0;
          if(r > bestRank){ bestRank = r; bestIdx = i; }
        }
        const last = chosen.length - 1;
        if(bestIdx !== last){
          const tmp = chosen[last];
          chosen[last] = chosen[bestIdx];
          chosen[bestIdx] = tmp;
        }
      }

      // Placeholders + ventaglio
      const cardsEls = renderPackPlaceholders(chosen.length);

      // Reveal automatico: una ogni 520ms, ultima con attesa maggiore
      for(let i=0;i<chosen.length;i++){
        const isLast = (i === chosen.length-1);
        const delay = isLast ? 900 : 520;  // ultima pi√π lenta
        await new Promise(r=> setTimeout(r, delay));
        revealCard(cardsEls[i], chosen[i], isLast);
      }

      // Riepilogo
      const counts = chosen.reduce((acc,c)=>{ acc[c.rarity]=(acc[c.rarity]||0)+1; return acc; },{});
      const summary = Object.entries(counts)
        .sort((a,b)=> (b[1]-a[1]) || ((RANK[b[0]]||0)-(RANK[a[0]]||0)))
        .map(([k,v])=>`${v}√ó ${k}`).join(' ‚Ä¢ ');
      $('#log').textContent = `Pacchetto: ${summary}`;

      openBtn.disabled = false;
    }

    // Init
    $('#openBtn').addEventListener('click', openPack);
    loadData().then(openPack); // demo: apre subito un pacchetto
  </script>
</body>
</html>

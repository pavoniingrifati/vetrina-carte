<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Progressi Scuderie — Skill &amp; EXP (scala con Skill)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
    :root{
      --bg: #0b0d12;
      --surface: #121622;
      --card: #171C2B;
      --text: #e8ecf1;
      --muted: #a7b0c0;
      --ring: #3a435a;
      --shadow: 0 10px 30px rgba(0,0,0,.4);
      --radius: 16px;
    }
    body{ margin:0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1200px; margin:0 auto; padding:24px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding: 8px 0 12px; }
    .brand{ display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px; }
    .brand .logo{ width:42px; height:42px; display:grid; place-items:center; border-radius:12px; background: linear-gradient(135deg, #00b37e, #00624b); box-shadow: var(--shadow) }
    .brand .logo svg{ width:26px; height:26px; fill:white }
    .brand small{ display:block; color: var(--muted); font-weight:600 }

    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; margin-top:18px }
    @media (min-width:700px){ .grid{ grid-template-columns: 1fr 1fr } }
    @media (min-width:1100px){ .grid{ grid-template-columns: 1fr 1fr 1fr } }

    .card{ background: var(--card); border:3px solid var(--ring); border-radius: var(--radius); padding:16px; position:relative; overflow:hidden; box-shadow: var(--shadow); }
    .card-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px }
    .title{ font-weight:800; font-size:18px; }
    .subtitle{ color:var(--muted); font-size:13px }

    .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .tag{ font-size:12px; font-weight:700; padding:6px 8px; border-radius:999px; border:1px solid var(--ring); background: rgba(255,255,255,.02) }

    .bar{ margin-top:10px; background: var(--surface); border:1px solid var(--ring); border-radius:999px; height:12px; overflow:hidden; }
    .fill{ height:100%; background: linear-gradient(90deg, var(--accent, #00d2ff), var(--primary, #00b37e)); width:0% }

    .meta{ display:flex; justify-content:space-between; align-items:center; margin-top:8px; color:var(--muted); font-size:12px; font-weight:700 }
    .empty{ text-align:center; padding:48px 16px; color:var(--muted); border:1px dashed var(--ring); border-radius:16px; margin-top:18px }
    footer{ margin: 28px 0 48px; color:var(--muted); text-align:center; font-size:12px }
  
    .search{ display:flex; align-items:center; gap:10px }
    .search input{
      width: 260px; max-width: 100%;
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--ring);
      border-radius: 999px;
      padding: 10px 14px;
      font: inherit;
      outline: none;
      box-shadow: var(--shadow);
    }
    .search input::placeholder{ color: var(--muted) }
    @media (max-width:700px){ .search input{ width: 100% } }
    
/* Badge for name-only mode */
.badge{ display:inline-block; font-size:12px; padding:3px 8px; border-radius:999px; background: var(--surface); border:1px solid var(--ring); color: var(--muted); margin-left:8px; }
</style>
</head>
<body>
<div class="wrap">
<header>
<div class="brand">
<div aria-hidden="true" class="logo">
<svg aria-label="Logo" role="img" viewBox="0 0 24 24">
<path d="M12 2c-.7 0-1.3.36-1.67.95L8.2 6.2 4.1 7.02C3.1 7.21 2.5 8.26 2.9 9.2l1.87 4.38-.96 4.57c-.2.97.74 1.78 1.65 1.38l4.35-1.9 4.35 1.9c.91.4 1.85-.41 1.65-1.38l-.96-4.57L21.1 9.2c.4-.94-.2-1.99-1.2-2.18l-4.1-.82-2.14-3.25C13.3 2.36 12.7 2 12 2z"></path>
</svg>
</div>
<div>
  <div style="font-size:18px">Progressi Scuderie</div>
  <small>EXP scala con Skill: più forte = più EXP per livello</small>
</div>
</div>
<div class="search"><input id="filter" type="search" aria-label="Cerca scuderia" placeholder="Cerca scuderia…"/></div>
</header>

<main id="grid" class="grid" aria-live="polite"></main>
<div id="empty" class="empty" hidden>Nessuna scuderia trovata.</div>
<footer>Metti questo file nella stessa cartella di <b>scuderie.json</b>.</footer>
</div>

<script>
const EXP_URL = 'scuderie.json';      // unica fonte (nomi + EXP accumulata dalla base: Lv70 mostrato / Lv80 interno)
const BASE_START_LEVEL = 80;          // base interna per i calcoli (curva EXP invariata)
const DISPLAY_START_LEVEL = 70;       // livello mostrato come partenza
const LEVEL_OFFSET = DISPLAY_START_LEVEL - BASE_START_LEVEL; // -10
const MAX_LEVEL = 100;                // curva definita fino a 100 (interno)
const DISPLAY_MAX_LEVEL = MAX_LEVEL + LEVEL_OFFSET; // max mostrato

// Tabella: EXP necessaria per passare da (n-1) a n — identica al file piloti
const STEP_TABLE = {
  81:  400,
  82:  426,
  83:  464,
  84:  514,
  85:  576,
  86:  650,
  87:  736,
  88:  834,
  89:  944,
  90:  1066,
  91:  1200,
  92:  1346,
  93:  1504,
  94:  1674,
  95:  1856,
  96:  2050,
  97:  2256,
  98:  2474,
  99:  2704,
  100: 2946
};

// Precalcolo cumulativo (somma degli step 81..n)
const CUM = (() => {
  const arr = Array(MAX_LEVEL+1).fill(0);
  let sum = 0;
  for(let n = BASE_START_LEVEL+1; n <= MAX_LEVEL; n++){
    sum += (STEP_TABLE[n] || 0);
    arr[n] = sum;
  }
  return arr;
})();

const grid  = document.getElementById('grid');
const empty = document.getElementById('empty');
const input = document.getElementById('filter');

let ALL_TEAMS = [];

// EXP cumulativa (differenziale dalla baseline interna di Lv80) per arrivare a livello n
function expCumFrom80To(n){
  if(n <= BASE_START_LEVEL) return 0;
  if(n > MAX_LEVEL) return CUM[MAX_LEVEL]; // clamp
  return CUM[n];
}

// Data l'EXP accumulata dopo la base interna (Lv80) (accum), trova il livello
function levelFromAccum(accum){
  // Ricerca binaria su 80..MAX_LEVEL usando CUM
  let lo = BASE_START_LEVEL, hi = MAX_LEVEL;
  while(lo < hi){
    const mid = Math.ceil((lo + hi + 1) / 2);
    if(expCumFrom80To(mid) <= accum) lo = mid; else hi = mid - 1;
  }
  return lo;
}

// Colore deterministico dal nome (HSL -> HEX)
function colorFromName(name){
  let h = 0;
  for(let i=0;i<name.length;i++){ h = (h*31 + name.charCodeAt(i)) >>> 0; }
  h = h % 360;
  const s = 65; const l = 55;
  function hslToHex(h,s,l){
    s/=100; l/=100;
    const k = n => (n + h/30) % 12;
    const a = s * Math.min(l, 1-l);
    const f = n => l - a * Math.max(-1, Math.min(k(n)-3, Math.min(9-k(n), 1)));
    const toHex = x => Math.round(x*255).toString(16).padStart(2,'0');
    return `#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
  }
  return hslToHex(h,s,l);
}

async function load(){
  // Leggi scuderie.json -> nome + Exp (accumulata dopo il livello 80)
  let expList = [];
  try{
    const res = await fetch(EXP_URL, { cache: 'no-store' });
    if(res.ok){
      const raw = await res.json();
      expList = Array.isArray(raw) ? raw : (raw.exp || raw.scuderie || []);
    }
  }catch(_){}

  ALL_TEAMS = expList
    .map(e => {
      const nome = String(e.nome ?? e.Nome ?? '').trim();
      const accum = Math.max(0, Number(e.Exp ?? e.exp ?? e.EXP ?? 0) || 0); // accumulo dopo lv80
      const lvl = levelFromAccum(accum);
      const nextLvl = Math.min(MAX_LEVEL, lvl + 1);
      const displayLvl = lvl + LEVEL_OFFSET;
      const displayNextLvl = nextLvl + LEVEL_OFFSET;
      const curBase = expCumFrom80To(lvl);          // totale richiesto da 80 fino al lvl corrente
      const stepToNext = nextLvl > lvl ? (STEP_TABLE[nextLvl] || 0) : 0;
      const inLevel = accum - curBase;
      const progress = stepToNext ? Math.max(0, Math.min(100, Math.floor((inLevel / stepToNext) * 100))) : 100;
      return { nome, accum, lvl, nextLvl, displayLvl, displayNextLvl, curBase, stepToNext, inLevel, progress };
    })
    .filter(t => t.nome);

  applyFilter();
}

// Filtro per nome
function applyFilter(){
  const q = (input?.value || '').toLowerCase().trim();
  const filtered = q ? ALL_TEAMS.filter(t => t.nome.toLowerCase().includes(q)) : ALL_TEAMS.slice();
  render(filtered);
}

// Debounce input
function debounce(fn, ms){
  let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
}
if(input){ input.addEventListener('input', debounce(applyFilter, 120)); }

function render(list){
  grid.innerHTML = '';
  if(!list.length){ empty.hidden = false; return; }
  empty.hidden = true;

  for(const t of list){
    const color = colorFromName(t.nome);

    const card = document.createElement('article');
    card.className = 'card';
    card.style.borderColor = color;

    const tags = [];
    if(t.curBase > 0){
      tags.push(`<span class="tag">Cumulata da Lv${DISPLAY_START_LEVEL}: ${t.curBase.toLocaleString('it-IT')} XP</span>`);
    }
    if(t.stepToNext > 0){
      const remaining = Math.max(0, t.stepToNext - Math.max(0,t.inLevel));
      tags.push(`<span class="tag">Per salire a Lv ${t.displayNextLvl}: ${remaining.toLocaleString('it-IT')} XP</span>`);
      tags.push(`<span class="tag">Step corrente: ${t.stepToNext.toLocaleString('it-IT')} XP</span>`);
    }else{
      tags.push(`<span class="tag">Hai raggiunto il livello massimo (${DISPLAY_MAX_LEVEL})</span>`);
    }

    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="title" style="color:${color}">${escapeHtml(t.nome)}</div>
          <div class="subtitle">Livello <b>${t.displayLvl}</b> · Avanzamento livello: <b>${t.progress}%</b>
            <span class="badge">solo scuderie.json</span>
          </div>
          <div class="tags">
            ${tags.join('')}
          </div>
          <div class="bar"><div class="fill" style="width:${t.progress}%; background:${color};"></div></div>
          <div class="meta">
            <span>Progresso livello: ${t.progress}%</span>
            <span>${Math.max(0,t.inLevel).toLocaleString('it-IT')} / ${t.stepToNext.toLocaleString('it-IT')} XP</span>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(card);
  }
}

function escapeHtml(str){ return String(str ?? '').replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

load();
</script>
</body>
</html>

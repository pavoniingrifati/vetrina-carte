<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantaballa – FUT Tik Tok</title>
  <meta name="description" content="Vetrina di carte collezionabili con filtri, valutazioni e commenti (dati locali)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f19;
      --panel: #0f1526; 
      --card: #121a2e;
      --card-2: #0d1325;
      --text: #ecf0ff;
      --muted: #a7b0d3;
      --accent: #6ee7ff;
      --accent-2: #9bff9b;
      --danger: #ff6b6b;
      --ring: rgba(110,231,255,.4);
      --shadow: 0 10px 24px rgba(0,0,0,.45);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background: radial-gradient(1200px 800px at 10% -10%, #132040, transparent), var(--bg);
      color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    header{
      position:sticky; top:0; z-index:100; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(13,19,37,.9), rgba(13,19,37,.6));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto; padding: 20px;}
    .title{display:flex; gap:16px; align-items:center; justify-content:space-between;}
    h1{font-size: clamp(20px, 3.6vw, 34px); margin:0; letter-spacing:.3px}
    .subtitle{color:var(--muted); margin-top:6px}

    /* ---------- HERO NUOVI PACCHETTI ---------- */
    .hero { margin-top: 16px; }
    .hero-head {
      display:flex; align-items:center; justify-content:space-between;
      margin: 4px 2px 10px;
    }
    .hero-head h2 { font-size: clamp(16px,2.4vw,22px); margin:0; }
    .hero-viewall {
      font-size: 14px; color: var(--accent); text-decoration: none;
      border:1px solid rgba(110,231,255,.35); padding:6px 10px; border-radius:999px;
    }
    .hero-scroller{
      display:flex; gap:12px; overflow-x:auto; padding: 6px 2px 8px;
      scroll-snap-type: x mandatory;
    }
    .hero-scroller::-webkit-scrollbar{ height:8px }
    .hero-scroller::-webkit-scrollbar-thumb{ background:rgba(255,255,255,.15); border-radius:999px }

    .pack {
      position:relative; flex: 0 0 240px; scroll-snap-align: start;
      background: linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,0) 60%), var(--card);
      border:1px solid rgba(255,255,255,.08); border-radius: 16px; overflow:hidden;
      box-shadow: var(--shadow);
      transition: transform .15s ease, border-color .2s ease;
    }
    .pack:hover{ transform: translateY(-2px); border-color: rgba(110,231,255,.35); }
    .pack img{ width:100%; height:150px; object-fit:cover; background:#0b0f19; display:block }
    .pack .p-body{ padding:10px 12px }
    .pack .p-title{ font-weight:600; font-size:14px; margin:0 0 4px }
    .pack .p-meta{ font-size:12px; color:var(--muted) }
    .badge-new{
      position:absolute; top:8px; left:8px; font-size:12px; padding:6px 8px; border-radius:999px;
      background: rgba(0,0,0,.5); backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.15);
    }
    .p-cta{
      display:inline-flex; align-items:center; gap:6px; margin-top:10px;
      font-size:12px; color:var(--accent);
      border:1px solid rgba(110,231,255,.35); padding:6px 10px; border-radius:999px; text-decoration:none;
    }

    /* ---------- Toolbar / filtri ---------- */
    .toolbar{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:16px;}
    @media (min-width: 900px){
      .toolbar{grid-template-columns: 1.2fr .8fr .8fr .8fr .8fr}
    }

    .search, select, .range, button, .tag{
      background: linear-gradient(180deg, #121a2e, #0d1325);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px; color: var(--text);
      padding:12px 14px; outline:none; box-shadow: var(--shadow);
    }
    .search{display:flex; gap:10px; align-items:center}
    .search input{flex:1; background:transparent; border:none; color:var(--text)}
    .search input::placeholder{color:#98a3c7}
    select{appearance:none; background-image: linear-gradient(180deg, transparent, transparent), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat:no-repeat; background-position:right 10px center; padding-right:38px}
    /* visibilità opzioni dropdown */
    select, select option { color: var(--text); background-color: var(--card); }
    select option { padding: 8px; }

    .range{display:flex; gap:10px; align-items:center}
    .range input{width:100%}
    button.primary{background: linear-gradient(180deg, #1b2a4d, #152141); border-color: rgba(110,231,255,.35)}
    button.primary:focus, .search:focus-within, select:focus, .range:focus-within{box-shadow:0 0 0 3px var(--ring)}

    /* ---------- Cards grid ---------- */
    .grid{display:grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap:16px; margin:22px 0 80px}
    @media (min-width:600px){.grid{grid-template-columns: repeat(2, minmax(0,1fr));}}
    @media (min-width:900px){.grid{grid-template-columns: repeat(3, minmax(0,1fr));}}
    @media (min-width:1200px){.grid{grid-template-columns: repeat(4, minmax(0,1fr));}}

    .card{
      background: linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,0) 60%), var(--card);
      border:1px solid rgba(255,255,255,.08); border-radius: var(--radius); overflow:hidden; position:relative;
      transition: transform .16s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card:hover{ transform: translateY(-2px); border-color: rgba(110,231,255,.35); box-shadow:0 16px 38px rgba(0,0,0,.5)}
    .thumb{aspect-ratio: 3/4; width:100%; background:#0b0f19; object-fit:cover}
    .content{padding:12px 14px}
    .name{font-weight:600; font-size:16px}
    .meta{font-size:13px; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; margin-top:4px}
    .stars{display:flex; gap:4px; align-items:center; margin-top:8px}
    .stars button{background:none; border:none; cursor:pointer; padding:0}
    .stars .s{width:18px; height:18px; filter: drop-shadow(0 1px 2px rgba(0,0,0,.3))}
    .badge{position:absolute; top:10px; left:10px; background: rgba(0,0,0,.5); backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.15); color:white; padding:6px 8px; border-radius:999px; font-size:12px}
    .open{position:absolute; bottom:10px; right:10px}
    .tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tag{padding:6px 10px; font-size:12px; border-radius:999px; border-color: rgba(255,255,255,.12)}

    /* ---------- Modal ---------- */
    dialog{border:none; padding:0; border-radius: 18px; overflow:hidden; width:min(900px, 96vw); box-shadow:0 20px 80px rgba(0,0,0,.65)}
    dialog::backdrop{background: rgba(0,0,0,.65)}
    .modal{display:grid; grid-template-columns: 1fr; background: var(--panel)}
    @media(min-width:900px){.modal{grid-template-columns: .95fr 1.05fr}}
    .modal .left{background: radial-gradient(500px 320px at 20% 0, rgba(110,231,255,.05), transparent), var(--card-2); padding:18px}
    .modal .right{padding:18px 18px 6px}
    .modal .big{width:100%; border-radius:14px; border:1px solid rgba(255,255,255,.08); aspect-ratio:3/4; object-fit:cover}
    .modal .close{position:absolute; top:10px; right:10px; background: rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.18); padding:8px 10px; border-radius:10px; color:white}
    .field{display:grid; gap:8px; margin: 8px 0}
    textarea, input[type="text"]{background:#0d1325; border:1px solid rgba(255,255,255,.1); border-radius:10px; color:var(--text); padding:10px}
    .comment{background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)); border:1px solid rgba(255,255,255,.09); border-radius:12px; padding:10px; margin-top:10px}
    .comment .author{font-weight:600; font-size:13px}
    .comment .text{font-size:14px; color: #d9e1ff}

    footer{position:sticky; bottom:0; background:linear-gradient(0deg, rgba(13,19,37,.85), rgba(13,19,37,.6)); border-top:1px solid rgba(255,255,255,.06)}
    .foot{max-width:1200px; margin:0 auto; padding:12px 20px; font-size:13px; color:var(--muted)}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03)}

    /* ---------- Mobile tweaks ---------- */
    @media (max-width: 500px) {
      .wrap { padding: 10px; }
      .card .name { font-size: 14px; }
      .card .meta { font-size: 12px; }
      .toolbar { overflow-x: auto; display: flex; gap: 8px; padding-bottom: 6px; }
      .toolbar > * { flex: 0 0 auto; }
      dialog { width: 100%; height: 100%; border-radius: 0; }
      .modal { grid-template-columns: 1fr !important; height: 100%; }
      .modal .big { max-height: 50vh; object-fit: contain; }
      .pack{ flex-basis: 72%; }
      .pack img{ height: 130px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>Le carte FUT del canale Fantaballa!</h1>
          <div class="subtitle">Non hai ancora una carta? Segui le live su Tik Tok di Fanataballa!</div>
        </div>
      </div>

      <!-- HERO: Nuovi pacchetti -->
      <section class="hero" aria-label="Nuovi pacchetti in arrivo">
        <div class="hero-head">
          <h2>Nuovi pacchetti in arrivo</h2>
          <a id="packsViewAll" href="#" class="hero-viewall">Vedi tutti</a>
        </div>
        <div class="hero-scroller" id="packsScroller"><!-- popolato via JS --></div>
      </section>

      <div class="toolbar" aria-label="Filtri e ricerca">
        <div class="search" role="search">
          🔎 <input id="q" type="search" placeholder="Cerca per nome, serie o testo..." aria-label="Cerca" />
        </div>
        <select id="fGame" aria-label="Squadra/Gioco">
          <option value="">Tutte le squadre</option>
          <option>Fantaballa FC</option>
          <option>Gotham City</option>
          <option>Svincolato</option>
        </select>
        <select id="fRarity" aria-label="Rarità">
          <option value="">Tutte le rarità</option>
          <option>Comune</option>
          <option>Non Comune</option>
          <option>Rara</option>
          <option>Ultra Rara</option>
          <option>Epica</option>
          <option>Season</option>
        </select>
        <select id="fRole" aria-label="Ruolo">
          <option value="">Tutti i ruoli</option>
          <option>POR</option><option>DC</option><option>DS</option><option>DD</option>
          <option>MC</option><option>CC</option><option>TRQ</option>
          <option>AS</option><option>AD</option><option>ATT</option>
        </select>
        <div class="range" title="Valutazione minima">
          ⭐ Min: <input id="fRating" type="range" min="0" max="5" value="0" step="1" />
          <span id="fRatingVal">0</span>
        </div>
        <select id="fSort" aria-label="Ordina per">
          <option value="name">Ordina: Nome</option>
          <option value="rating">Ordina: Valutazione</option>
          <option value="role">Ordina: Ruolo</option>
        </select>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <footer>
    <div class="foot">
      <span class="pill">ℹ️ Mostriamo 8 carte casuali all’avvio. Usa i filtri per cercare tra tutte.</span>
    </div>
  </footer>

  <!-- Modal -->
  <dialog id="dlg">
    <form method="dialog" class="modal">
      <button class="close" aria-label="Chiudi">✕</button>
      <div class="left">
        <img id="dlgImg" alt="Immagine carta" class="big" />
      </div>
      <div class="right">
        <h2 id="dlgName" style="margin:0 0 8px"></h2>
        <div id="dlgMeta" class="meta"></div>
        <div class="stars" id="dlgStars" aria-label="Valuta questa carta"></div>
        <div class="tags" id="dlgTags"></div>

        <h3 style="margin:14px 0 6px">Commenti</h3>
        <div id="comments"></div>

        <div class="field">
          <label for="author">Nome</label>
          <input id="author" type="text" placeholder="Il tuo nome" />
        </div>
        <div class="field">
          <label for="message">Commento</label>
          <textarea id="message" rows="3" placeholder="Scrivi un commento..." ></textarea>
        </div>
        <div class="field">
          <label for="ratingSel">Voto (1-5)</label>
          <select id="ratingSel">
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
          </select>
        </div>
        <div style="display:flex; gap:10px; margin:12px 0 6px">
          <button class="primary" id="saveC">💾 Pubblica commento</button>
          <button id="clearC" type="button" title="Solo su questo dispositivo">🗑️ Svuota commenti</button>
        </div>
      </div>
    </form>
  </dialog>

  <template id="tplCard">
    <article class="card" role="article">
      <div class="badge"></div>
      <img class="thumb" alt="Immagine carta" />
      <div class="content">
        <div class="name"></div>
        <div class="meta"></div>
        <div class="stars" aria-label="Valutazione media"></div>
        <div class="tags"></div>
        <button class="primary open">Apri</button>
      </div>
    </article>
  </template>

  <script>
    const $ = sel => document.querySelector(sel);
    const esc = (s='') => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const STAR_OUT = 'M12 .587l3.668 7.431 8.2 1.192-5.934 5.787 1.401 8.169L12 18.896l-7.335 3.87 1.401-8.169L.132 9.21l8.2-1.192z';
    const starSVG = filled => `<svg class="s" viewBox="0 0 24 24" aria-hidden="true"><path d="${STAR_OUT}" fill="${filled? 'currentColor':'none'}" stroke="currentColor" stroke-width="1.5"/></svg>`;
    const avg = arr => arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length):0;
    const keyFor = (id, type) => `cardhub_${type}_${id}`;
    const loadRatings = id => JSON.parse(localStorage.getItem(keyFor(id,'ratings'))||'[]');
    const saveRating = (id,v)=> localStorage.setItem(keyFor(id,'ratings'), JSON.stringify([...loadRatings(id), v]));
    const loadComments = id => JSON.parse(localStorage.getItem(keyFor(id,'comments'))||'[]');
    const addComment = (id,c)=> localStorage.setItem(keyFor(id,'comments'), JSON.stringify([...loadComments(id), c]));
    const clearComments = id => localStorage.removeItem(keyFor(id,'comments'));

    /* ---------- HERO DATA ---------- */
    const PACKS = [
      { id:"pkm-shrouded-fable", title:"Shrouded Fable", date:"Set 2024", img:"https://images.unsplash.com/photo-1520975922284-9bcd61b6d7fe?w=1200&q=80", url:"https://tcg.pokemon.com/it-it/" },
      { id:"pkm-twilight-masquerade", title:"Twilight Masquerade", date:"Estate 2024", img:"https://images.unsplash.com/photo-1607252650355-f7fd0460ccdb?w=1200&q=80", url:"https://tcg.pokemon.com/it-it/" },
      { id:"pkm-scarlet-violet", title:"Scarlet & Violet", date:"Nuova ristampa", img:"https://images.unsplash.com/photo-1520975594083-8efc64a6e23a?w=1200&q=80", url:"https://tcg.pokemon.com/it-it/" }
    ];

    function renderPacks() {
      const box = document.getElementById('packsScroller');
      if (!box) return;
      box.innerHTML = '';
      PACKS.forEach(p => {
        const a = document.createElement('a');
        a.className = 'pack';
        a.href = p.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
        a.innerHTML = `
          <span class="badge-new">Nuovo</span>
          <img src="${p.img}" alt="Pacchetto ${p.title}">
          <div class="p-body">
            <div class="p-title">${p.title}</div>
            <div class="p-meta">${p.date}</div>
            <span class="p-cta">Scopri &rsaquo;</span>
          </div>`;
        box.appendChild(a);
      });
      const viewAll = document.getElementById('packsViewAll');
      if (viewAll) viewAll.onclick = (e)=>{ e.preventDefault(); window.open('https://tcg.pokemon.com/it-it/', '_blank'); };
    }

    /* ---------- CARDS ---------- */
    let CARDS = [];
    async function loadCards(){
      try{
        const res = await fetch('cards.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('cards.json non trovato');
        CARDS = await res.json();
      }catch(e){
        console.error('[ERRORE CARICAMENTO CARTE]', e);
        CARDS = [];
      }finally{
        renderPacks();
        applyFilters();
      }
    }

    const grid = $('#grid');
    function renderStars(container, value, onRate){
      container.innerHTML=''; const full = Math.round(value);
      for(let i=1;i<=5;i++){
        const btn = document.createElement(onRate? 'button':'div');
        btn.innerHTML = starSVG(i<=full);
        if(onRate) btn.addEventListener('click', ()=> onRate(i));
        container.appendChild(btn);
      }
      const label = document.createElement('span');
      label.textContent = value? ` ${value.toFixed(1)}/5` : ' Nessuna valutazione';
      container.appendChild(label);
    }

    function noFiltersActive(){
      return (
        !$('#q').value && !$('#fGame').value && !$('#fRarity').value &&
        !$('#fRole').value && String($('#fRating').value) === "0"
      );
    }

    function applyFilters(){
      const q = $('#q').value.trim().toLowerCase();
      const game = $('#fGame').value;
      const rarity = $('#fRarity').value;
      const role = $('#fRole').value;
      const minR = +$('#fRating').value;
      const sort = $('#fSort').value;

      let items = CARDS.map(c=>({ ...c, rating: avg(loadRatings(c.id)) }));
      if(q){ items = items.filter(c=> (c.name+" "+c.series+" "+c.text).toLowerCase().includes(q)); }
      if(game){ items = items.filter(c=> c.game===game); }
      if(rarity){ items = items.filter(c=> c.rarity===rarity); }
      if(role){ items = items.filter(c=> c.role===role); }
      if(minR>0){ items = items.filter(c=> Math.round(c.rating) >= minR); }

      items.sort((a,b)=>{
        if(sort==='rating') return (b.rating||0) - (a.rating||0);
        if(sort==='role') return (a.role||'').localeCompare(b.role||'');
        return a.name.localeCompare(b.name);
      });

      // Nessun filtro → mostra 8 casuali
      if (noFiltersActive()) items = items.slice().sort(()=>Math.random()-0.5).slice(0,8);

      renderGrid(items);
    }

    function renderGrid(items){
      grid.innerHTML='';
      if(!items.length){ grid.innerHTML = '<p style="color:var(--muted)">Nessuna carta trovata. Prova a cambiare i filtri.</p>'; return }
      const tpl = document.getElementById('tplCard');
      for(const c of items){
        const node = tpl.content.firstElementChild.cloneNode(true);
        node.querySelector('.badge').textContent = c.rarity;
        const img = node.querySelector('.thumb');
        img.src = c.img; img.loading='lazy'; img.alt = `Carta ${c.name}`;
        node.querySelector('.name').textContent = c.name;
        node.querySelector('.meta').textContent = `${c.game} • ${c.series} • ${c.role || '—'}`;
        renderStars(node.querySelector('.stars'), c.rating||0, null);
        const tags = node.querySelector('.tags');
        (c.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tags.appendChild(s);});
        node.querySelector('.open').addEventListener('click', ()=> openModal(c));
        grid.appendChild(node);
      }
    }

    // Modal
    const dlg = document.getElementById('dlg');
    const dlgImg = document.getElementById('dlgImg');
    const dlgName = document.getElementById('dlgName');
    const dlgMeta = document.getElementById('dlgMeta');
    const dlgStars = document.getElementById('dlgStars');
    const dlgTags = document.getElementById('dlgTags');
    const commentsBox = document.getElementById('comments');
    let current = null;

    function openModal(card){
      current = card;
      dlgImg.src = card.img;
      dlgName.textContent = card.name;
      dlgMeta.textContent = `${card.game} • ${card.series} • ${card.role || '—'}`;
      dlgTags.innerHTML=''; (card.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; dlgTags.appendChild(s)});
      const rating = avg(loadRatings(card.id));
      renderStars(dlgStars, rating, (v)=>{ saveRating(card.id, v); applyFilters(); openModal(card) });
      renderComments(card.id);
      dlg.showModal();
    }
    dlg.addEventListener('close', ()=>{ current=null });

    function renderComments(id){
      commentsBox.innerHTML='';
      const list = loadComments(id);
      if(!list.length){ commentsBox.innerHTML = '<div class="comment">Ancora nessun commento. Scrivi il primo! 🎉</div>'; return }
      for(const c of list.slice().reverse()){
        const div = document.createElement('div');
        div.className='comment';
        div.innerHTML = `<div class="author">${esc(c.author||'Anonimo')}</div><div class="text">${esc(c.text||'')}</div><div class="meta" style="margin-top:6px">Voto: ${'★'.repeat(c.rating)}${'☆'.repeat(5-c.rating)} • ${new Date(c.ts).toLocaleString()}</div>`;
        commentsBox.appendChild(div);
      }
    }

    document.getElementById('saveC').addEventListener('click', (e)=>{
      e.preventDefault();
      if(!current) return;
      const author = document.getElementById('author').value.trim() || 'Anonimo';
      const text = document.getElementById('message').value.trim();
      const rating = parseInt(document.getElementById('ratingSel').value,10);
      if(!text){ alert('Scrivi un commento!'); return }
      addComment(current.id, {author, text, rating, ts: Date.now()});
      saveRating(current.id, rating);
      document.getElementById('message').value='';
      renderComments(current.id);
      applyFilters();
    });

    document.getElementById('clearC').addEventListener('click', ()=>{
      if(!current) return;
      if(confirm('Sicuro di voler cancellare tutti i commenti per questa carta?')){
        clearComments(current.id);
        renderComments(current.id);
      }
    });

    ['q','fGame','fRarity','fRole','fSort'].forEach(id=> document.getElementById(id).addEventListener('input', applyFilters));
    document.getElementById('fRating').addEventListener('input', ()=>{ document.getElementById('fRatingVal').textContent=document.getElementById('fRating').value; applyFilters();});

    // Start
    loadCards();
  </script>
</body>
</html>

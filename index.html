<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantaballa – FUT Tik Tok</title>
  <meta name="description" content="Vetrina di carte collezionabili con filtri, valutazioni e commenti (dati locali)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f19;
      --panel: #0f1526; 
      --card: #121a2e;
      --card-2: #0d1325;

      --text: #e7ecff;
      --text-2: #a8b2d7;

      --radius: 14px;
      --radius-sm: 10px;

      --grad1: radial-gradient(1200px 800px at 10% -10%, #132040, transparent 60%);
      --grad2: radial-gradient(1000px 700px at 90% 110%, #1a2750, transparent 60%);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--text);
      background:
        linear-gradient(180deg, #0a0f1a, #0b1120 60%, #0a0f1a),
        var(--grad1), var(--grad2);
      background-attachment: fixed, fixed, fixed;
    }
    .wrap{max-width:1200px; margin:0 auto; padding: 0 14px}

    header{position: sticky; top:0; z-index: 20; background: rgba(10, 15, 26, .75); backdrop-filter: blur(8px); border-bottom:1px solid rgba(255,255,255,.08)}
    header .title{display:flex; align-items:center; justify-content:space-between; gap: 12px; padding: 16px 0;}
    h1{margin:0; font-size: clamp(20px, 2.2vw, 28px)}
    .subtitle{color:#a8b2d7; font-size: 14px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background: linear-gradient(180deg, #1a2240, #121a2e);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text); border-radius:999px; padding: 8px 12px; cursor:pointer;
      text-decoration:none; font-weight:600;
    }
    .pill.primary{
      background: linear-gradient(180deg, #3754ff, #2744e8);
      border-color: #6d84ff;
    }

    .toolbar{display:grid; grid-template-columns: 1fr; gap:12px; margin-top:16px;}
    @media(min-width:900px){
      .toolbar{grid-template-columns: 1.2fr .8fr .8fr .8fr .8fr}
    }
    .search{
      display:flex; align-items:center; gap:10px; padding: 8px 12px; border-radius: 999px;
      border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, #121a2e, #101629);
    }
    .search input{flex:1; background:transparent; border:none; color:var(--text)}
    .search input::placeholder{color:#98a3c7}
    select{
      appearance:none;
      background-image: linear-gradient(180deg, transparent, transparent), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M7 10l5 5 5-5z"/></svg>');
      background-repeat:no-repeat; background-position:right 10px center; padding-right:38px
    }
    select, select option { color: var(--text); background-color: var(--card); }
    select option { padding: 8px; }

    .range{display:flex; gap:10px; align-items:center}
    .range input{width:100%}

    .grid{display:grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap:clamp(12px, 2vw, 24px); margin:22px 0 80px}
    @media (min-width:600px){.grid{grid-template-columns: repeat(2, minmax(0,1fr));}}
    @media (min-width:900px){.grid{grid-template-columns: repeat(3, minmax(0,1fr));}}
    @media (min-width:1200px){.grid{grid-template-columns: repeat(4, minmax(0,1fr));}}

    /* Carte con glow + ombre */
    .card{
      background: linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,0) 60%), var(--card);
      border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      overflow:hidden; position:relative;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
      transition: transform .16s ease, box-shadow .25s ease, border-color .25s ease, filter .25s ease;
      --glow: #6ee7ff; /* default */
      opacity:0; transform: translateY(6px);
      animation: cardIn .35s ease forwards;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,0,0,.45); border-color: rgba(255,255,255,.18); }
    .card::after{
      content:""; position:absolute; inset:-2px; pointer-events:none; border-radius: inherit;
      background: radial-gradient(600px 200px at top center, color-mix(in srgb, var(--glow) 25%, transparent), transparent 40%);
      opacity:0; transition: opacity .25s ease;
    }
    .card:hover::after{ opacity:1; }

    @keyframes cardIn{ to{ opacity:1; transform: translateY(0);} }

    .badge{
      position:absolute; top:10px; left:10px; z-index:2;
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.2); color:var(--text);
      font-size: 12px; padding: 4px 8px; border-radius: 999px;
      backdrop-filter: blur(4px);
    }
    .thumb{ width:100%; aspect-ratio: 4/5; object-fit: cover; display:block; }
    .content{ padding: 10px 10px 48px; position:relative }
    .name{ font-weight:700; }
    .meta{ color:var(--text-2); font-size:13px }
    .stars{ display:flex; align-items:center; gap:6px; margin-top: 8px; }
    .stars button, .stars div{ background: none; border: none; cursor: pointer; padding: 0; }
    .open{ position:absolute; bottom:10px; right:10px }

    /* Rarità -> colore badge + glow */
    .card.r-comune      { --glow: #7dd3fc; }
    .card.r-non-comune  { --glow: #93c5fd; }
    .card.r-rara        { --glow: #60a5fa; }
    .card.r-ultra-rara  { --glow: #fbbf24; }
    .card.r-epica       { --glow: #a78bfa; }
    .card.r-season      { --glow: #ef4444; }

    .card.r-comune       .badge { background: rgba(125,211,252,0.8); }
    .card.r-non-comune   .badge { background: rgba(147,197,253,0.8); }
    .card.r-rara        .badge { background: rgba(96,165,250,0.8); }
    .card.r-ultra-rara  .badge { background: rgba(251,191,36,0.85); color: #000; }
    .card.r-epica       .badge { background: rgba(167,139,250,0.85); }
    .card.r-season      .badge { background: rgba(239,68,68,0.85); }

    .open{position:absolute; bottom:10px; right:10px}

    .tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tag{
      padding: 3px 8px; font-size: 11px; line-height: 1.2;
      border-radius: 999px; border: 1px solid rgba(255,255,255,.12);
      white-space: nowrap; margin-top: 4px;
    }

    /* ===== Modal: mobile-first, full-screen, scorrevole ===== */
    dialog{
      inset: 0; margin: 0; padding: 0; border: none;
      width: 100vw; max-width: none;
      height: 100svh; /* viewport stabile su mobile */
      height: 100dvh; /* fallback */
      background: transparent;
    }
    dialog::backdrop{ background: rgba(0,0,0,.65) }
    .modal{
      display: grid; grid-template-columns: 1fr;
      width: 100%; height: 100%;
      background: var(--panel);
    }
    @media(min-width:900px){ .modal{ grid-template-columns: .95fr 1.05fr; height: auto; max-height: 90vh; border-radius: 18px; } }

    .modal .left{ position:relative; background: var(--card-2); display:flex; align-items:center; justify-content:center; }
    .modal .left img{ max-width: 92%; height:auto; border-radius: 12px; border: 1px solid rgba(255,255,255,.12); box-shadow: 0 10px 30px rgba(0,0,0,.35) }
    .modal .right{ padding: 16px; overflow:auto }

    .modal .actions{ display:flex; flex-wrap: wrap; gap:10px; padding: 12px 16px; border-top:1px solid rgba(255,255,255,.12) }
    .modal .actions .primary{ margin-left:auto }

    .field{display:grid; gap:8px; margin: 8px 0}
    .field input, .field textarea, .field select{
      background: linear-gradient(180deg, #121a2e, #101629);
      border:1px solid rgba(255,255,255,.15);
      color:var(--text); border-radius: 10px; padding: 8px 10px;
    }
    .comment{border:1px solid rgba(255,255,255,.12); padding:10px; border-radius: 10px; background: rgba(255,255,255,.04)}
    .comment .author{ font-weight:600; }
    .comment .date{ color: var(--text-2); font-size:12px }

    /* Mobile ottimizzazioni */
    @media(max-width:599px){
      .wrap { padding: 10px; }
      .toolbar { overflow-x: auto; display: flex; gap: 8px; padding-bottom: 6px; }
      .toolbar > * { flex: 0 0 auto; }
      .card .name { font-size: 14px; }
      .card .meta { font-size: 12px; }
    }

    /* === Wishlist / Preferiti === */
    .card .fav-btn{
      position:absolute; top:8px; right:8px; z-index:3;
      background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.25);
      border-radius:999px; padding:6px 8px; cursor:pointer;
      backdrop-filter: blur(4px);
    }
    .card .fav-btn[aria-pressed="true"]{ background: rgba(255,215,0,.9); color:#000; border-color: rgba(255,215,0,1); }
    .card .fav-btn span{ font-size:14px; }

    /* === Confronto carte === */
    .card .compare-toggle{
      position:absolute; top:8px; left:8px; z-index:3;
      display:flex; align-items:center; gap:6px;
      background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.25);
      color:var(--text); border-radius:999px; padding:6px 8px;
      backdrop-filter: blur(4px);
    }
    .card .compare-toggle input{ width:16px; height:16px; }

    /* Barra azione confronto (mobile/desktop) */
    #compareBar{
      position: fixed; left: 50%; transform: translateX(-50%);
      bottom: env(safe-area-inset-bottom, 16px); bottom: calc(16px + env(safe-area-inset-bottom));
      display:none; gap:10px; align-items:center;
      background: var(--panel); color: var(--text);
      border:1px solid rgba(255,255,255,.15); border-radius: 999px;
      padding:10px 14px; box-shadow: 0 8px 24px rgba(0,0,0,.4); z-index: 50;
    }
    #compareBar.show{ display:flex; }

    /* Dialog confronto */
    #cmp::backdrop{ background: rgba(0,0,0,.65) }
    #cmp{ inset:0; margin:0; padding:0; border:none; width:100vw; max-width:none; height:100svh; background:transparent; }
    #cmp .cmp-modal{ width:100%; height:100%; background: var(--panel); display:flex; flex-direction:column; }
    #cmp .cmp-header{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.12); }
    #cmp .cmp-grid{ display:grid; grid-template-columns: repeat(1, minmax(0,1fr)); gap:clamp(12px,1.5vw,20px); padding:14px; overflow:auto; }
    @media(min-width:700px){ #cmp .cmp-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }

    /* Migliora leggibilità titolo nel modal */
    #dlgName{ color:#fff; text-shadow: 0 1px 3px rgba(0,0,0,.8); }

    /* Swipe hint (opzionale) */
    #dlg .swipe-hint{ position:absolute; bottom:8px; left:0; right:0; text-align:center; font-size:12px; opacity:.6; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>Le carte FUT del canale Fantaballa!</h1>
          <div class="subtitle">Non hai ancora una carta? Segui le live su Tik Tok di Fanataballa!</div>
        </div>
      </div>
<a class="pill" href="open-pack.html">🎁 Apri un pacchetto</a>

      <div class="toolbar" aria-label="Filtri e ricerca">
        <div class="search" role="search">
          🔎 <input id="q" type="search" placeholder="Cerca per nome, serie o testo..." aria-label="Cerca" />
        </div>
        <button id="toggleFavs" class="pill" type="button" title="Mostra solo preferiti">★ Preferiti</button>
        <select id="fGame" aria-label="Squadra/Gioco">
          <option value="">Tutte le squadre</option>
          <option>Fantaballa FC</option>
          <option>Gotham City</option>
          <option>Svincolato</option>
        </select>
        <select id="fRarity" aria-label="Rarità">
          <option value="">Tutte le rarità</option>
          <option>Comune</option>
          <option>Non comune</option>
          <option>Rara</option>
          <option>Ultra Rara</option>
          <option>Epica</option>
          <option>Season</option>
        </select>
        <select id="fRole" aria-label="Ruolo">
          <option value="">Tutti i ruoli</option>
          <option>Portiere</option><option>Difensore</option><option>Centrocampista</option><option>Attaccante</option>
        </select>
        <div class="range">
          <label for="fRating">Voto minimo:</label>
          <input id="fRating" type="range" min="0" max="5" step="1" value="0" />
          <span id="fRatingVal">0</span>
        </div>
        <select id="fSort" aria-label="Ordina per">
          <option value="name">Nome (A–Z)</option>
          <option value="rating">Valutazione</option>
          <option value="role">Ruolo</option>
        </select>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <!-- TEMPLATES -->
  <template id="tplCard">
    <article class="card" role="article">
      <div class="badge"></div>
      <button class="fav-btn" aria-pressed="false" title="Aggiungi ai preferiti"><span>☆</span></button>
      <label class="compare-toggle"><input type="checkbox" class="cmp-check" /> <span>Confronta</span></label>
      <img class="thumb" alt="Immagine carta" />
      <div class="content">
        <div class="name"></div>
        <div class="meta"></div>
        <div class="stars" aria-label="Valutazione media"></div>
        <div class="tags"></div>
        <button class="primary open">Apri</button>
      </div>
    </article>
  </template>

  <!-- MODAL DETTAGLIO -->
  <dialog id="dlg" aria-labelledby="dlgName" aria-describedby="dlgMeta">
    <div class="modal">
      <div class="left">
        <img id="dlgImg" alt="" />
        <div class="swipe-hint">⬅️➡️ Swipe per cambiare carta</div>
      </div>
      <div class="right">
        <h2 id="dlgName" style="margin:0 0 8px"></h2>
        <div id="dlgMeta" class="meta"></div>
        <div class="stars" id="dlgStars" aria-label="Valuta questa carta"></div>
        <div class="tags" id="dlgTags"></div>

        <h3 style="margin:14px 0 6px">Commenti</h3>
        <div id="comments"></div>

        <div class="field">
          <label for="author">Nome</label>
          <input id="author" type="text" placeholder="Il tuo nome" autocomplete="name" />
        </div>
        <div class="field">
          <label for="message">Commento</label>
          <textarea id="message" rows="3" placeholder="Scrivi un commento..."></textarea>
        </div>
        <div class="field">
          <label for="ratingSel">Voto (1-5)</label>
          <select id="ratingSel">
            <option value="5">5</option>
            <option value="4">4</option>
            <option value="3">3</option>
            <option value="2">2</option>
            <option value="1">1</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button class="primary" id="saveC">💾 Pubblica commento</button>
        <button id="clearC" type="button" title="Solo su questo dispositivo">🗑️ Svuota commenti</button>
        <form method="dialog"><button>Chiudi</button></form>
      </div>
    </div>
  </dialog>

  <!-- Barra confronto + Dialog confronto (AGGIUNTA) -->
  <div id="compareBar" role="region" aria-live="polite">
    <span id="cmpCount">0 selezionate</span>
    <button id="openCompare" class="primary" type="button">Confronta</button>
    <button id="clearCompare" type="button">Azzera</button>
  </div>

  <dialog id="cmp" aria-labelledby="cmpTitle">
    <div class="cmp-modal">
      <div class="cmp-header">
        <h2 id="cmpTitle" style="margin:0">Confronto carte</h2>
        <form method="dialog"><button class="pill" autofocus>Chiudi</button></form>
      </div>
      <div class="cmp-grid" id="cmpGrid"></div>
    </div>
  </dialog>

  <script>
    // ====== Util ======
    const $ = sel => document.querySelector(sel);

    function esc(s){
      return (s??'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
    }
    function avg(list){ return list.length? (list.reduce((a,b)=>a+b,0)/list.length) : 0 }

    // ====== Wishlist / Preferiti ======
    const FAV_KEY = 'favorites_v1';
    function loadFavs(){ try{return JSON.parse(localStorage.getItem(FAV_KEY)||'[]')}catch(e){return[]} }
    function saveFavs(list){ localStorage.setItem(FAV_KEY, JSON.stringify(list)); }
    function isFav(id){ return loadFavs().includes(id); }
    function toggleFav(id, pressed){
      const favs = new Set(loadFavs());
      if(pressed){ favs.add(id); } else { favs.delete(id); }
      saveFavs([...favs]);
    }
    let showFavsOnly = false;
    const toggleFavsBtn = document.getElementById('toggleFavs');
    if(toggleFavsBtn){
      toggleFavsBtn.addEventListener('click', ()=>{
        showFavsOnly = !showFavsOnly;
        toggleFavsBtn.classList.toggle('primary', showFavsOnly);
        applyFilters();
      });
    }

    // ====== Confronto ======
    const cmpSel = new Set();
    const cmpBar = document.getElementById('compareBar');
    const cmpCount = document.getElementById('cmpCount');
    const openCompareBtn = document.getElementById('openCompare');
    const clearCompareBtn = document.getElementById('clearCompare');
    const cmpDlg = document.getElementById('cmp');
    const cmpGrid = document.getElementById('cmpGrid');

    function syncCompareBar(){
      const n = cmpSel.size;
      cmpCount.textContent = n + ' selezionate';
      cmpBar.classList.toggle('show', n>=2);
    }
    openCompareBtn.addEventListener('click', ()=>{
      renderCompare();
      cmpDlg.showModal();
    });
    clearCompareBtn.addEventListener('click', ()=>{
      cmpSel.clear();
      document.querySelectorAll('.cmp-check').forEach(c=> c.checked=false);
      syncCompareBar();
    });

    function renderCompare(){
      cmpGrid.innerHTML='';
      const ids = [...cmpSel].slice(0,3);
      const items = ids.map(id => CARDS.find(c=>c.id===id)).filter(Boolean);
      for(const c of items){
        const div = document.createElement('div');
        div.className='cmp-card';
        div.style.background = 'var(--card)';
        div.style.border = '1px solid rgba(255,255,255,.12)';
        div.style.borderRadius = '12px';
        div.style.overflow = 'hidden';
        div.innerHTML = `
          <div style="padding:10px; display:flex; gap:10px; align-items:center">
            <img src="${c.img}" alt="Carta ${esc(c.name)}" style="width:90px; height:auto; border-radius:8px; border:1px solid rgba(255,255,255,.12)" />
            <div>
              <div style="font-weight:600">${esc(c.name)}</div>
              <div class="meta">${esc(c.game)} • ${esc(c.series)} • ${esc(c.role||'—')}</div>
              <div class="tags" style="margin-top:6px">${(c.tags||[]).map(t=>`<span class="tag">${esc(t)}</span>`).join('')}</div>
            </div>
          </div>
        `;
        const stars = document.createElement('div');
        stars.className='stars'; stars.style.padding='0 10px 10px';
        renderStars(stars, avg(loadRatings(c.id))||0, null);
        div.appendChild(stars);
        cmpGrid.appendChild(div);
      }
    }

    // ====== Swipe nel modal dettaglio ======
    let lastItems = []; // salva ultimo elenco renderizzato (per swipe prev/next)
    let touchX = 0, touchY = 0, swiping = false;
    function bindSwipe(){
      const zone = dlg; // area swipe su tutto il dialog
      zone.addEventListener('touchstart', (e)=>{
        const t = e.changedTouches[0]; touchX=t.clientX; touchY=t.clientY; swiping=true;
      }, {passive:true});
      zone.addEventListener('touchend', (e)=>{
        if(!swiping) return;
        const t = e.changedTouches[0];
        const dx = t.clientX - touchX;
        const dy = Math.abs(t.clientY - touchY);
        swiping=false;
        if(Math.abs(dx) > 50 && dy < 60 && current){
          // trova prev/next nell'array corrente
          const idx = lastItems.findIndex(x=> x.id===current.id);
          if(dx<0){ // swipe left -> next
            const next = lastItems[(idx+1) % lastItems.length];
            if(next) openModal(next);
          }else{     // swipe right -> prev
            const prev = lastItems[(idx-1+lastItems.length) % lastItems.length];
            if(prev) openModal(prev);
          }
        }
      }, {passive:true});
    }

    // ====== Data ======
    let CARDS = [];

    function starSVG(full){ return full? 
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="#ffd166"><path d="M12 .587l3.668 7.431L24 9.75l-6 5.85L19.335 24 12 19.897 4.665 24 6 15.6 0 9.75l8.332-1.732z"/></svg>' :
      '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#ffd166" stroke-width="2"><path d="M12 17.3l6.18 3.7-1.64-7.03L22 9.24l-7.19-.62L12 2 9.19 8.62 2 9.24l5.46 4.73L5.82 21z"/></svg>';
    }

    async function loadCards(){
      try{
        const res = await fetch('cards.json', { cache: 'no-store' });
        if(!res.ok) throw new Error('cards.json non trovato');
        CARDS = await res.json();
      }catch(e){
        console.error('[ERRORE CARICAMENTO CARTE]', e);
        CARDS = [];
      }finally{
        applyFilters();
      }
    }

    // ====== Stars ======
    function renderStars(container, value, onRate){
      container.innerHTML='';
      const full = Math.round(value);
      for(let i=1;i<=5;i++){
        const btn = document.createElement(onRate? 'button':'div');
        btn.innerHTML = starSVG(i<=full);
        if(onRate) btn.addEventListener('click', ()=> onRate(i));
        container.appendChild(btn);
      }
      const label = document.createElement('span');
      label.textContent = value? ` ${value.toFixed(1)}/5` : ' Nessuna valutazione';
      container.appendChild(label);
    }

    // ====== Filters ======
    function noFiltersActive(){
      return (
        !$('#q').value &&
        !$('#fGame').value &&
        !$('#fRarity').value &&
        !$('#fRole').value &&
        +$('#fRating').value===0 &&
        $('#fSort').value==='name' &&
        !showFavsOnly
      );
    }

    function applyFilters(){
      const q = $('#q').value.trim().toLowerCase();
      const game = $('#fGame').value;
      const rarity = $('#fRarity').value;
      const role = $('#fRole').value;
      const minR = +$('#fRating').value;
      const sort = $('#fSort').value;

      let items = CARDS.map(c=>({ ...c, rating: avg(loadRatings(c.id)) }));
      if(showFavsOnly){ const favs = new Set(loadFavs()); items = items.filter(c=> favs.has(c.id)); }
      if(q){ items = items.filter(c=> (c.name+" "+c.series+" "+c.text).toLowerCase().includes(q)); }
      if(game){ items = items.filter(c=> c.game===game); }
      if(rarity){ items = items.filter(c=> c.rarity===rarity); }
      if(role){ items = items.filter(c=> c.role===role); }
      if(minR>0){ items = items.filter(c=> Math.round(c.rating) >= minR); }

      items.sort((a,b)=>{
        if(sort==='rating') return (b.rating||0) - (a.rating||0);
        if(sort==='role') return (a.role||'').localeCompare(b.role||'');
        return a.name.localeCompare(b.name);
      });

      // Nessun filtro attivo → 8 carte casuali
      if (noFiltersActive()) {
        items = items.slice().sort(() => Math.random() - 0.5).slice(0, 8);
      }

      lastItems = items.slice();
      renderGrid(items);
    }

    // ====== Grid ======
    const grid = $('#grid');
    function renderGrid(items){
      grid.innerHTML='';
      if(!items.length){ grid.innerHTML = '<p style="color:var(--text-2); text-align:center; padding: 20px">Nessuna carta trovata. Prova a cambiare i filtri.</p>'; return }
      const tpl = document.getElementById('tplCard');
      for(const c of items){
        const node = tpl.content.firstElementChild.cloneNode(true);

        // classe rarità -> glow + badge colorato
        const rarSlug = (c.rarity || '').toLowerCase().replace(/\s+/g,'-');
        if (rarSlug) node.classList.add('r-' + rarSlug);

        node.querySelector('.badge').textContent = c.rarity;
        const img = node.querySelector('.thumb');
        img.src = c.img; img.loading='lazy'; img.alt = `Carta ${c.name}`;
        node.querySelector('.name').textContent = c.name;
        node.querySelector('.meta').textContent = `${c.game} • ${c.series} • ${c.role || '—'}`;
        renderStars(node.querySelector('.stars'), c.rating||0, null);
        const tags = node.querySelector('.tags');
        (c.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tags.appendChild(s);});
        node.querySelector('.open').addEventListener('click', ()=> openModal(c));
        // fav btn
        const favBtn = node.querySelector('.fav-btn');
        const syncFav = ()=>{ const fav = isFav(c.id); favBtn.setAttribute('aria-pressed', fav? 'true':'false'); favBtn.querySelector('span').textContent = fav? '★':'☆'; };
        syncFav();
        favBtn.addEventListener('click', (e)=>{ e.stopPropagation(); const pressed = favBtn.getAttribute('aria-pressed')!=='true'; favBtn.setAttribute('aria-pressed', pressed?'true':'false'); toggleFav(c.id, pressed); if(showFavsOnly && !pressed){ node.remove(); } });

        // compare checkbox
        const cmpCheck = node.querySelector('.cmp-check');
        cmpCheck.addEventListener('change', ()=>{
          if(cmpCheck.checked){ 
            if(cmpSel.size>=3){ cmpCheck.checked=false; return; }
            cmpSel.add(c.id); 
          } else { 
            cmpSel.delete(c.id); 
          }
          syncCompareBar();
        });
        grid.appendChild(node);
      }
    }

    // ====== Modal ======
    const dlg = document.getElementById('dlg');
    const dlgImg = document.getElementById('dlgImg');
    const dlgName = document.getElementById('dlgName');
    const dlgMeta = document.getElementById('dlgMeta');
    const dlgStars = document.getElementById('dlgStars');
    const dlgTags = document.getElementById('dlgTags');
    const commentsBox = document.getElementById('comments');
    let current = null;

    function openModal(card){
      current = card;
      dlgImg.src = card.img;
      dlgName.textContent = card.name;
      dlgMeta.textContent = `${card.game} • ${card.series} • ${card.role || '—'}`;
      dlgTags.innerHTML=''; (card.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; dlgTags.appendChild(s)});
      const rating = avg(loadRatings(card.id));
      renderStars(dlgStars, rating, (v)=>{ saveRating(card.id, v); applyFilters(); openModal(card) });
      renderComments(card.id);
      document.body.classList.add('modal-open');
      dlg.showModal();

      // Focus su commento e spostalo in vista (mobile)
      setTimeout(()=>{
        const msg = document.getElementById('message');
        if(msg){ msg.focus({preventScroll:true}); msg.scrollIntoView({block:'center'}); }
      }, 120);
    }

    bindSwipe();

    dlg.addEventListener('close', ()=>{
      current=null;
      document.body.classList.remove('modal-open');
    });

    function renderComments(id){
      commentsBox.innerHTML='';
      const list = loadComments(id);
      if(!list.length){ commentsBox.innerHTML = '<div class="comment">Ancora nessun commento. Scrivi il primo! 🎉</div>'; return }
      for(const c of list.slice().reverse()){
        const div = document.createElement('div');
        div.className='comment';
        div.innerHTML = `<div class="author">${esc(c.author||'Anonimo')}</div>
                         <div class="date">${new Date(c.ts||Date.now()).toLocaleString()}</div>
                         <div class="text">${esc(c.msg||'')}</div>`;
        commentsBox.appendChild(div);
      }
    }

    // ====== Ratings & comments storage (local) ======
    const RATE_KEY = 'ratings_v1';
    const COMM_KEY = 'comments_v1';

    function loadRatings(id){
      try{ const all = JSON.parse(localStorage.getItem(RATE_KEY)||'{}'); return all[id]||[] }catch(e){ return [] }
    }
    function saveRating(id, val){
      const all = JSON.parse(localStorage.getItem(RATE_KEY)||'{}');
      if(!all[id]) all[id]=[];
      all[id].push(val);
      localStorage.setItem(RATE_KEY, JSON.stringify(all));
    }

    function loadComments(id){
      try{ const all = JSON.parse(localStorage.getItem(COMM_KEY)||'{}'); return all[id]||[] }catch(e){ return [] }
    }
    function saveComment(id, c){
      const all = JSON.parse(localStorage.getItem(COMM_KEY)||'{}');
      if(!all[id]) all[id]=[];
      all[id].push(c);
      localStorage.setItem(COMM_KEY, JSON.stringify(all));
    }
    document.getElementById('saveC').addEventListener('click', ()=>{
      if(!current) return;
      const author = document.getElementById('author').value.trim();
      const msg = document.getElementById('message').value.trim();
      const rating = +document.getElementById('ratingSel').value;
      if(msg){ saveComment(current.id, {author, msg, ts: Date.now(), rating}); document.getElementById('message').value=''; renderComments(current.id); }
      if(rating){ saveRating(current.id, rating); renderStars(dlgStars, avg(loadRatings(current.id)), v=>{}); applyFilters(); }
    });
    document.getElementById('clearC').addEventListener('click', ()=>{
      if(!current) return;
      const all = JSON.parse(localStorage.getItem(COMM_KEY)||'{}');
      all[current.id]=[];
      localStorage.setItem(COMM_KEY, JSON.stringify(all));
      renderComments(current.id);
    });

    // ====== Events ======
    ['q','fGame','fRarity','fRole','fSort'].forEach(id=> document.getElementById(id).addEventListener('input', applyFilters));
    document.getElementById('fRating').addEventListener('input', ()=>{
      document.getElementById('fRatingVal').textContent=document.getElementById('fRating').value;
      applyFilters();
    });

    // ====== Init ======
    loadCards();
  </script>
</body>
</html>

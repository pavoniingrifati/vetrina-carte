<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fantaballa – FUT Tik Tok</title>
  <meta name="description" content="Vetrina di carte collezionab...con filtri, valutazioni, commenti e preferiti (dati locali)." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f19;
      --panel: #0f1526; 
      --card: #121a2e;
      --card-2: #0d1325;
      --text: #ecf0ff;
      --muted: #a7b0d3;
      --accent: #6ee7ff;
      --danger: #ff6b6b;
      --radius: 16px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --fav: #ff5d8f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; background: radial-gradient(1200px 800px at 1 1, #0b1022, #0b0f19); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* Layout */
    header{ position:sticky; top:0; z-index:20; background: rgba(15,21,38,.8); backdrop-filter: blur(8px); border-bottom:1px solid #1b2340; }
    .wrap{ max-width:1200px; margin:0 auto; padding: 12px 16px; }
    .bar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .title{ font-weight:700; letter-spacing:.2px; }
    .title small{ color:var(--muted); font-weight:500; }

    .filters{ display:flex; gap:8px; flex-wrap:wrap; margin-left:auto; }
    select, input[type="text"], button, .segmented{ height:36px; border-radius:10px; border:1px solid #1b2340; background:#0f1526; color:var(--text); padding:0 10px; }
    select:focus, input:focus, button:focus{ outline:2px solid #334e9a; outline-offset:1px; }
    button{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; }
    button.ghost{ background:transparent; border-color:#243159; }

    .segmented{ display:flex; overflow:hidden; padding:0; }
    .segmented button{ border:0; padding:0 12px; background:transparent; }
    .segmented button[aria-pressed="true"]{ background:#1a2444; }

    main{ max-width:1200px; margin: 18px auto 90px; padding: 0 16px; }
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap:14px; }

    /* Card */
    .card{ position:relative; border-radius:var(--radius); background:linear-gradient(180deg, var(--card), var(--card-2)); overflow:hidden; border:1px solid #1b2548; box-shadow: 0 0 0 1px rgba(110,231,255,0.0), 0 0 80px rgba(110,231,255,0.0) inset; transition: box-shadow .25s ease, transform .2s ease; }
    .card:hover{ transform: translateY(-1px); box-shadow: 0 0 0 1px rgba(110,231,255,0.08), 0 0 80px rgba(110,231,255,0.06) inset; }

    .thumb{ width:100%; height:240px; object-fit:cover; display:block; background:#0b1125; }
    .body{ padding:10px 12px 12px; display:flex; flex-direction:column; gap:8px; }
    .name{ font-weight:700; }
    .meta{ color:var(--muted); font-size:12px; }
    .tags{ display:flex; gap:6px; flex-wrap:wrap; }
    .tag{ font-size:11px; border-radius:999px; padding:2px 8px; background:#17203c; border:1px solid #26335f; color:#cdd6ff; }

    .badge{ position:absolute; top:8px; left:8px; padding:4px 8px; background:rgba(110,231,255,.85); color:#001; border-radius:8px; font-size:12px; border:1px solid rgba(110,231,255,.7); }
    .fav{ position:absolute; top:8px; right:8px; width:34px; height:34px; display:grid; place-items:center; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); cursor:pointer; }
    .fav svg{ width:18px; height:18px; fill:none; stroke:#ffd0e0; }
    .fav.active{ background:rgba(255,93,143,.15); border-color:rgba(255,93,143,.35); }
    .fav.active svg{ fill: var(--fav); stroke:var(--fav); }

    /* Rating stars */
    .stars{ display:flex; gap:2px; }
    .stars button{ width:18px; height:18px; padding:0; border:0; background:transparent; cursor:pointer; }

    /* Rarity accents */
    .card.r-comune      { --glow:#9aa3b2 }
    .card.r-non-comune  { --glow:#60a5fa }
    .card.r-rara        { --glow:#a78bfa }
    .card.r-ultra-rara  { --glow:#f472b6 }
    .card.r-epica       { --glow:#f59e0b }
    .card.r-season      { --glow:#22d3ee }
    .card.r-leggendaria { --glow:#facc15 }

    .card.r-comune      .badge{ background:rgba(154,163,178,.85); color:#06131e }
    .card.r-non-comune  .badge{ background:rgba(96,165,250,.85); color:#031220 }
    .card.r-rara        .badge{ background:rgba(167,139,250,.85); color:#140d2b }
    .card.r-ultra-rara  .badge{ background:rgba(244,114,182,.85); color:#2f0f23 }
    .card.r-epica       .badge{ background:rgba(245,158,11,.85); color:#1d0f06 }
    .card.r-season      .badge{ background:rgba(34,211,238,.85); color:#00131b }
    .card.r-leggendaria .badge{ background:rgba(250,204,21,.9); color:#1a1302 }

    /* NEW: Oggetto rarity color/badge */
    .card.r-oggetto      { --glow:#10b981 }
    .card.r-oggetto .badge { background: rgba(16,185,129,.85); color:#001 }

    .card.r-leggendaria::before{ content:""; position:absolute; inset:-2px; border-radius:inherit; pointer-events:none; background: radial-gradient(600px 200px at 20% -20%, rgba(250,204,21,.15), transparent 40%), radial-gradient(600px 200px at 120% 120%, rgba(250,204,21,.12), transparent 40%); }

    /* Modal */
    dialog{ border:0; background:transparent; padding:0; }
    .modal{ width:min(100vw, 1000px); height:min(80vh, 680px); display:grid; grid-template-columns: 1fr 1fr; gap:0; background:linear-gradient(180deg, var(--card), var(--card-2)); border:1px solid #1b2548; border-radius:24px; overflow:hidden; position:relative; }
    .modal .left{ background:#0a1227; display:flex; align-items:center; justify-content:center; }
    .modal .left img{ width:100%; height:100%; object-fit:contain; background:#0a1227; }
    .modal .right{ padding:16px; display:flex; flex-direction:column; gap:12px; }

    .modal .hdr{ display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .modal .name{ font-size:20px; font-weight:800; }
    .modal .meta{ color:var(--muted); font-size:13px; }

    .dialog-actions{ display:flex; align-items:center; gap:8px; margin-top:auto; }

    .navPrev, .navNext{ position:absolute; top:50%; transform: translateY(-50%); width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); cursor:pointer; }
    .navPrev{ left:8px; } .navNext{ right:8px; }

    .close{ position:absolute; top:10px; right:10px; width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); cursor:pointer; }

    /* Mobile tweaks */
    @media (max-width: 820px){
      .modal{ grid-template-columns: 1fr; height: 90vh; }
      .modal .left{ height: 58vh; }
    }

    footer{ position:fixed; bottom:0; left:0; right:0; padding:10px 16px calc(10px + var(--safe-bottom)); background:linear-gradient(180deg, rgba(10,14,24,.0), rgba(10,14,24,.75)); display:flex; justify-content:center; }
    .by{ color:var(--muted); font-size:12px; padding:6px 10px; background:#0f1526; border:1px solid #1b2548; border-radius:8px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="bar">
        <div class="title">Fantaballa <small>— FUT Tik Tok</small></div>

        <div class="segmented" role="tablist" aria-label="Sezioni">
          <button id="tabAll" role="tab" aria-pressed="true">Tutte</button>
          <button id="tabFavs" role="tab" aria-pressed="false">Preferiti</button>
        </div>

        <div class="filters" role="group" aria-label="Filtri">
          <input id="fSearch" type="text" placeholder="Cerca per nome…" aria-label="Cerca">

          <select id="fGame" aria-label="Gioco">
            <option value="">Tutti i giochi</option>
          </select>

          <select id="fSeries" aria-label="Serie">
            <option value="">Tutte le serie</option>
          </select>

          <select id="fRarity" aria-label="Rarità">
          <option value="">Tutte le rarità</option>
          <option>Comune</option>
          <option>Non Comune</option>
          <option>Rara</option>
          <option>Ultra Rara</option>
          <option>Epica</option>
          <option>Season</option>
          <option>Leggendaria</option>
          <option>Oggetto</option>
        </select>

          <button id="reset" class="ghost">Reset</button>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div id="grid" class="grid" aria-live="polite" aria-busy="false"></div>
  </main>

  <!-- Template Card -->
  <template id="tplCard">
    <article class="card" role="article">
      <span class="badge" aria-label="Rarità"></span>
      <button class="fav" title="Aggiungi ai preferiti" aria-label="Aggiungi ai preferiti" aria-pressed="false">
        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 21s-6.716-4.447-9.293-7.025C.9 12.167.9 8.833 2.707 7.025c1.809-1.809 4.743-1.809 6.55 0L12 9.768l2.743-2.743c1.807-1.809 4.741-1.809 6.55 0 1.807 1.808 1.807 5.142 0 6.95C18.716 16.553 12 21 12 21z"/></svg>
      </button>
      <img class="thumb" alt="" />
      <div class="body">
        <div class="name"></div>
        <div class="meta"></div>
        <div class="stars" aria-label="Valutazione"></div>
        <div class="tags"></div>
        <button class="open" aria-label="Apri dettagli">Apri</button>
      </div>
    </article>
  </template>

  <!-- Modal Dettaglio -->
  <dialog id="dlg">
    <div class="modal">
      <div class="left">
        <img id="dlgImg" alt="" />
      </div>
      <div class="right">
        <div class="hdr">
          <div>
            <div id="dlgName" class="name"></div>
            <div id="dlgMeta" class="meta"></div>
          </div>
          <button class="close" onclick="this.closest('dialog').close()" aria-label="Chiudi">
            <svg viewBox="0 0 24 24"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
          </button>
        </div>

        <div id="dlgStars" class="stars"></div>
        <div id="dlgTags" class="tags"></div>

        <div id="comments"></div>

        <div class="dialog-actions">
          <button class="navPrev" title="Precedente" aria-label="Precedente">←</button>
          <button class="navNext" title="Successiva" aria-label="Successiva">→</button>
        </div>
      </div>
    </div>
  </dialog>

  <footer>
    <div class="by">Fatto con ❤️ e dati locali</div>
  </footer>

  <script>
    // ====== Data ======
    let ALL = [];

    // ====== Helpers ======
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

    function uniq(arr){ return [...new Set(arr)].sort((a,b)=> String(a).localeCompare(String(b))); }

    function saveFavs(ids){ localStorage.setItem('favs', JSON.stringify(ids)); }
    function loadFavs(){ try{ return JSON.parse(localStorage.getItem('favs')||'[]'); }catch{return []} }
    function isFav(id){ return loadFavs().includes(id); }
    function toggleFav(id){ const s=new Set(loadFavs()); s.has(id)? s.delete(id) : s.add(id); saveFavs([...s]); }

    function saveRating(id, v){ const all = JSON.parse(localStorage.getItem('ratings')||'{}'); all[id]=v; localStorage.setItem('ratings', JSON.stringify(all)); }
    function loadRatings(id){ const all = JSON.parse(localStorage.getItem('ratings')||'{}'); return id? (all[id]?[all[id]]:[]) : all; }
    function avg(arr){ if(!arr.length) return 0; return Math.round(arr.reduce((a,b)=>a+b,0)/arr.length); }

    // ====== UI Elements ======
    const grid = document.getElementById('grid');
    const fSearch = document.getElementById('fSearch');
    const fGame = document.getElementById('fGame');
    const fSeries = document.getElementById('fSeries');
    const fRarity = document.getElementById('fRarity');

    const tabAll = document.getElementById('tabAll');
    const tabFavs = document.getElementById('tabFavs');

    let CURRENT_TAB = 'all';

    tabAll.addEventListener('click', ()=>{ CURRENT_TAB='all'; tabAll.setAttribute('aria-pressed','true'); tabFavs.setAttribute('aria-pressed','false'); applyFilters(); });
    tabFavs.addEventListener('click', ()=>{ CURRENT_TAB='favs'; tabAll.setAttribute('aria-pressed','false'); tabFavs.setAttribute('aria-pressed','true'); applyFilters(); });

    // ====== Render ======
    function renderStars(node, value, onRate){
      node.innerHTML='';
      for(let i=1;i<=5;i++){
        const btn = document.createElement('button');
        btn.innerHTML = i<=value ? '★' : '☆';
        if(onRate){ btn.addEventListener('click', ()=> onRate(i)); }
        node.appendChild(btn);
      }
    }

    function renderGrid(items){
      grid.innerHTML='';
      if(!items.length){
        const msg = CURRENT_TAB==='favs' ? 'Nessuna carta nei preferiti. Aggiungine una con il cuore.' : 'Nessuna carta trovata. Prova a cambiare i filtri.';
        grid.innerHTML = `<p style="color:var(--muted)">${msg}</p>`; return;
      }
      const tpl = document.getElementById('tplCard');
      const favSet = new Set(loadFavs());
      for(const c of items){
        const node = tpl.content.firstElementChild.cloneNode(true);
        const rarSlug = (c.rarity || '').toLowerCase().replace(/\s+/g,'-');
        if (rarSlug) node.classList.add('r-' + rarSlug);
        node.querySelector('.badge').textContent = c.rarity;
        const img = node.querySelector('.thumb');
        img.src = c.img; img.loading='lazy'; img.alt = `Carta ${c.name}`;
        img.addEventListener('click', ()=> openModal(c)); // NOVITÀ: apri anche cliccando sull'immagine
        node.querySelector('.name').textContent = c.name;
        node.querySelector('.meta').textContent = `${c.game} • ${c.series} • ${c.role || '—'}`;
        renderStars(node.querySelector('.stars'), c.rating||0, null);
        const tags = node.querySelector('.tags');
        (c.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; tags.appendChild(s);});

        // Quantità (se presente)
        if (typeof c.quantity === 'number') {
          const q = document.createElement('span');
          q.className = 'tag';
          q.textContent = `x${c.quantity}`;
          tags.appendChild(q);
        }

        // Preferiti (cuore)
        const favBtn = node.querySelector('.fav');
        const favActive = favSet.has(c.id);
        favBtn.classList.toggle('active', favActive);
        favBtn.setAttribute('aria-pressed', String(favActive));
        favBtn.addEventListener('click', (ev)=>{
          ev.stopPropagation(); ev.preventDefault();
          toggleFav(c.id);
          const on = isFav(c.id);
          favBtn.classList.toggle('active', on);
          favBtn.setAttribute('aria-pressed', String(on));
          if(CURRENT_TAB==='favs' && !on){ // se sei nella tab preferiti e rimuovi, togli subito dalla griglia
            favBtn.closest('.card').remove();
            LAST_ITEMS = LAST_ITEMS.filter(x=> x.id!==c.id);
            if(!grid.children.length){ grid.innerHTML = '<p style="color:var(--muted)">Nessuna carta nei preferiti.</p>'; }
          }
        });

        node.querySelector('.open').addEventListener('click', ()=> openModal(c));
        grid.appendChild(node);
      }
    }

    // ====== Modal + Navigazione ======
    const dlg = document.getElementById('dlg');
    const dlgImg = document.getElementById('dlgImg');
    const dlgName = document.getElementById('dlgName');
    const dlgMeta = document.getElementById('dlgMeta');
    const dlgStars = document.getElementById('dlgStars');
    const dlgTags = document.getElementById('dlgTags');
    const commentsBox = document.getElementById('comments');
    const navPrev = document.querySelector('.navPrev');
    const navNext = document.querySelector('.navNext');
    let current = null; let currentIndex = -1;

    function openByIndex(i){ if(!LAST_ITEMS?.length) return; if(i<0||i>=LAST_ITEMS.length) return; openModal(LAST_ITEMS[i]); }

    function openModal(card){
      current = card; currentIndex = LAST_ITEMS.findIndex(x=> x.id===card.id);
      dlgImg.src = card.img; dlgName.textContent = card.name; dlgMeta.textContent = `${card.game} • ${card.series} • ${card.role || '—'}`;
      dlgTags.innerHTML=''; (card.tags||[]).forEach(t=>{ const s=document.createElement('span'); s.className='tag'; s.textContent=t; dlgTags.appendChild(s)});
      // Quantità nel modale
      if (typeof card.quantity === 'number') {
        const q = document.createElement('span');
        q.className = 'tag';
        q.textContent = `x${card.quantity}`;
        dlgTags.appendChild(q);
      }
      const rating = avg(loadRatings(card.id));
      renderStars(dlgStars, rating, (v)=>{ saveRating(card.id, v); applyFilters(); openModal(card) });
      renderComments(card.id);
      document.body.classList.add('modal-open');
      dlg.showModal();
    }

    dlg.addEventListener('close', ()=>{ current=null; currentIndex=-1; document.body.classList.remove('modal-open'); });

    // Bottoni desktop
    navPrev.addEventListener('click', ()=> openByIndex(currentIndex-1));
    navNext.addEventListener('click', ()=> openByIndex(currentIndex+1));

    // Tastiera ← →
    document.addEventListener('keydown', (e)=>{
      if(!dlg.open) return;
      if(e.key==='ArrowLeft') { e.preventDefault(); openByIndex(currentIndex-1); }
      if(e.key==='ArrowRight'){ e.preventDefault(); openByIndex(currentIndex+1); }
      if(e.key==='Escape'){ dlg.close(); }
    });

    // ====== Commenti (local-only) ======
    function loadComments(){ try{ return JSON.parse(localStorage.getItem('comments')||'{}'); }catch{return{}} }
    function saveComments(all){ localStorage.setItem('comments', JSON.stringify(all)); }
    function renderComments(id){
      const all = loadComments(); const list = all[id]||[];
      commentsBox.innerHTML = `
        <h3>Commenti</h3>
        <div class="list">${list.map(x=> `<div class="c"><b>${x.n}</b>: ${x.t}</div>`).join('')}</div>
        <form id="cForm">
          <input name="n" placeholder="Nome" required />
          <input name="t" placeholder="Scrivi un commento…" required />
          <button>Invia</button>
        </form>`;
      const form = document.getElementById('cForm');
      form.addEventListener('submit', (e)=>{
        e.preventDefault();
        const n = form.n.value.trim(); const t = form.t.value.trim(); if(!n||!t) return;
        const all = loadComments(); const list = all[id]||[]; list.push({n,t}); all[id]=list; saveComments(all);
        renderComments(id);
      });
    }

    // ====== Filtri ======
    let LAST_ITEMS = [];
    function applyFilters(){
      let q = fSearch.value.trim().toLowerCase();
      const g = fGame.value; const s = fSeries.value; const r = fRarity.value;
      let items = ALL.filter(c=> {
        if(q && !String(c.name).toLowerCase().includes(q)) return false;
        if(g && c.game!==g) return false;
        if(s && c.series!==s) return false;
        if(r && c.rarity!==r) return false;
        return true;
      });
      if(CURRENT_TAB==='favs'){
        const favs = new Set(loadFavs());
        items = items.filter(c=> favs.has(c.id));
      }
      LAST_ITEMS = items;
      renderGrid(items);
    }

    function populateFilters(){
      const games = uniq(ALL.map(x=> x.game).filter(Boolean));
      const series = uniq(ALL.map(x=> x.series).filter(Boolean));
      fGame.innerHTML = '<option value="">Tutti i giochi</option>' + games.map(x=> `<option>${x}</option>`).join('');
      fSeries.innerHTML = '<option value="">Tutte le serie</option>' + series.map(x=> `<option>${x}</option>`).join('');
    }

    document.getElementById('reset').addEventListener('click', ()=>{
      fSearch.value=''; fGame.value=''; fSeries.value=''; fRarity.value=''; CURRENT_TAB='all'; tabAll.setAttribute('aria-pressed','true'); tabFavs.setAttribute('aria-pressed','false'); applyFilters();
    });

    // ====== Init ======
    fetch('cards.json').then(r=> r.json()).then(json=>{
      ALL = json;
      populateFilters();
      applyFilters();
    });
  </script>
</body>
</html>

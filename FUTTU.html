<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FUTTU – Open Pack (solo 1 pacchetto, per game, 3 carte)</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#161a2e; --muted:#9aa3b2; --text:#f5f7ff; --primary:#5b9cff; --accent:#9d6cff; --good:#3ddc97; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 800px at 10% -10%, #1a2041 0%, #0f1220 40%),
      radial-gradient(1400px 800px at 110% 10%, #102544 0%, #0f1220 40%),var(--bg);color:var(--text)}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;padding:18px 22px;background:linear-gradient(180deg,#151a2f,rgba(21,26,47,.3));border-bottom:1px solid #22284a;position:sticky;top:0;z-index:10}
    h1{font-size:20px;margin:0;letter-spacing:.5px}
    .tag{font-size:12px;padding:4px 8px;border:1px solid #2a315a;border-radius:999px;color:var(--muted)}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:22px}
    .panel{background:rgba(22,26,46,.8);backdrop-filter: blur(8px);border:1px solid #242b52;border-radius:18px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .panel h2{margin:0 0 12px 0;font-size:18px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    input[type=text]{background:#0e1122;border:1px solid #242b52;color:var(--text);padding:10px 12px;border-radius:12px}
    button{background:linear-gradient(180deg,var(--primary),#3a77ff);border:0;color:white;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:0 8px 20px rgba(58,119,255,.35)}
    button.secondary{background:#262d55}
    button.ghost{background:transparent;border:1px solid #2a315a}
    button:disabled{opacity:.6;cursor:not-allowed}
    select{background:#0e1122;border:1px solid #242b52;color:var(--text);padding:10px 12px;border-radius:12px}
    .stat{display:flex;gap:8px;align-items:center;background:#111531;border:1px solid #242b52;border-radius:12px;padding:8px 10px}
    .price{font-size:22px;font-weight:800}
    .packs-remaining{font-weight:700}
    .cards{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .card{background:linear-gradient(180deg,#1b2144,#131731);border:1px solid #273062;border-radius:16px;overflow:hidden;display:flex;flex-direction:column;min-height:220px}
    .card img{width:100%;aspect-ratio:4/5;object-fit:cover;background:#0e1122}
    .card .meta{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .pill{font-size:11px;border:1px solid #38407a;color:#c7cdfa;border-radius:999px;padding:3px 8px;display:inline-flex;gap:6px;align-items:center}
    .rarity{font-size:11px;color:#fff;padding:3px 8px;border-radius:999px;background:linear-gradient(90deg,#c471f5,#fa71cd)}
    .empty{opacity:.7;text-align:center;border:1px dashed #2a315a;border-radius:14px;padding:24px}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#0e1122;border:1px solid #273062;color:var(--text);padding:12px 16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.35);display:none}
  </style>
</head>
<body>
<header>
  <div class="row">
    <h1>FUTTU – Open Pack</h1>
    <span class="tag">1 solo tipo di pacchetto • per game • 3 carte</span>
  </div>
  <div class="row" id="authBox">
    <input id="usernameInput" type="text" placeholder="Nome utente" />
    <button id="loginBtn">Accedi</button>
  </div>
</header>
<div class="container">
  <div class="grid">
    <section class="panel" id="packPanel">
      <h2>Negozio</h2>
      <div class="row" style="margin-bottom:12px">
        <label for="gameSelect" class="muted">Seleziona game</label>
        <select id="gameSelect">
          <option value="Fantaballa FC">Fantaballa FC</option>
          <option value="Gotham City">Gotham City</option>
        </select>
        <div class="spacer"></div>
        <div class="stat"><span class="muted">Credito</span> <strong id="credit">0</strong></div>
        <button class="ghost" id="addCreditBtn">+ 10.000 test</button>
      </div>
      <div class="row" style="margin-bottom:16px">
        <div class="price">1800</div>
        <div class="muted"> per pacchetto</div>
        <div class="spacer"></div>
        <div class="packs-remaining"><span id="packsCount">0</span> pacchetti disponibili</div>
      </div>
      <div class="row" style="margin-bottom:16px">
        <button id="buyBtn">Compra &amp; Apri</button>
        <button class="secondary" id="previewBtn">Anteprima carte rimaste</button>
      </div>

      <div id="opened" class="panel" style="background:#121632;border-style:dashed;display:none">
        <h2>Pacchetto aperto</h2>
        <div id="openedCards" class="cards"></div>
      </div>

      <div id="preview" class="panel" style="margin-top:16px;display:none">
        <h2>Carte ancora disponibili in questo game</h2>
        <div id="previewCards" class="cards"></div>
      </div>
    </section>

    <aside class="panel">
      <h2>Le mie carte</h2>
      <div id="myCards" class="cards"></div>
      <div id="myCardsEmpty" class="empty">Nessuna carta ancora. Apri un pacchetto!</div>
    </aside>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
(function(){
  const PACK_PRICE = 1800;
  const GAMES = ["Fantaballa FC","Gotham City"]; // i soli giochi permessi
  const qs = sel => document.querySelector(sel);
  const qsa = sel => Array.from(document.querySelectorAll(sel));
  const state = { user:null, credit:0, cards:[], currentGame:GAMES[0], inventory:{} };

  const storage = {
    get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  const toast = (msg)=>{ const el=qs('#toast'); el.textContent=msg; el.style.display='block'; setTimeout(()=>el.style.display='none', 2200); };

  // --- AUTH & CREDIT ---
  function loadAuth(){
    const savedUser = storage.get('futtu_user', null);
    if(savedUser){ state.user = savedUser; }
    const creditKey = keyCredit();
    state.credit = storage.get(creditKey, 0);
    renderAuth();
  }
  function keyCredit(){ return `futtu_credit_${state.user ?? 'anon'}` }
  function keyMyCards(){ return `futtu_mycards_${state.user ?? 'anon'}` }
  function keyInventory(){ return `futtu_inventory_${state.user ?? 'anon'}` }

  function renderAuth(){
    const box = qs('#authBox');
    if(state.user){
      box.innerHTML = `<span class="muted">Ciao</span> <strong>${state.user}</strong> <button id="logoutBtn" class="ghost">Esci</button>`;
      qs('#logoutBtn').onclick = ()=>{ state.user=null; storage.set('futtu_user', null); loadAuth(); loadMyCards(); loadInventory(); };
    } else {
      box.innerHTML = `<input id="usernameInput" type="text" placeholder="Nome utente" /> <button id="loginBtn">Accedi</button>`;
      qs('#loginBtn').onclick = ()=>{
        const v = qs('#usernameInput').value.trim();
        if(!v){ toast('Inserisci un nome utente'); return; }
        state.user = v; storage.set('futtu_user', v); loadAuth(); loadMyCards(); loadInventory();
      };
    }
    qs('#credit').textContent = state.credit;
  }

  // --- CARDS & PACKS INVENTORY ---
  async function loadCards(){
    try{
      const res = await fetch('cards.json', { cache: 'no-store' });
      if(!res.ok) throw new Error('cards.json non trovato');
      const all = await res.json();
      // si presume un array di carte con almeno: id, name, game, image, rarity
      state.cards = Array.isArray(all) ? all : (all.cards || []);
      ensureInventory();
      updateCounts();
    }catch(err){
      console.error(err);
      toast('Impossibile caricare le carte (cards.json)');
    }
  }

  function byGame(game){ return state.cards.filter(c => c.game === game); }

  function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr }

  function buildPacks(cards){
    // Regole: pacchetti da 3 carte, tutte diverse e finiti.
    // Se il totale % 3 == 1, evitiamo pacchetto da 1 -> due pacchetti da 2.
    const pool = shuffle(cards.map(c=>c.id));
    const n = pool.length;
    const packs = [];
    let i=0;
    const full = Math.floor(n/3);
    const rem = n%3;
    for(let k=0;k<full;k++) packs.push([pool[i++], pool[i++], pool[i++]]);
    if(rem===2){ packs.push([pool[i++], pool[i++]]); }
    if(rem===1){
      if(packs.length>0){
        // prendo 1 carta dall'ultimo pacchetto pieno per formare 2 pacchetti da 2
        const a = packs.pop();
        const x1 = a.pop();
        const last = pool[i++];
        packs.push(a); // ora da 2
        packs.push([x1,last]); // anche da 2
      } else {
        // meno di 3 carte totali: un unico pacchetto da 1
        packs.push([pool[i++]]);
      }
    }
    return packs;
  }

  function ensureInventory(){
    const inv = storage.get(keyInventory(), {});
    state.inventory = inv;
    let changed = false;
    for(const game of GAMES){
      if(!state.inventory[game]){
        const cards = byGame(game);
        state.inventory[game] = {
          packs: buildPacks(cards), // array di array di cardId
        };
        changed = true;
      } else {
        // opzionale: se cards.json è cambiato, ricostruisci mantenendo carte non ancora vendute
        // Per semplicità manteniamo l'inventario salvato.
      }
    }
    if(changed) storage.set(keyInventory(), state.inventory);
  }

  function updateCounts(){
    const data = state.inventory[state.currentGame] || {packs:[]};
    qs('#packsCount').textContent = data.packs.length;
    qs('#credit').textContent = state.credit;
  }

  // --- BUY / OPEN ---
  function buyAndOpen(){
    const inv = state.inventory[state.currentGame];
    if(!inv || inv.packs.length===0){ toast('Nessun pacchetto rimasto per questo game'); return; }
    if(state.credit < PACK_PRICE){ toast('Credito insufficiente'); return; }
    state.credit -= PACK_PRICE; storage.set(keyCredit(), state.credit);
    const pack = inv.packs.shift(); // prendi il primo disponibile
    storage.set(keyInventory(), state.inventory);
    // mostra e salva nelle mie carte
    renderOpened(pack);
    addToMyCards(pack);
    updateCounts();
    toast('Pacchetto aperto! 3 carte aggiunte alle tue My Cards');
  }

  function renderOpened(cardIds){
    const cont = qs('#openedCards');
    cont.innerHTML = '';
    const dict = Object.fromEntries(state.cards.map(c=>[c.id,c]));
    cardIds.forEach(id => cont.appendChild(cardEl(dict[id])));
    qs('#opened').style.display='block';
  }

  // --- MY CARDS ---
  function loadMyCards(){
    const mine = storage.get(keyMyCards(), []);
    renderMyCards(mine);
  }
  function addToMyCards(cardIds){
    const mine = storage.get(keyMyCards(), []);
    const merged = [...mine, ...cardIds];
    storage.set(keyMyCards(), merged);
    renderMyCards(merged);
  }
  function renderMyCards(cardIds){
    const wrap = qs('#myCards');
    const empty = qs('#myCardsEmpty');
    wrap.innerHTML = '';
    if(!cardIds || cardIds.length===0){ empty.style.display='block'; return; }
    empty.style.display='none';
    const dict = Object.fromEntries(state.cards.map(c=>[c.id,c]));
    cardIds.forEach(id => wrap.appendChild(cardEl(dict[id])));
  }

  // --- PREVIEW REMAINING CARDS (per game) ---
  function previewRemaining(){
    const inv = state.inventory[state.currentGame];
    const ids = (inv?.packs || []).flat();
    const dict = Object.fromEntries(state.cards.map(c=>[c.id,c]));
    const cont = qs('#previewCards');
    cont.innerHTML = '';
    ids.map(id=>dict[id]).filter(Boolean).forEach(c=> cont.appendChild(cardEl(c)) );
    qs('#preview').style.display = 'block';
  }

  // --- UI helpers ---
  function cardEl(card){
    const el = document.createElement('div');
    el.className = 'card';
    if(!card){ el.innerHTML = `<div class="empty">Carta sconosciuta</div>`; return el; }
    const img = card.image || card.img || '';
    el.innerHTML = `
      ${img ? `<img src="${img}" alt="${(card.name||'Carta')}" />` : '<div style="height:180px;background:#0e1122"></div>'}
      <div class="meta">
        <div class="row">
          <span class="pill">${card.game||'Game'}</span>
          ${card.rarity ? `<span class="rarity">${card.rarity}</span>`: ''}
          <div class="spacer"></div>
          <span class="muted">#${card.id ?? '?'}</span>
        </div>
        <div style="font-weight:700">${card.name||'Senza nome'}</div>
        ${card.series ? `<div class="muted" style="font-size:12px">Serie: ${card.series}</div>`: ''}
      </div>`;
    return el;
  }

  // --- EVENTI UI ---
  qs('#gameSelect').addEventListener('change', (e)=>{ state.currentGame = e.target.value; updateCounts(); qs('#preview').style.display='none'; });
  qs('#buyBtn').addEventListener('click', buyAndOpen);
  qs('#previewBtn').addEventListener('click', previewRemaining);
  qs('#addCreditBtn').addEventListener('click', ()=>{ state.credit += 10000; storage.set(keyCredit(), state.credit); updateCounts(); toast('Credito test aggiunto'); });

  // INIT
  loadAuth();
  loadMyCards();
  loadCards();
})();
</script>
</body>
</html>

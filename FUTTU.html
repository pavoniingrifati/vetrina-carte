<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>FUT Fantaballa Tik Tok ‚Äî Pack Unico (fix G/S/B infiniti)</title>
<meta name="description" content="Pack unico diviso per 'game' (Gotham City). Bronze / Silver / Gold ora infiniti (3 Oggetto + 6 serie), senza messaggio di esaurimento. Login e salvataggio inventario invariati.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b0f19; --panel:#0f1526; --card:#121a2e; --card-2:#0d1325; --text:#ecf0ff; --muted:#a7b0d3; --accent:#6ee7ff; --radius:18px;
  --g-comune:rgba(154,163,178,.30); --g-non-comune:rgba(52,211,153,.35); --g-rara:rgba(96,165,250,.45);
  --g-epica:rgba(167,139,250,.55); --g-ultra-rara:rgba(251,191,36,.65); --g-season:rgba(239,68,68,.7);
}
*{box-sizing:border-box} html,body{height:100%}
body{ margin:0; background: radial-gradient(1200px 800px at 10% -10%, #132040, transparent), var(--bg);
  color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow-x:hidden }
a{color:var(--accent); text-decoration:none}
header{ position:sticky; top:0; z-index:20; backdrop-filter: blur(10px);
  background:linear-gradient(180deg, rgba(13,19,37,.9), rgba(13,19,37,.6)); border-bottom:1px solid rgba(255,255,255,.06)}
.wrap{max-width:1200px; margin:0 auto; padding:20px}
.title{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
h1{margin:0; font-size:clamp(20px,3.6vw,34px)} .subtitle{color:var(--muted)}
.toolbar{display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; align-items:center}
.pill{display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:var(--text)}
.btn{background:linear-gradient(180deg,#1b2a4d,#152141); border:1px solid rgba(110,231,255,.35);
  border-radius:12px; color:#fff; padding:12px 16px; cursor:pointer}
.btn:disabled{opacity:.6; cursor:not-allowed}
/* PACK */
.packArea{display:flex; align-items:center; justify-content:center; min-height:min(76vh,900px); position:relative}
.pack{ width:min(520px,86vw); aspect-ratio:690/987; background: center/cover no-repeat;
  border-radius:var(--radius); box-shadow:0 8px 24px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.08); position:relative }
.stageWrap{display:none}
.stageWrap.show{display:block; animation:stageIn .5s ease .25s both}
@keyframes stageIn{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:none}}
.stage{margin:22px 0 40px; display:grid; gap:16px; grid-template-columns:repeat(1,minmax(0,1fr))}
@media(min-width:720px){.stage{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(min-width:1100px){.stage{grid-template-columns:repeat(3,minmax(0,1fr))}}
.cCard{position:relative; width:100%; aspect-ratio:690/987; border-radius:var(--radius); transform-style:preserve-3d; perspective:1200px}
.scene{position:absolute; inset:0; border-radius:inherit; box-shadow:0 10px 28px rgba(0,0,0,.45); background:var(--card);}
.face{position:absolute; inset:0; border-radius:inherit; overflow:hidden; border:1px solid rgba(255,255,255,.08);
  display:flex; align-items:center; justify-content:center}
.back img, .front img { width:100%; height:100%; object-fit:cover; display:block; aspect-ratio:690/987; }
.badge{position:absolute; top:10px; left:10px; padding:6px 8px; border-radius:10px; background:rgba(0,0,0,.35); font-size:12px}
.log{margin-top:8px; font-size:13px; color:var(--muted)}
footer{border-top:1px solid rgba(255,255,255,.06); background:linear-gradient(0deg, rgba(13,19,37,.85), rgba(13,19,37,.6))}
.foot{max-width:1200px; margin:0 auto; padding:12px 20px; font-size:13px; color:var(--muted)}
.pillFoot{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03)}
/* Simple choices strip */
.choices{ display:flex; gap:12px; margin-top:12px; flex-wrap:wrap }
.choice{ display:flex; align-items:center; gap:10px; padding:8px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.03); border-radius:14px; cursor:pointer; }
.choice[aria-selected="true"]{ outline:2px solid rgba(110,231,255,.5); background:rgba(255,255,255,.06) }
.prev{ width:90px; aspect-ratio: 690/987; border-radius:12px; background-size:cover; background-position:center;
  box-shadow:0 6px 16px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.08) }
.meta{ display:flex; flex-direction:column; line-height:1.15 }
.meta .name{ font-weight:700 }
.meta .price{ color:var(--muted); font-size:12px }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>FUTTU ‚Äì Pack Unico</h1>
        <div class="subtitle">
          Pacchetti esclusivi <b>Gotham City</b> ‚Äî Bronze/Silver/Gold ora <b>infiniti</b> (3 Oggetto + 6 serie).
        </div>
        <span class="pill" id="pricePill">üí∞ Costo: ‚Äî</span>
        <span class="pill" id="pointsBadge">Punti: ‚Äî</span>
        <button class="btn" id="openBtn">üéÅ Apri pacchetto</button>
        <a class="btn" href="https://pavoniingrifati.github.io/vetrina-carte/my-cards" id="myCardsBtn">üóÇÔ∏è Le mie carte</a>
        <button class="btn" id="bonusBtn">üéÅ Ottieni 1 punto</button>
        <a class="btn" href="https://pavoniingrifati.github.io/vetrina-carte/">üè† Torna alla Home</a>
      </div>
    </div>
    <div class="toolbar">
      <span class="pill" id="fairnessNote">üì¶ Pacchetti disponibili</span>
      <button class="btn" id="resetPacksBtn">‚ôªÔ∏è Reset pacchetti</button>
    </div>
    <div aria-label="Saldo" class="fc-balance-bar" id="balanceCenter" style="display:flex;gap:28px;justify-content:center;margin:18px 0;">
      <div class="fc-balance" style="display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.06);padding:10px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12)">
        <span class="fc-ico fc-coin" style="width:20px;height:20px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff8, #ffcc00);box-shadow:0 0 8px #ffcc00"></span>
        <b id="fc-coins">‚Äî</b>
      </div>
      <div class="fc-balance" style="display:flex;gap:10px;align-items:center;background:rgba(255,255,255,.06);padding:10px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12)">
        <span class="fc-ico fc-like" style="width:20px;height:20px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff8, #6ee7ff);box-shadow:0 0 8px #6ee7ff"></span>
        <b id="fc-likes">‚Äî</b>
      </div>
    </div>
    <div aria-label="Seleziona game" class="choices" id="gamePicker"></div>
    <div class="log" id="log" aria-live="polite"></div>
  </div>
</header>

<main class="wrap">
  <section class="packArea">
    <div class="pack" id="pack" title="Apri pacchetto"></div>
  </section>
  <section class="stageWrap" id="stageWrap">
    <div class="stage" id="stage" aria-live="polite"></div>
  </section>
</main>

<footer>
  <div class="foot">
    <span class="pillFoot">‚ÑπÔ∏è Resta tutto invariato: login Google, salvataggio inventario, condivisione.</span>
  </div>
</footer>

<!-- Template carta -->
<template id="tplCard">
  <article class="cCard">
    <div class="scene">
      <div class="face back">
        <img src="Deck%20back%20wonderkid.png" alt="Retro carta" loading="eager" decoding="async">
      </div>
      <div class="face front">
        <span class="badge"></span>
        <img alt="" loading="lazy" decoding="async">
      </div>
    </div>
  </article>
</template>

<!-- Firebase (v8) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDv23gasgBuAtPeDJeztyJ5P2S7NWq1svo",
  authDomain: "fantaball-9e19c.firebaseapp.com",
  projectId: "fantaball-9e19c",
  storageBucket: "fantaball-9e19c.appspot.com",
  messagingSenderId: "683304379837",
  appId: "1:683304379837:web:d2bbe7a814e2e40e075ed4",
  measurementId: "G-C8Q8K5B52C"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script type="module">
/* =========================
   COSTANTI E CONFIG
========================= */
const VALID_GAMES = ['Wonderkid','Patatine','Gotham Tots','Legend','Oggetti','Gold','Silver','Bronze', 'Strumenti', 'Frutto del Diavolo'];
const PACK_BACK_BY_GAME = {
  'Wonderkid': 'Deck%20back%20wonderkid.png',
  'Patatine': 'patatrine.png',
  'Gotham Tots': 'Deck%20back%20Tots.png',
  'Legend': 'Back%20legend.png',
  'Oggetti': 'Deck%20back%20tactcs.png',
  'Gold': 'Deck%20back%20oro%20BATMAN.png',
  'Silver': 'Deck%20back%20argento%20BATMAN.png',
  'Bronze': 'Deck%20back%20bronzo%20BATMAN.png',
  'Strumenti': 'Deck%20back%20strumenti.png',
  'Frutto del Diavolo': 'Back%20Deck%20ONE.png'
};
const PACK_COST_PER_GAME = {
  'Wonderkid': 1800, 'Patatine': 0, 'Gotham Tots': 0, 'Legend': 0, 'Oggetti': 0,
  'Gold': 0, 'Silver': 0, 'Bronze': 0, 'Strumenti': 0, 'Frutto del Diavolo': 0
};
const PACK_SIZE_PER_GAME = {
  'Wonderkid': 3,'Patatine': 1,'Gotham Tots': 3,'Legend': 3,'Oggetti': 3,
  'Gold': 9,'Silver': 9,'Bronze': 9,'Strumenti': 3,'Frutto del Diavolo': 3
};
const CONFIG = { CARDS_JSON: 'cards.json', FETCH_TIMEOUT_MS: 8000 };
/* =========================
   STATO
========================= */
const GAME_STATE = {
  selected: 'Wonderkid',
  pools:    Object.fromEntries(VALID_GAMES.map(g => [g, []])),
  packs:    Object.fromEntries(VALID_GAMES.map(g => [g, []])),
  cursor:   Object.fromEntries(VALID_GAMES.map(g => [g, 0]))
};
/* =========================
   AUTH + WALLET
========================= */
async function ensureGoogleUser() {
  const auth = firebase.auth();
  const u = auth.currentUser;
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });
  if (!u) {
    const { user } = await auth.signInWithPopup(provider);
    await user.getIdToken(true);
    return user;
  }
  if (u.isAnonymous) {
    const { user } = await u.linkWithPopup(provider);
    await user.getIdToken(true);
    return user;
  }
  await u.getIdToken(true);
  return u;
}
async function ensureWallet10() {
  const uid = firebase.auth().currentUser.uid;
  const ref = db.collection('users').doc(uid);
  await db.runTransaction(async (tx) => {
    const snap = await tx.get(ref);
    if (!snap.exists) {
      const now = firebase.firestore.FieldValue.serverTimestamp();
      tx.set(ref, { points: 10, createdAt: now, updatedAt: now });
    }
  });
}
async function getCurrentPoints(){
  const u = firebase.auth().currentUser;
  if (!u) return 0;
  const snap = await db.collection('users').doc(u.uid).get();
  return snap.exists ? Number(snap.data().points || 0) : 0;
}
/* =========================
   UI BASICA
========================= */
const $ = (s,el=document)=>el.querySelector(s);
const pointsBadge = $('#pointsBadge');
const openBtn = $('#openBtn');
const bonusBtn = $('#bonusBtn');
const resetPacksBtn = $('#resetPacksBtn');
const pricePill = $('#pricePill');
const packEl = $('#pack');
const stageWrap = $('#stageWrap');
const stage = $('#stage');
const logEl = $('#log');
function renderGamePicker(){
  const gp = $('#gamePicker');
  gp.innerHTML = '';
  for (const g of VALID_GAMES){
    const el = document.createElement('button');
    el.className = 'choice';
    el.setAttribute('aria-selected', g===GAME_STATE.selected ? 'true':'false');
    el.innerHTML = `
      <div class="prev" style="background-image:url('${PACK_BACK_BY_GAME[g]||PACK_BACK_BY_GAME['Wonderkid']}')"></div>
      <div class="meta">
        <span class="name">${g}</span>
        <span class="price">${PACK_COST_PER_GAME[g] ? (PACK_COST_PER_GAME[g]+' pt') : 'Gratis'}${(g==='Gold'||g==='Silver'||g==='Bronze')?' ‚Ä¢ ‚àû':''}</span>
      </div>`;
    el.onclick = ()=>{ GAME_STATE.selected = g; renderGamePicker(); applyPackVisual(); updateOpenBtnEnabled(); };
    gp.appendChild(el);
  }
}
function applyPackVisual(){
  const g = GAME_STATE.selected;
  const img = PACK_BACK_BY_GAME[g] || PACK_BACK_BY_GAME['Wonderkid'];
  packEl.style.backgroundImage = `url('${img}')`;
  pricePill.textContent = `üí∞ Costo: ${PACK_COST_PER_GAME[g]||0}`;
}
function updateOpenBtnEnabled(){
  openBtn.disabled = false; // sempre abilitato; il costo √® 0 per G/S/B
}
/* =========================
   AUDIO (semplice)
========================= */
let audioCtx=null;
function ensureAudio(){ try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)() }catch{} }
function tone(f,d=.15,g=.08,t='sine'){ if(!audioCtx) return; const o=audioCtx.createOscillator(),A=audioCtx.createGain(); o.type=t; o.frequency.value=f; A.gain.value=g; o.connect(A).connect(audioCtx.destination); o.start(); A.gain.setTargetAtTime(0,audioCtx.currentTime+d,.3); o.stop(audioCtx.currentTime+d+.08) }
/* =========================
   INVENTARIO
========================= */
const safeDocId = (id) => String(id || Math.random().toString(36).slice(2)).replace(/[\/#?\\[\\]]/g, '_').slice(0, 120);
async function saveInventario(cards) {
  const u = firebase.auth().currentUser;
  if (!u || u.isAnonymous) throw new Error('login-required');
  const batch = db.batch();
  const now = firebase.firestore.FieldValue.serverTimestamp();
  for (const c of cards) {
    const ref = db.collection('users').doc(u.uid).collection('inventory').doc(safeDocId(c.id));
    batch.set(ref, {
      name: c.name, rarity: c.rarity, series: c.series || '', img: c.img || '',
      count: firebase.firestore.FieldValue.increment(1), updatedAt: now
    }, { merge: true });
  }
  await batch.commit();
}
/* =========================
   DATI CARTE + POOLS
========================= */
const norm = (v)=>String(v||'').trim().toLowerCase();
function shuffleInPlace(a){ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function pickDistinct(source, n) {
  const arr = source.slice();
  for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  const seen = new Set(); const out = [];
  for (const c of arr) {
    if (!c || !c.id) continue;
    if (!seen.has(c.id)) { out.push(c); seen.add(c.id); if (out.length>=n) break; }
  }
  while (out.length < n && arr.length){
    const c = arr[Math.floor(Math.random()*arr.length)];
    if (c && c.id && !seen.has(c.id)) { out.push(c); seen.add(c.id); }
  }
  return out.slice(0, n);
}
function generateBSGOnTheFly(seriesName){
  try{
    const oggPool = GAME_STATE?.pools?.[seriesName + '_oggs'] || [];
    const mainPool = GAME_STATE?.pools?.[seriesName + '_main'] || [];
    const oggs = pickDistinct(oggPool, 3);
    const mains = pickDistinct(mainPool, 6);
    const out = [...oggs, ...mains];
    if (out.length < 9){
      const mix = [...oggPool, ...mainPool];
      while(out.length < 9 && mix.length){ out.push(mix[Math.floor(Math.random()*mix.length)]); }
    }
    return out.slice(0,9);
  } catch(e){ console.error('generateBSGOnTheFly error', e); return []; }
}
async function loadCards(){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),CONFIG.FETCH_TIMEOUT_MS);
  try{
    const res=await fetch(CONFIG.CARDS_JSON,{cache:'no-store',signal:ctrl.signal});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json=await res.json();
    if(!Array.isArray(json)) throw new Error('Formato non valido (atteso array)');
    const cleaned=[]; const ids=new Set();
    for(const c of json){
      if(!c||typeof c!=='object') continue;
      const id=c.id ?? `${(c.name||'card')}-${Math.random().toString(36).slice(2,8)}`;
      const name=String(c.name||''); const rarity=String(c.rarity||''); const img=String(c.img||'');
      const series=String(c.series||''); const game=String(c.game||''); const text=String(c.text||''); const tags=Array.isArray(c.tags)? c.tags.map(String):[];
      if(!name||!rarity||!img) continue;
      if(ids.has(id)) continue; ids.add(id);
      cleaned.push({id,name,rarity,img,series,game,text,tags});
    }
    const isGotham = (x)=> norm(x)==='gotham city';
    // Pools base
    GAME_STATE.pools['Wonderkid']   = cleaned.filter(c => isGotham(c.game) && norm(c.series)==='wonderkid');
    GAME_STATE.pools['Patatine']    = cleaned.filter(c => isGotham(c.game) && !['season','leggendaria'].includes(norm(c.rarity)));
    GAME_STATE.pools['Gotham Tots'] = cleaned.filter(c => isGotham(c.game) && norm(c.series)==='tots');
    GAME_STATE.pools['Legend']      = cleaned.filter(c => isGotham(c.game) && ['rara','epica','ultra rara','leggendaria'].includes(norm(c.rarity)));
    GAME_STATE.pools['Oggetti']     = cleaned.filter(c => norm(c.series)==='oggetto');
    GAME_STATE.pools['Strumenti']   = cleaned.filter(c => isGotham(c.game) && norm(c.series)==='strumento');
    GAME_STATE.pools['Frutto del Diavolo'] = cleaned.filter(c => norm(c.text) === 'frutto del diavolo');
    // Pools per Bronze/Silver/Gold infiniti
    GAME_STATE.pools['Bronze_oggs'] = cleaned.filter(c => norm(c.series) === 'oggetto');
    GAME_STATE.pools['Silver_oggs'] = cleaned.filter(c => norm(c.series) === 'oggetto');
    GAME_STATE.pools['Gold_oggs']   = cleaned.filter(c => norm(c.series) === 'oggetto');
    GAME_STATE.pools['Bronze_main'] = cleaned.filter(c => isGotham(c.game) && norm(c.series) === 'bronze');
    GAME_STATE.pools['Silver_main'] = cleaned.filter(c => isGotham(c.game) && norm(c.series) === 'silver');
    GAME_STATE.pools['Gold_main']   = cleaned.filter(c => isGotham(c.game) && norm(c.series) === 'gold');
    // Finite packs solo per alcune serie (se vuoi mantenerli)
    const buildFinitePacks=(cards,size)=>{
      const arr=shuffleInPlace(cards.slice()); const packs=[];
      for(let i=0;i<arr.length;i+=size){ packs.push(arr.slice(i,i+size)); }
      if(size>1 && packs.length>1 && packs[packs.length-1].length===1){
        const prev=packs[packs.length-2]; const last=packs[packs.length-1];
        if(prev.length>2){ last.unshift(prev.pop()); }
      }
      return packs.filter(p=>p.length>0);
    };
    GAME_STATE.packs['Wonderkid']   = buildFinitePacks(GAME_STATE.pools['Wonderkid'],   PACK_SIZE_PER_GAME['Wonderkid']);
    GAME_STATE.packs['Patatine']    = buildFinitePacks(GAME_STATE.pools['Patatine'],    PACK_SIZE_PER_GAME['Patatine']);
    GAME_STATE.packs['Gotham Tots'] = buildFinitePacks(GAME_STATE.pools['Gotham Tots'], PACK_SIZE_PER_GAME['Gotham Tots']);
    // IMPORTANTISSIMO: niente pacchi finiti per G/S/B
    GAME_STATE.packs['Gold'] = [];
    GAME_STATE.packs['Silver'] = [];
    GAME_STATE.packs['Bronze'] = [];
    renderGamePicker();
    applyPackVisual();
    updateOpenBtnEnabled();
    logEl.textContent =
      `Caricate: Wonderkid ${GAME_STATE.pools['Wonderkid'].length}, Patatine ${GAME_STATE.pools['Patatine'].length}, `+
      `TOTS ${GAME_STATE.pools['Gotham Tots'].length}, Legend ${GAME_STATE.pools['Legend'].length}, Oggetti ${GAME_STATE.pools['Oggetti'].length}.`;
  }catch(err){
    console.error('Errore cards.json:', err);
    logEl.textContent = '‚ö†Ô∏è Errore nel caricamento delle carte.';
  }finally{ clearTimeout(t) }
}
/* =========================
   RENDER CARTE
========================= */
function cardEl(c){
  const tpl = document.getElementById('tplCard');
  const el = tpl.content.firstElementChild.cloneNode(true);
  const badge = el.querySelector('.badge');
  const imgFront = el.querySelector('.front img');
  if (badge) badge.textContent = c.rarity||'';
  imgFront.src = c.img;
  imgFront.alt = c.name||'';
  return el;
}
function showCards(cards){
  stage.innerHTML='';
  for(const c of cards){ stage.appendChild(cardEl(c)); }
  stageWrap.classList.add('show');
  ensureAudio(); tone(880,.18,.08,'sine');
}
/* =========================
   LOGICA APERTURA
========================= */
openBtn.addEventListener('click', async () => {
  try{
    ensureAudio();
    const g = GAME_STATE.selected;
    let chosen = [];
    // Serie infinite B/S/G: genera 3+6 senza cursori n√© esaurimento
    if (g==='Bronze' || g==='Silver' || g==='Gold') {
      const og = GAME_STATE.pools[g + '_oggs'] || [];
      const mn = GAME_STATE.pools[g + '_main'] || [];
      if (!og.length || !mn.length) {
        logEl.textContent = '‚ö†Ô∏è Pool non pronta per questo game (mancano carte Oggetto o della serie).';
        return;
      }
      chosen = generateBSGOnTheFly(g);
    } else if (g==='Oggetti') {
      // infinito anche qui: 3 oggetti qualsiasi
      const og = GAME_STATE.pools['Oggetti'] || [];
      if (!og.length){ logEl.textContent='‚ö†Ô∏è Nessuna carta Oggetto disponibile.'; return; }
      chosen = pickDistinct(og, PACK_SIZE_PER_GAME['Oggetti']||3);
    } else {
      // serie finite: consumano dal vettore packs (se vuoto -> esaurito)
      const list = GAME_STATE.packs[g] || [];
      const idx = GAME_STATE.cursor[g] || 0;
      if (idx >= list.length){
        logEl.textContent = '‚ùå Pacchetti esauriti per questo game.';
        return;
      }
      chosen = list[idx].slice();
      GAME_STATE.cursor[g] = idx + 1;
      // salva cursore
      const saved = JSON.parse(localStorage.getItem('futtu_cursors')||'{}');
      saved[g] = GAME_STATE.cursor[g];
      localStorage.setItem('futtu_cursors', JSON.stringify(saved));
    }
    if (!chosen.length){ logEl.textContent='‚ö†Ô∏è Nessuna carta selezionata.'; return; }
    showCards(chosen);
    // salva inventario (best-effort)
    try{ await saveInventario(chosen); }catch(e){ console.warn('saveInventario', e); }
  } catch(e){
    console.error(e);
    logEl.textContent = '‚ö†Ô∏è Impossibile aprire il pacchetto al momento.';
  }
});
/* =========================
   BONUS 1 PUNTO / RESET
========================= */
if (bonusBtn){
  bonusBtn.addEventListener('click', async () => {
    try{
      let u = firebase.auth().currentUser;
      if (!u || u.isAnonymous) u = await ensureGoogleUser();
      await ensureWallet10();
      const ref = db.collection('users').doc(u.uid);
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        if (!snap.exists) throw new Error('wallet-missing');
        const pts = Number(snap.data().points || 0);
        const now = firebase.firestore.FieldValue.serverTimestamp();
        tx.update(ref, { points: pts + 1, lastDailyAt: now, updatedAt: now });
      });
      logEl.textContent = 'üéâ Bonus ottenuto! (max 1 ogni 24h)';
    }catch(e){
      logEl.textContent = '‚ö†Ô∏è Impossibile ottenere il bonus ora.';
    }
  });
}
if (resetPacksBtn){
  resetPacksBtn.addEventListener('click', () => {
    GAME_STATE.cursor = Object.fromEntries(Object.keys(GAME_STATE.cursor).map(k=>[k,0]));
    localStorage.setItem('futtu_cursors', JSON.stringify(GAME_STATE.cursor));
    logEl.textContent = '‚ôªÔ∏è Cursori dei pacchetti resettati.';
  });
}
/* =========================
   INIT
========================= */
window.addEventListener('load', async () => {
  try{
    const u = firebase.auth().currentUser;
    if (!u) { $('#pointsBadge').textContent = 'üîê Accedi con Google'; }
  }catch{}
  await loadCards();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FUT Fantaballa Tik Tok ‚Äî Gotham Packs (aggiornato)</title>
<meta name="description" content="Pack Gotham City con Bronze, Silver e Gold infiniti: ogni pack contiene 3 carte Oggetto + 6 carte della serie corrispondente. Login e inventario invariati."/>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>

<style>
:root{
  --bg:#0b0f19; --panel:#0f1526; --card:#121a2e; --card-2:#0d1325;
  --text:#ecf0ff; --muted:#a7b0d3; --accent:#6ee7ff; --radius:18px;
  --g-comune:rgba(154,163,178,.30); --g-non-comune:rgba(52,211,153,.35); --g-rara:rgba(96,165,250,.45);
  --g-epica:rgba(167,139,250,.55); --g-ultra-rara:rgba(251,191,36,.65); --g-season:rgba(239,68,68,.7);
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; background: radial-gradient(1200px 800px at 10% -10%, #132040, transparent), var(--bg);
  color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; overflow-x:hidden
}
a{color:var(--accent); text-decoration:none}
.wrap{max-width:1200px; margin:0 auto; padding:20px}
h1{margin:0; font-size:clamp(20px,3.6vw,34px)}
.subtitle{color:var(--muted)}
.pill{display:inline-flex; align-items:center; gap:6px; padding:10px 14px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:var(--text)}
.btn{background:linear-gradient(180deg,#1b2a4d,#152141); border:1px solid rgba(110,231,255,.35);
  border-radius:12px; color:#fff; padding:12px 16px; cursor:pointer}
.btn:disabled{opacity:.6; cursor:not-allowed}

header{ position:sticky; top:56px; z-index:20; backdrop-filter: blur(10px);
  background:linear-gradient(180deg, rgba(13,19,37,.9), rgba(13,19,37,.6)); border-bottom:1px solid rgba(255,255,255,.06)}

.fc-topbar{
  position:sticky; top:0; z-index:50; height:56px;
  display:flex; align-items:center; justify-content:space-between;
  padding:0 16px; gap:16px;
  background:linear-gradient(180deg, rgba(10,16,38,.96), rgba(10,16,38,.72));
  border-bottom:1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(10px);
}
.fc-left{ display:flex; gap:24px; align-items:center; }
.fc-brand{ display:flex; gap:10px; align-items:center; color:#eaf0ff; font-weight:800; letter-spacing:.2px }
.fc-shield{ display:inline-grid; place-items:center; width:28px;height:28px;border-radius:8px;
  background:linear-gradient(180deg,#1f2a4a,#121a36); border:1px solid rgba(255,255,255,.18); font-weight:900 }
.fc-right{ display:flex; gap:12px; align-items:center }
.fc-prof{ width:28px; height:28px; border-radius:999px; background:linear-gradient(180deg,#29345a,#111833); border:1px solid rgba(255,255,255,.12); display:grid; place-items:center }
.fc-prof .dot{ width:6px; height:6px; border-radius:999px; background:#6ee7ff; box-shadow:0 0 8px #6ee7ff }

/* Sidebar */
.fc-sidebar{
  position:fixed; top:56px; left:0; bottom:0; width:240px;
  background:linear-gradient(180deg, rgba(12,18,40,.92), rgba(12,18,40,.76));
  border-right:1px solid rgba(255,255,255,.08);
  padding:14px 10px; z-index:30; backdrop-filter: blur(6px);
}
.fc-sidebar ul{ list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:4px }
.fc-sidebar li{ color:#c6d0f8; padding:10px 12px; border-radius:10px; user-select:none }
.fc-sidebar li.title{ color:#94a2d8; font-weight:700; text-transform:uppercase; font-size:12px; letter-spacing:.6px; margin-top:8px }
.fc-sidebar li.active{ background: rgba(110,231,255,.08); border:1px solid rgba(110,231,255,.28); color:#eaf3ff }

/* Shift layout */
.wrap{ margin-left: calc(240px + 16px); }
@media(max-width: 980px){ .fc-sidebar{ display:none } .wrap{ margin-left:auto } }

/* Packs strip */
.packs-sticky{ position: sticky; top: calc(56px + 6px); z-index: 48;
  background: linear-gradient(180deg, rgba(10,16,38,.95), rgba(10,16,38,.82));
  border-bottom: 1px solid rgba(255,255,255,.08); backdrop-filter: blur(8px) }
.featured-carousel{ display:flex; overflow-x:auto; gap:12px; padding:12px 0 }
.featured-card{ flex:0 0 auto; width:160px; text-align:center; background:#1e1e1e; border-radius:12px; padding:10px; cursor:pointer; transition:transform .2s }
.featured-card:hover{ transform:scale(1.05) }
.featured-card img{ width:100%; border-radius:10px }
.featured-cost{ margin-top:6px; font-weight:700; color:#fff }

/* Pack + Stage */
.packArea{display:flex; align-items:center; justify-content:center; min-height:min(70vh,820px); position:relative}
.pack{ width:min(520px,86vw); aspect-ratio:690/987; background: center/cover no-repeat;
  border-radius:var(--radius); box-shadow:0 8px 24px rgba(0,0,0,.5), 0 0 0 1px rgba(255,255,255,.08); transition:transform .2s ease, box-shadow .2s ease, filter .2s ease; position:relative }
.pack:hover{ transform:translateY(-2px); box-shadow:0 20px 60px rgba(0,0,0,.55), 0 0 0 1px rgba(255,255,255,.12); filter:brightness(1.05)}

.stageWrap{display:none}
.stageWrap.show{display:block; animation:stageIn .5s ease .25s both}
@keyframes stageIn{from{opacity:0; transform:translateY(8px)}to{opacity:1; transform:none}}
.stage{margin:22px 0 40px; display:grid; gap:16px; grid-template-columns:repeat(1,minmax(0,1fr))}
@media(min-width:720px){.stage{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(min-width:1100px){.stage{grid-template-columns:repeat(3,minmax(0,1fr))}}

.cCard{position:relative; width:100%; aspect-ratio:690/987; border-radius:var(--radius); transform-style:preserve-3d; perspective:1200px}
.scene{position:absolute; inset:0; border-radius:inherit; transform-style:preserve-3d; transition:transform .7s cubic-bezier(.22,.75,.2,1);
  transform:rotateY(0deg); box-shadow:0 10px 28px rgba(0,0,0,.45); background:var(--card); will-change:transform}
.face{position:absolute; inset:0; border-radius:inherit; overflow:hidden; backface-visibility:hidden; border:1px solid rgba(255,255,255,.08);
  display:flex; align-items:center; justify-content:center}
.back img, .front img { width:100%; height:100%; object-fit:cover; display:block; aspect-ratio:690/987; }
.front{transform:rotateY(180deg)}
.badge{position:absolute; top:10px; left:10px; padding:6px 8px; border-radius:10px; background:rgba(0,0,0,.35); font-size:12px}

.log{margin-top:8px; font-size:13px; color:var(--muted)}
footer{border-top:1px solid rgba(255,255,255,.06); background:linear-gradient(0deg, rgba(13,19,37,.85), rgba(13,19,37,.6))}
.foot{max-width:1200px; margin:0 auto; padding:12px 20px; font-size:13px; color:var(--muted)}

.pillFoot{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.03)}
</style>
</head>
<body>
<!-- Topbar -->
<div class="fc-topbar">
  <div class="fc-left">
    <div class="fc-brand"><span class="fc-shield">UT</span><strong>EA SPORTS FC 25</strong></div>
    <nav class="fc-nav">
      <a class="is-active">Home</a>
      <a>Store</a>
      <a>Browse</a>
    </nav>
  </div>
  <div class="fc-right">
    <div class="fc-prof"><span class="dot"></span></div>
  </div>
</div>

<!-- Sidebar -->
<aside class="fc-sidebar">
  <ul>
    <li class="title">Store</li>
    <li class="active" data-section="featured">Featured</li>
    <li data-section="base">Pacchetti base</li>
    <li data-section="all">Tutti i pacchi</li>
  </ul>
</aside>

<header>
  <div class="wrap">
    <div class="title">
      <div>
        <h1>FUTTU ‚Äì Pack Gotham City</h1>
        <div class="subtitle">Pacchetti <b>Bronze / Silver / Gold</b> <u>infiniti</u>: 3 Oggetti + 6 serie.</div>
        <span class="pill" id="pricePill">üí∞ Costo: ‚Äî</span>
        <span class="pill" id="pointsBadge">Punti: ‚Äî</span>
        <button class="btn" id="openBtn">üéÅ Apri pacchetto</button>
        <a class="btn" id="myCardsBtn" href="https://pavoniingrifati.github.io/vetrina-carte/my-cards">üóÇÔ∏è Le mie carte</a>
        <button class="btn" id="bonusBtn">üéÅ Ottieni 1 punto</button>
        <a class="btn" href="https://pavoniingrifati.github.io/vetrina-carte/">üè† Home</a>
      </div>
    </div>
    <div class="toolbar">
      <span class="pill" id="fairnessNote">üì¶ Pacchetti disponibili: ‚àû per Bronze/Silver/Gold</span>
      <button class="btn" id="resetPacksBtn">‚ôªÔ∏è Reset cursori</button>
    </div>
    <div class="fc-balance-bar" id="balanceCenter" style="display:flex; gap:28px; align-items:center; margin:20px 0">
      <div class="fc-balance" style="display:flex; align-items:center; gap:10px; background:linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); padding:14px 22px; border-radius:18px; border:1px solid rgba(255,255,255,.18); box-shadow:0 6px 18px rgba(0,0,0,.4)">
        <span class="fc-ico fc-coin" style="width:28px;height:28px;border-radius:50%;background: radial-gradient(circle at 30% 30%, #fff8, #ffcc00); box-shadow:0 0 14px #ffcc00"></span>
        <b contenteditable="true" id="fc-coins" style="font-size:1.6rem;font-weight:700;min-width:70px;text-align:right;letter-spacing:.5px">5,360</b>
      </div>
      <div class="fc-balance" style="display:flex; align-items:center; gap:10px; background:linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); padding:14px 22px; border-radius:18px; border:1px solid rgba(255,255,255,.18); box-shadow:0 6px 18px rgba(0,0,0,.4)">
        <span class="fc-ico fc-like" style="width:28px;height:28px;border-radius:50%;background: radial-gradient(circle at 30% 30%, #fff8, #6ee7ff); box-shadow:0 0 14px #6ee7ff"></span>
        <b contenteditable="true" id="fc-likes" style="font-size:1.6rem;font-weight:700;min-width:70px;text-align:right;letter-spacing:.5px">550</b>
      </div>
    </div>
    <div class="log" id="log" aria-live="polite"></div>
  </div>
</header>

<!-- Sticky strip -->
<div class="packs-sticky">
  <div class="wrap">
    <div class="featured-carousel" id="packsStrip"></div>
  </div>
</div>

<main class="wrap">
  <section class="packArea">
    <div class="pack" id="pack" title="Apri pacchetto"></div>
  </section>

  <section class="stageWrap" id="stageWrap">
    <div class="stage" id="stage" aria-live="polite"></div>
  </section>
</main>

<footer>
  <div class="foot">
    <span class="pillFoot">‚ÑπÔ∏è Login Google, salvataggio inventario e condivisione invariati.</span>
  </div>
</footer>

<!-- Card template -->
<template id="tplCard">
  <article class="cCard drop" data-state="back">
    <div class="scene">
      <div class="face back">
        <img src="Deck%20back%20wonderkid.png" alt="Retro carta" loading="eager" decoding="async"/>
      </div>
      <div class="face front">
        <span class="badge"></span>
        <img alt="" loading="lazy" decoding="async"/>
      </div>
    </div>
  </article>
</template>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDv23gasgBuAtPeDJeztyJ5P2S7NWq1svo",
  authDomain: "fantaball-9e19c.firebaseapp.com",
  projectId: "fantaball-9e19c",
  storageBucket: "fantaball-9e19c.appspot.com",
  messagingSenderId: "683304379837",
  appId: "1:683304379837:web:d2bbe7a814e2e40e075ed4",
  measurementId: "G-C8Q8K5B52C"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<script type="module">
/* =========================
 * CONFIG & CONSTANTS
 * ========================= */
const VALID_GAMES = ['Bronze','Silver','Gold','Oggetti'];
const PACK_BACK_BY_GAME = {
  'Bronze': 'Deck%20back%20bronzo%20BATMAN.png',
  'Silver': 'Deck%20back%20argento%20BATMAN.png',
  'Gold':   'Deck%20back%20oro%20BATMAN.png',
  'Oggetti':'Deck%20back%20tactcs.png'
};
const PACK_COST_PER_GAME = { Bronze:0, Silver:0, Gold:0, Oggetti:0 };
const PACK_SIZE_PER_GAME = { Bronze:9, Silver:9, Gold:9, Oggetti:3 };
const CONFIG = { CARDS_JSON: 'cards.json', FETCH_TIMEOUT_MS: 8000 };

/* =========================
 * AUTH + WALLET (invariati)
 * ========================= */
async function ensureGoogleUser() {
  const auth = firebase.auth();
  const u = auth.currentUser;
  const provider = new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({ prompt: 'select_account' });
  try {
    if (!u) {
      const { user } = await auth.signInWithPopup(provider);
      await user.getIdToken(true);
      return user;
    }
    if (u.isAnonymous) {
      const { user } = await u.linkWithPopup(provider);
      await user.getIdToken(true);
      return user;
    }
    await u.getIdToken(true);
    return u;
  } catch (e) {
    if (e.code === 'auth/popup-blocked' || e.code === 'auth/operation-not-supported-in-this-environment') {
      if (!u) { await firebase.auth().signInWithRedirect(provider); throw new Error('redirecting'); }
      if (u.isAnonymous) { await u.linkWithRedirect(provider); throw new Error('redirecting'); }
    }
    throw e;
  }
}
async function ensureWallet10() {
  const uid = firebase.auth().currentUser?.uid;
  if (!uid) return;
  const ref = db.collection('users').doc(uid);
  await db.runTransaction(async (tx) => {
    const snap = await tx.get(ref);
    if (!snap.exists) {
      const now = firebase.firestore.FieldValue.serverTimestamp();
      tx.set(ref, { points: 10, createdAt: now, updatedAt: now });
    }
  });
}
async function getCurrentPoints(){
  const u = firebase.auth().currentUser;
  if (!u) return 0;
  const snap = await db.collection('users').doc(u.uid).get();
  return snap.exists ? Number(snap.data().points || 0) : 0;
}

/* =========================
 * UI refs
 * ========================= */
const pricePill   = document.getElementById('pricePill');
const pointsBadge = document.getElementById('pointsBadge');
const openBtn     = document.getElementById('openBtn');
const bonusBtn    = document.getElementById('bonusBtn');
const resetPacksBtn = document.getElementById('resetPacksBtn');
const packsStrip  = document.getElementById('packsStrip');
const packEl      = document.getElementById('pack');
const stageWrap   = document.getElementById('stageWrap');
const stage       = document.getElementById('stage');
const logEl       = document.getElementById('log');

/* =========================
 * STATE
 * ========================= */
const GAME_STATE = {
  selected: 'Gold',
  pools:    { Bronze:[], Silver:[], Gold:[], Oggetti:[] },
  dynamic:  { Bronze:true, Silver:true, Gold:true }, // INFINTI
};

function $(s, el=document){ return el.querySelector(s); }
function norm(v){ return String(v||'').trim().toLowerCase(); }
function shuffleInPlace(a){ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }

/* Distinct picker */
function pickDistinct(source, n) {
  const arr = source.slice();
  for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  const seen = new Set();
  const out = [];
  for (const c of arr) {
    if (!c || !c.id) continue;
    if (!seen.has(c.id)) { out.push(c); seen.add(c.id); if (out.length>=n) break; }
  }
  while (out.length < n && arr.length) {
    const c = arr[Math.floor(Math.random()*arr.length)];
    if (c && c.id && !seen.has(c.id)) { out.push(c); seen.add(c.id); }
  }
  return out.slice(0, n);
}

/* =========================
 * LOAD CARDS & BUILD POOLS
 * ========================= */
async function loadCards(){
  const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(), CONFIG.FETCH_TIMEOUT_MS);
  try{
    const res = await fetch(CONFIG.CARDS_JSON, { cache:'no-store', signal: ctrl.signal });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if (!Array.isArray(json)) throw new Error('Formato non valido: atteso array');

    const cleaned=[]; const ids=new Set();
    for(const c of json){
      if(!c||typeof c!=='object') continue;
      const id=c.id ?? `${(c.name||'card')}-${Math.random().toString(36).slice(2,8)}`;
      const name=String(c.name||''); const rarity=String(c.rarity||''); const img=String(c.img||'');
      const series=String(c.series||''); const game=String(c.game||''); const text=String(c.text||''); const tags=Array.isArray(c.tags)? c.tags.map(String):[];
      if(!name||!rarity||!img) continue;
      if(ids.has(id)) continue; ids.add(id);
      cleaned.push({id,name,rarity,img,series,game,text,tags});
    }

    const isGotham = (x)=> norm(x)==='gotham city';

    // Pools
    GAME_STATE.pools['Oggetti'] = cleaned.filter(c => norm(c.series)==='oggetto'); // oggetti da qualsiasi game

    GAME_STATE.pools['Bronze']  = cleaned.filter(c => isGotham(c.game) && norm(c.series)==='bronze');
    GAME_STATE.pools['Silver']  = cleaned.filter(c => isGotham(c.game) && norm(c.series)==='silver');
    GAME_STATE.pools['Gold']    = cleaned.filter(c => isGotham(c.game) && norm(c.series)==='gold');

    renderPacksStrip();
    applyPackVisual();
    updateOpenBtnEnabled();
    logEl.textContent = `Pools: Oggetti ${GAME_STATE.pools['Oggetti'].length}, Bronze ${GAME_STATE.pools['Bronze'].length}, Silver ${GAME_STATE.pools['Silver'].length}, Gold ${GAME_STATE.pools['Gold'].length}.`;
  }catch(err){
    console.error('Errore cards.json:', err?.message||err);
    logEl.textContent = '‚ö†Ô∏è Errore nel caricamento delle carte (cards.json).';
  }finally{ clearTimeout(t); }
}

/* =========================
 * PACK GENERATION (INFINITI B/S/G)
 * ========================= */
function generateBSGOnTheFly(seriesName){
  try{
    const oggPool = GAME_STATE.pools['Oggetti'] || [];
    const mainPool = GAME_STATE.pools[seriesName] || [];
    const oggs = pickDistinct(oggPool, 3);
    const mains = pickDistinct(mainPool, 6);
    const out = [...oggs, ...mains];
    return out.slice(0, 9);
  } catch(e){
    console.error('generateBSGOnTheFly error', e);
    return [];
  }
}

/* =========================
 * INVENTORY SAVE
 * ========================= */
const safeDocId = (id) => String(id || Math.random().toString(36).slice(2)).replace(/[\/#?\[\]]/g, '_').slice(0, 120);
async function saveInventario(cards) {
  const u = firebase.auth().currentUser;
  if (!u || u.isAnonymous) throw new Error('login-required');
  const batch = db.batch();
  const now = firebase.firestore.FieldValue.serverTimestamp();
  for (const c of cards) {
    const ref = db.collection('users').doc(u.uid).collection('inventory').doc(safeDocId(c.id));
    batch.set(ref, {
      name: c.name, rarity: c.rarity, series: c.series || '', img: c.img || '',
      count: firebase.firestore.FieldValue.increment(1), updatedAt: now
    }, { merge: true });
  }
  await batch.commit();
}

/* =========================
 * UI HELPERS
 * ========================= */
function renderPacksStrip(){
  if (!packsStrip) return;
  packsStrip.innerHTML = '';
  for (const game of VALID_GAMES){
    const imgSrc = PACK_BACK_BY_GAME[game] || 'patatrine.png';
    const cost = Number(PACK_COST_PER_GAME[game] || 0);
    const card = document.createElement('div');
    card.className = 'featured-card';
    card.innerHTML = `
      <img src="${imgSrc}" alt="${game}"/>
      <div style="margin-top:6px; font-weight:800">${game}</div>
      <div class="featured-cost">${cost>0?cost+' pt':'Gratis'}</div>
    `;
    card.addEventListener('click', () => { GAME_STATE.selected = game; applyPackVisual(); updateOpenBtnEnabled(); });
    packsStrip.appendChild(card);
  }
}
function applyPackVisual(){
  const g = GAME_STATE.selected;
  packEl.style.backgroundImage = `url('${PACK_BACK_BY_GAME[g] || 'Deck%20back%20tactcs.png'}')`;
  pricePill.textContent = `üí∞ Costo: ${PACK_COST_PER_GAME[g]||0} pt`;
}
function updateOpenBtnEnabled(){ openBtn.disabled = false; }

function createCardEl(card){
  const tpl = document.getElementById('tplCard');
  const node = tpl.content.firstElementChild.cloneNode(true);
  const frontImg = node.querySelector('.front img');
  const badge = node.querySelector('.badge');
  frontImg.src = card.img;
  frontImg.alt = card.name || '';
  badge.textContent = `${card.series || ''}`.trim();
  node.dataset.state = 'front';
  return node;
}
function renderCards(cards){
  stageWrap.classList.add('show');
  stage.innerHTML = '';
  const frag = document.createDocumentFragment();
  for (const c of cards){ frag.appendChild(createCardEl(c)); }
  stage.appendChild(frag);
}

/* =========================
 * BONUS BTN (demo: 1 punto/day su Firestore)
 * ========================= */
if (bonusBtn) {
  bonusBtn.addEventListener('click', async () => {
    try{
      let u = firebase.auth().currentUser;
      if (!u || u.isAnonymous) u = await ensureGoogleUser();
      await ensureWallet10();
      const ref = db.collection('users').doc(u.uid);
      await db.runTransaction(async (tx) => {
        const snap = await tx.get(ref);
        const pts = snap.exists ? Number(snap.data().points||0) : 0;
        const now = firebase.firestore.FieldValue.serverTimestamp();
        tx.set(ref, { points: pts + 1, lastDailyAt: now, updatedAt: now }, { merge:true });
      });
      pointsBadge.textContent = `Punti: ${await getCurrentPoints()}`;
      logEl.textContent = 'üéâ Bonus ottenuto!';
    }catch(e){
      console.error(e); logEl.textContent = '‚ö†Ô∏è Impossibile ottenere il bonus ora.';
    }
  });
}

/* =========================
 * INIT + OPEN PACK
 * ========================= */
async function init(){
  try{
    const user = firebase.auth().currentUser;
    if (!user) {
      pointsBadge.textContent = 'üîê Accedi con Google';
      pointsBadge.style.cursor = 'pointer';
      pointsBadge.onclick = async () => {
        try {
          const u = await ensureGoogleUser();
          if (!u) return;
          await ensureWallet10();
          pointsBadge.onclick = null;
          pointsBadge.style.cursor = 'default';
          pointsBadge.textContent = `Punti: ${await getCurrentPoints()}`;
        } catch (e) { if (e.message !== 'redirecting') console.error(e); }
      };
    } else {
      await ensureWallet10();
      pointsBadge.textContent = `Punti: ${await getCurrentPoints()}`;
    }
  } catch(e){ console.error(e); }

  await loadCards();
}
init();

openBtn.addEventListener('click', async () => {
  const g = GAME_STATE.selected;
  try{
    // Pacchi infiniti per B/S/G
    let cards = [];
    if (GAME_STATE.dynamic?.[g]) {
      cards = generateBSGOnTheFly(g);
    } else if (g === 'Oggetti') {
      cards = pickDistinct(GAME_STATE.pools['Oggetti'], PACK_SIZE_PER_GAME['Oggetti']||3);
    } else {
      // fallback: 9 random dal pool
      const pool = GAME_STATE.pools[g] || [];
      cards = pickDistinct(pool, PACK_SIZE_PER_GAME[g]||9);
    }

    if (!cards.length){ logEl.textContent = '‚ö†Ô∏è Nessuna carta trovata per questo pack.'; return; }

    renderCards(cards);

    // salva inventario se loggato
    try { await saveInventario(cards); } catch(e){ /* ok se non loggato */ }

    logEl.textContent = `Aperto ${g}: ${cards.length} carte (3 Oggetti + 6 ${g} per B/S/G).`;
  }catch(e){
    console.error(e);
    logEl.textContent = '‚ö†Ô∏è Errore apertura pacchetto.';
  }
});

resetPacksBtn.addEventListener('click', () => {
  // Non abbiamo cursori da resettare nei pacchi infiniti, ma azzeriamo la stage
  stage.innerHTML = ''; stageWrap.classList.remove('show');
  logEl.textContent = '‚úÖ Reset effettuato.';
});

</script>
</body>
</html>

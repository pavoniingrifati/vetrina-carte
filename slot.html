<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Slot Classica (Big)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#050814;
      --panel: rgba(255,255,255,.07);
      --border: rgba(255,255,255,.16);
      --text:#eef3ff;
      --gold:#ffd36a;
      --shadow: 0 24px 90px rgba(0,0,0,.65);
      --r:34px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(255,211,106,.18), transparent 62%),
        radial-gradient(1200px 800px at 120% 10%, rgba(255,77,109,.10), transparent 62%),
        radial-gradient(1200px 800px at 50% 110%, rgba(77,255,184,.10), transparent 62%),
        var(--bg);
      color:var(--text);
      display:grid;
      place-items:center;
      padding:18px;
    }

    .machine{
      width:min(1600px, 98vw);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
      padding:26px;
    }
    .machine::before{
      content:"";
      position:absolute; inset:-60%;
      background:conic-gradient(from 120deg, rgba(255,255,255,0), rgba(255,255,255,.18), rgba(255,255,255,0));
      animation:shine 11s linear infinite;
      opacity:.20;
      pointer-events:none;
    }
    @keyframes shine{to{transform:rotate(360deg)}}

    .header{
      position:relative;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:14px;
      padding-bottom:18px;
      z-index:1;
    }
    .title{
      font-size:clamp(26px, 3.2vw, 44px);
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      text-shadow:0 14px 55px rgba(0,0,0,.45);
    }
    .win{
      margin-left:auto;
      background:linear-gradient(180deg, #03050b, #0b1022);
      border:1px solid rgba(255,255,255,.14);
      border-radius:20px;
      padding:12px 16px;
      min-width: 220px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.55);
      text-align:center;
      z-index:1;
    }
    .win .lbl{font-size:12px;letter-spacing:.22em;opacity:.75}
    .win .val{
      margin-top:6px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:34px;
      font-weight:900;
      letter-spacing:.14em;
      color:var(--gold);
      text-shadow: 0 0 18px rgba(255,211,106,.25);
      user-select:none;
    }

    .cabinet{
      position:relative;
      z-index:1;
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:18px;
      align-items:stretch;
    }
    @media(max-width:980px){
      .cabinet{grid-template-columns:1fr;}
      .lever{height:140px}
    }

    .reelBox{
      background:linear-gradient(180deg, rgba(0,0,0,.30), rgba(0,0,0,.16));
      border:1px solid rgba(255,255,255,.16);
      border-radius:30px;
      padding:20px;
      position:relative;
      overflow:hidden;
    }
    .marquee{
      height:44px;
      border-radius:22px;
      display:flex;align-items:center;justify-content:center;
      background:linear-gradient(90deg, rgba(255,77,109,.20), rgba(255,211,106,.22), rgba(77,255,184,.16));
      border:1px solid rgba(255,255,255,.12);
      font-weight:900;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-size:13px;
      margin-bottom:16px;
    }
    .reels{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:18px;
      align-items:stretch;
    }
    .window{
      border-radius:26px;
      border:3px solid rgba(255,255,255,.16);
      background:rgba(0,0,0,.32);
      overflow:hidden;
      aspect-ratio: 690/987;
      position:relative;
      box-shadow: inset 0 0 0 3px rgba(0,0,0,.35);
    }
    .strip{position:absolute;left:0;top:0;right:0; transform:translateY(0); will-change:transform;}
    .card{width:100%; aspect-ratio: 690/987; display:block; object-fit:cover; background:#070b18; border-bottom:1px solid rgba(255,255,255,.10);}
    .payline{
      position:absolute; left:7%; right:7%; top:50%;
      height:5px; transform:translateY(-50%);
      background:linear-gradient(90deg, transparent, rgba(255,211,106,.98), transparent);
      filter:drop-shadow(0 0 14px rgba(255,211,106,.6));
      opacity:.98;
      pointer-events:none;
    }
    .frame{position:absolute; inset:0; border-radius:26px; box-shadow: inset 0 0 0 2px rgba(255,255,255,.08), inset 0 -90px 120px rgba(0,0,0,.42); pointer-events:none;}

    .flash{
      position:absolute; inset:0;
      display:grid; place-items:center;
      background:radial-gradient(circle at 50% 50%, rgba(255,211,106,.18), rgba(0,0,0,0) 55%);
      opacity:0; pointer-events:none;
      transition:opacity .22s ease;
      z-index:3;
    }
    .flash.show{opacity:1}
    .flash .banner{
      padding:14px 18px;
      border-radius:999px;
      background:linear-gradient(135deg, rgba(255,211,106,.30), rgba(255,77,109,.18));
      border:1px solid rgba(255,255,255,.22);
      box-shadow:0 18px 55px rgba(0,0,0,.55);
      font-weight:900;
      letter-spacing:.18em;
      text-transform:uppercase;
    }

    .lever{
      border-radius:30px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px 12px;
      position:relative;
      overflow:hidden;
      min-height: 520px;
    }
    .rail{
      width:16px;
      height:100%;
      border-radius:999px;
      background:linear-gradient(180deg, #cfd6ea, #6b7692);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35), 0 18px 48px rgba(0,0,0,.35);
      position:relative;
    }
    .knob{
      width:56px;height:56px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, #fff, #ff7a92 40%, #c71f43 72%);
      box-shadow: 0 18px 38px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.18);
      position:absolute; left:50%; transform:translateX(-50%);
      top:18px;
      transition: top .18s ease;
    }
    .lever.pull .knob{ top: calc(100% - 74px); }

    .spinBtn{
      position:absolute;
      bottom:14px; left:14px; right:14px;
      border:0; cursor:pointer;
      padding:16px 10px;
      border-radius:20px;
      font-weight:900;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#08101c;
      background:linear-gradient(135deg, var(--gold), rgba(255,211,106,.65));
      box-shadow: 0 18px 55px rgba(0,0,0,.45);
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .spinBtn:hover{filter:brightness(1.04)}
    .spinBtn:active{transform:translateY(1px)}
    .spinBtn:disabled{opacity:.6; cursor:not-allowed}
  </style>
</head>
<body>
  <section class="machine">
    <div class="header">
      <div class="title">SLOT CLASSICA</div>
      <div class="win" aria-label="Vincita ultimo spin">
        <div class="lbl">VINCITA</div>
        <div class="val" id="lastWin">0000</div>
      </div>
    </div>

    <div class="cabinet">
      <div class="reelBox">
        <div class="marquee">LUCKY CARDS</div>
        <div class="reels">
          <div class="window"><div class="strip" id="strip0"></div><div class="payline"></div><div class="frame"></div></div>
          <div class="window"><div class="strip" id="strip1"></div><div class="payline"></div><div class="frame"></div></div>
          <div class="window"><div class="strip" id="strip2"></div><div class="payline"></div><div class="frame"></div></div>
        </div>
        <div class="flash" id="flash" aria-hidden="true"><div class="banner" id="flashText">+60</div></div>
      </div>

      <div class="lever" id="lever" aria-label="Leva">
        <div class="rail"><div class="knob"></div></div>
        <button class="spinBtn" id="spinBtn">SPIN</button>
      </div>
    </div>
  </section>

<script>
const DEFAULT_CARDS = [{'id': 'd1', 'name': 'Carta Comune', 'rarity': 'Comune', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3ECOMUNE%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3E%2B60..%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd2', 'name': 'Carta Comune 2', 'rarity': 'Comune', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3ECOMUNE%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3EStarter%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd3', 'name': 'Carta Non Comune', 'rarity': 'Non Comune', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3ENON%20COMUNE%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3ELucky%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd4', 'name': 'Carta Rara', 'rarity': 'Rara', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3ERARA%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3ENice%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd5', 'name': 'Carta Epica', 'rarity': 'Epica', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3EEPICA%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3EWow%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd6', 'name': 'Carta Ultra Rara', 'rarity': 'Ultra Rara', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3EULTRA%20RARA%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3E%F0%9F%94%A5%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd7', 'name': 'Carta Leggendaria', 'rarity': 'Leggendaria', 'series': 'Leggendaria', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3ELEGGENDARIA%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3E%E2%AD%90%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd8', 'name': 'Carta Season', 'rarity': 'Season', 'series': 'Season', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3ESEASON%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3E%E9%99%90%E5%AE%9A%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd9', 'name': 'Carta Rara 2', 'rarity': 'Rara', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3ERARA%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3Ex%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd10', 'name': 'Carta Epica 2', 'rarity': 'Epica', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3EEPICA%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3Ex%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd11', 'name': 'Carta Ultra Rara 2', 'rarity': 'Ultra Rara', 'series': 'Base', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3EULTRA%20RARA%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3Ex%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}, {'id': 'd12', 'name': 'Carta Leggendaria 2', 'rarity': 'Leggendaria', 'series': 'Leggendaria', 'game': 'Default', 'img': 'data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22690%22%20height%3D%22987%22%3E%0A%20%20%20%20%3Cdefs%3E%0A%20%20%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%220%22%20stop-color%3D%22%231b2a5a%22/%3E%0A%20%20%20%20%20%20%20%20%3Cstop%20offset%3D%221%22%20stop-color%3D%22%236a2aa6%22/%3E%0A%20%20%20%20%20%20%3C/linearGradient%3E%0A%20%20%20%20%3C/defs%3E%0A%20%20%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20rx%3D%2246%22%20ry%3D%2246%22%20fill%3D%22url%28%23g%29%22/%3E%0A%20%20%20%20%3Crect%20x%3D%2234%22%20y%3D%2234%22%20width%3D%22622%22%20height%3D%22919%22%20rx%3D%2240%22%20ry%3D%2240%22%20fill%3D%22rgba%280%2C0%2C0%2C0.35%29%22%20stroke%3D%22rgba%28255%2C255%2C255%2C0.22%29%22%20stroke-width%3D%226%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2245%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2254%22%20fill%3D%22%23ffffff%22%20font-weight%3D%22900%22%3ELEGGENDARIA%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2255%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20Arial%2C%20sans-serif%22%20font-size%3D%2234%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.85%29%22%20font-weight%3D%22800%22%3Ex%3C/text%3E%0A%20%20%20%20%3Ctext%20x%3D%2250%25%22%20y%3D%2290%25%22%20text-anchor%3D%22middle%22%20font-family%3D%22ui-monospace%2C%20Menlo%2C%20Consolas%2C%20monospace%22%20font-size%3D%2222%22%20fill%3D%22rgba%28255%2C255%2C255%2C0.65%29%22%20font-weight%3D%22700%22%3EDEFAULT%20CARD%3C/text%3E%0A%20%20%20%20%3C/svg%3E'}];

const STATE = {
  cards: [],
  spinning: false,
  lastWin: 0
};

const $ = (s)=>document.querySelector(s);
const strips = [$('#strip0'), $('#strip1'), $('#strip2')];


// --- SUONI DEFAULT (Web Audio API) ---
// Nota: l'audio parte solo dopo un gesto utente (click/tap) per policy browser.
let audioCtx = null;

function ensureAudio(){
  if (!audioCtx){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    audioCtx = Ctx ? new Ctx() : null;
  }
  if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  return audioCtx;
}

function tone({freq=440, type='sine', duration=0.08, gain=0.12, sweepTo=null} = {}){
  const ctx = ensureAudio();
  if (!ctx) return;

  const now = ctx.currentTime;
  const o = ctx.createOscillator();
  const g = ctx.createGain();

  o.type = type;
  o.frequency.setValueAtTime(freq, now);
  if (sweepTo != null){
    o.frequency.exponentialRampToValueAtTime(Math.max(1, sweepTo), now + duration);
  }

  // envelope (attack/decay)
  g.gain.setValueAtTime(0.0001, now);
  g.gain.exponentialRampToValueAtTime(gain, now + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now + duration);

  o.connect(g);
  g.connect(ctx.destination);

  o.start(now);
  o.stop(now + duration + 0.02);
}

function playSpinStart(){
  // piccolo "whoosh" retro
  tone({freq:220, type:'sawtooth', duration:0.18, gain:0.10, sweepTo:70});
}

function playReelStop(){
  // click metallico
  tone({freq:900, type:'square', duration:0.035, gain:0.08, sweepTo:650});
}

function playWin(){
  // jingle semplice (triade)
  const ctx = ensureAudio();
  if (!ctx) return;
  const base = ctx.currentTime;
  const notes = [523.25, 659.25, 783.99]; // C5 E5 G5
  notes.forEach((f, i)=>{
    setTimeout(()=>tone({freq:f, type:'triangle', duration:0.11, gain:0.10}), i*95);
  });
}

function playLose(){
  // "thud" basso
  tone({freq:140, type:'triangle', duration:0.12, gain:0.10, sweepTo:95});
}
// --- fine suoni ---

function norm(v){ return String(v||'').trim().toLowerCase(); }
function pad4(n){ const s=String(Math.max(0, Math.floor(n||0))); return s.padStart(4,'0').slice(-4); }

function setDisplay(){ $('#lastWin').textContent = pad4(STATE.lastWin); }

function pickRandomCard(){
  const a = STATE.cards;
  return a[Math.floor(Math.random()*a.length)];
}

function renderStrip(stripEl, cards){
  stripEl.innerHTML = '';
  const frag = document.createDocumentFragment();
  for (const c of cards){
    const img = document.createElement('img');
    img.className = 'card';
    img.src = c.img;
    img.alt = c.name || 'carta';
    img.loading = 'eager';
    img.decoding = 'async';
    frag.appendChild(img);
  }
  stripEl.appendChild(frag);
}


// --- PROBABILITÀ (dipendono dalla rarità) ---
// Totale WIN = 50% (1 su 2). Dentro le vincite, la rarità determina sia frequenza che premio.
const WIN_DIST = [
  { rarity: 'comune',       p: 0.40, prize: 60  },
  { rarity: 'non comune',   p: 0.06, prize: 140 },
  { rarity: 'rara',         p: 0.025, prize: 260 },
  { rarity: 'epica',        p: 0.008, prize: 420 },
  { rarity: 'ultra rara',   p: 0.005, prize: 720 },
  { rarity: 'leggendaria',  p: 0.002, prize: 1000 }
];
const WIN_PROB = WIN_DIST.reduce((a,x)=>a+x.p,0); // 0.50

function pickByProbability(items){
  const r = Math.random();
  let acc = 0;
  for (const it of items){
    acc += it.p;
    if (r < acc) return it;
  }
  return items[items.length-1];
}

function pickCardByRarity(targetRarity){
  const pool = STATE.cards.filter(c => norm(c.rarity) === norm(targetRarity));
  if (pool.length) return pool[Math.floor(Math.random()*pool.length)];
  // fallback se non esistono carte di quella rarità
  return pickRandomCard();
}




function flash(amount){
  const f = $('#flash');
  const txt = $('#flashText');
  txt.textContent = `+${amount}`;
  f.classList.add('show');
  f.setAttribute('aria-hidden','false');
  setTimeout(()=>{ f.classList.remove('show'); f.setAttribute('aria-hidden','true'); }, 850);
}

async function spin(){
  if (STATE.spinning) return;
  if (STATE.cards.length < 3) return;

  STATE.spinning = true;
  $('#spinBtn').disabled = true;
  const lever = $('#lever');
  lever.classList.add('pull');


  playSpinStart();
  let final = [pickRandomCard(), pickRandomCard(), pickRandomCard()];
  let win = 0;

  // Decide outcome: win (50%) or lose (50%)
  if (Math.random() < WIN_PROB){
    const tier = pickByProbability(WIN_DIST);
    const c = pickCardByRarity(tier.rarity);
    final = [c, c, c];
    win = tier.prize;
  } else {
    // ensure NOT 3 uguali
    const id = (x)=> (x.id ?? x.img ?? x.name);
    let tries = 0;
    while (tries < 8 && id(final[0]) && id(final[0]) === id(final[1]) && id(final[1]) === id(final[2])){
      final = [pickRandomCard(), pickRandomCard(), pickRandomCard()];
      tries++;
    }
    win = 0;
  }
  const reelStops = [34, 44, 56];
  const durations = [950, 1250, 1600];
  const easing = 'cubic-bezier(.10,.85,.20,1)';


  // suoni stop rulli
  durations.forEach((d,i)=>setTimeout(playReelStop, Math.max(0, d-140)));
  const anims = strips.map((el, idx)=>{
    const n = reelStops[idx];
    const temp = [];
    for (let i=0;i<n;i++) temp.push(pickRandomCard());
    temp.push(final[idx]);
    temp.push(pickRandomCard(), pickRandomCard());
    renderStrip(el, temp);

    el.style.transition = 'none';
    el.style.transform = 'translateY(0)';
    void el.offsetHeight;

    const first = el.querySelector('img');
    const h = first ? first.getBoundingClientRect().height : 0;
    const travel = -h * n;

    el.style.transition = `transform ${durations[idx]}ms ${easing}`;
    el.style.transform = `translateY(${travel}px)`;

    return new Promise(res=>setTimeout(res, durations[idx]+30));
  });

  await Promise.all(anims);

  lever.classList.remove('pull');

  STATE.lastWin = win;
  setDisplay();
  if (win > 0) { flash(win); playWin(); }
  else { playLose();
    const f = $('#flash'); const txt = $('#flashText');
    txt.textContent = 'NO WIN';
    f.classList.add('show'); f.setAttribute('aria-hidden','false');
    setTimeout(()=>{ f.classList.remove('show'); f.setAttribute('aria-hidden','true'); }, 650);
  }
STATE.spinning = false;
  $('#spinBtn').disabled = false;
}

async function loadCards(){
  // Try cards.json, fallback to embedded default cards
  try {
    const res = await fetch('cards.json', { cache:'no-store' });
    if (!res.ok) throw new Error('HTTP '+res.status);
    const json = await res.json();
    if (!Array.isArray(json)) throw new Error('Formato non valido');

    const cleaned = [];
    const seen = new Set();
    for (const c of json){
      if (!c || typeof c !== 'object') continue;
      const id = c.id ?? (c.name ? String(c.name) : '') + '-' + Math.random().toString(36).slice(2,8);
      if (seen.has(id)) continue;
      seen.add(id);
      if (!c.img || !c.name) continue;
      cleaned.push({
        id,
        name: String(c.name||''),
        img: String(c.img||''),
        rarity: String(c.rarity||''),
        series: String(c.series||''),
        game: String(c.game||'')
      });
    }
    if (cleaned.length < 3) throw new Error('Pool troppo piccola');
    STATE.cards = cleaned;
  } catch (e) {
    STATE.cards = DEFAULT_CARDS.slice();
  }
}

async function init(){
  setDisplay();
  $('#spinBtn').addEventListener('click', spin);
  $('#lever').addEventListener('click', (e)=>{
    if (e.target && (e.target.id==='lever' || e.target.classList.contains('rail') || e.target.classList.contains('knob'))) spin();
  });

  await loadCards();

  // Populate initial reels
  const initCards = [pickRandomCard(), pickRandomCard(), pickRandomCard()];
  strips.forEach((el, idx)=>{
    const temp = [];
    for (let i=0;i<10;i++) temp.push(pickRandomCard());
    temp.push(initCards[idx]);
    renderStrip(el, temp);
  });
}
init();
</script>
</body>
</html>

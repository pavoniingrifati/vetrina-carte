<!DOCTYPE html>
<html lang="it">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Firebase Connectivity Test (compat)</title>
<style>
  body{font:16px/1.4 system-ui,Arial; background:#0b0f19; color:#ecf0ff; padding:20px}
  .card{background:#121a2e;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:16px;max-width:820px}
  .ok{color:#10b981}.err{color:#ff6b6b}.muted{color:#a7b0d3} code{background:#0d1325;padding:2px 6px;border-radius:6px}
</style>
<div class="card"><h1>Firebase Connectivity Test (compat)</h1><div id="log" class="muted">Esecuzione testâ€¦</div></div>

<!-- Compat SDK: registra i componenti in automatico -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script>
  const log = (m,c)=>{const el=document.getElementById('log');const d=document.createElement('div');if(c)d.className=c;d.innerHTML=m;el.appendChild(d);};

  const firebaseConfig = {
    apiKey: "AIzaSyDv23gasgBuAtPeDJeztyJ5P2S7NWq1svo",
    authDomain: "fantaball-9e19c.firebaseapp.com",
    projectId: "fantaball-9e19c",
    storageBucket: "fantaball-9e19c.appspot.com",
    messagingSenderId: "683304379837",
    appId: "1:683304379837:web:d2bbe7a814e2e40e075ed4",
    measurementId: "G-C8Q8K5B52C"
  };

  (async ()=>{
    try{
      firebase.initializeApp(firebaseConfig);
      await firebase.auth().signInAnonymously();
      const uid = firebase.auth().currentUser?.uid || 'anon';
      log("Auth anonima: <b class='ok'>OK</b> â€” uid=<code>"+uid+"</code>");

      const db = firebase.firestore();
      await db.collection('cards').doc('__PING__').collection('ratings').doc(uid).set({
        value: 5, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      log("Scrittura Firestore: <b class='ok'>OK</b> â€” <code>cards/__PING__/ratings/"+uid+"</code>");

      const snap = await db.collection('cards').doc('__PING__').collection('ratings').get();
      log("Lettura Firestore: <b class='ok'>OK</b> â€” docs: <code>"+snap.size+"</code>");

      db.collection('cards').doc('__PING__').collection('comments')
        .orderBy('createdAt','desc')
        .onSnapshot(s=> log("Realtime commenti: <b class='ok'>OK</b> â€” count: <code>"+s.size+"</code>"));
      await db.collection('cards').doc('__PING__').collection('comments').add({
        author:'Test', text:'Ciao ðŸŽ‰', uid, createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      log("<hr/><span class='ok'>TUTTO OK</span>: Firebase risponde da questo dominio.");
    }catch(e){
      log("ERRORE: <b class='err'>"+(e.message||e.code||String(e))+"</b>", "err");
      log("Suggerimenti: <ul>"+
        "<li>Authentication â†’ Sign-in method â†’ abilita Anonymous</li>"+
        "<li>API Key â†’ HTTP referrers: <code>https://pavoniingrifati.github.io/*</code></li>"+
        "<li>Abilita API: Firestore, Identity Toolkit, Firebase Installations</li>"+
        "</ul>");
    }
  })();
</script>


<!DOCTYPE html>

<html lang="it">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Progressi Piloti — Skill &amp; EXP (scala con Skill)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&amp;display=swap" rel="stylesheet"/>
<style>
    :root{
      --bg: #0b0d12;
      --surface: #121622;
      --card: #171C2B;
      --text: #e8ecf1;
      --muted: #a7b0c0;
      --ring: #3a435a;
      --shadow: 0 10px 30px rgba(0,0,0,.4);
      --radius: 16px;
    }
    body{ margin:0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap{ max-width:1200px; margin:0 auto; padding:24px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:16px; padding: 8px 0 12px; }
    .brand{ display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px; }
    .brand .logo{ width:42px; height:42px; display:grid; place-items:center; border-radius:12px; background: linear-gradient(135deg, #e10600, #8b0200); box-shadow: var(--shadow) }
    .brand .logo svg{ width:26px; height:26px; fill:white }
    .brand small{ display:block; color: var(--muted); font-weight:600 }

    .grid{ display:grid; grid-template-columns: 1fr; gap:16px; margin-top:18px }
    @media (min-width:700px){ .grid{ grid-template-columns: 1fr 1fr } }
    @media (min-width:1100px){ .grid{ grid-template-columns: 1fr 1fr 1fr } }

    .card{ background: var(--card); border:3px solid var(--ring); border-radius: var(--radius); padding:16px; position:relative; overflow:hidden; box-shadow: var(--shadow); }
    .card-header{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px }
    .title{ font-weight:800; font-size:18px; }
    .subtitle{ color:var(--muted); font-size:13px }

    .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .tag{ font-size:12px; font-weight:700; padding:6px 8px; border-radius:999px; border:1px solid var(--ring); background: rgba(255,255,255,.02) }

    .bar{ margin-top:10px; background: var(--surface); border:1px solid var(--ring); border-radius:999px; height:12px; overflow:hidden; }
    .fill{ height:100%; background: linear-gradient(90deg, var(--accent, #00d2ff), var(--primary, #e10600)); width:0% }

    .meta{ display:flex; justify-content:space-between; align-items:center; margin-top:8px; color:var(--muted); font-size:12px; font-weight:700 }
    .empty{ text-align:center; padding:48px 16px; color:var(--muted); border:1px dashed var(--ring); border-radius:16px; margin-top:18px }
    footer{ margin: 28px 0 48px; color:var(--muted); text-align:center; font-size:12px }
  </style>
</head>
<body>
<div class="wrap">
<header>
<div class="brand">
<div aria-hidden="true" class="logo">
<svg aria-label="Logo" role="img" viewbox="0 0 24 24">
<path d="M21.93 7.23c-1.34-2.25-4.28-3.01-6.51-1.67l-3.9 2.33 1.53 2.56 3.9-2.33a2.5 2.5 0 1 1 2.5 4.33l-6.12 3.66 1.53 2.56 6.12-3.66c2.23-1.34 2.99-4.28 1.65-6.48zM4 7h6v3H4a2 2 0 0 0 0 4h6v3H4A5 5 0 0 1 4 7z"></path>
</svg>
</div>
<div>
<div style="font-size:18px">Progressi Piloti</div>
<small>EXP scala con Skill: più forte = più EXP per livello</small>
</div>
</div>
</header>
<main aria-live="polite" class="grid" id="grid"></main>
<div class="empty" hidden="" id="empty">Nessun pilota trovato.</div>
<footer>Metti questo file nella stessa cartella di <b>piloti.json</b>.</footer>
</div>

<script>
const PILOTI_URL = 'piloti.json';
const EXP_URL    = 'exp.json';  // nuovo file solo per le exp
const MAX_LEVEL = 50;

const grid = document.getElementById('grid');
const empty = document.getElementById('empty');

function baseExpNeeded(n){ return 100 * n * n; }
function baseExpCum(n){ return Math.floor(100 * n*(n+1)*(2*n+1)/6); }

function skillMultiplier(skill){
  const s = Math.max(80, Math.min(100, Number(skill) || 80));
  return 1 + (s - 80) / 20;
}

function levelFromExpWithSkill(exp, skill){
  const m = skillMultiplier(skill);
  const effectiveExp = exp / m;
  let lo = 0, hi = MAX_LEVEL;
  while(lo < hi){
    const mid = Math.ceil((lo + hi + 1) / 2);
    if(baseExpCum(mid) <= effectiveExp) lo = mid; else hi = mid-1;
  }
  return { level: lo, mult: m, effectiveExp };
}

async function load(){
  // 1) piloti.json
  const pilotiRes = await fetch(PILOTI_URL);
  const raw = await pilotiRes.json();
  let PILOTI = [];
  if(Array.isArray(raw) && raw.length && raw[0].piloti){
    PILOTI = raw.flatMap(t => t.piloti.map(p => ({
      ...p,
      scuderia: t.scuderia || 'Team',
      colore: p.colore || t.colore || '#888'
    })));
  } else if(Array.isArray(raw)){
    PILOTI = raw;
  } else {
    PILOTI = raw.piloti || [];
  }
  PILOTI = PILOTI.map(p => ({...p, Exp: (p.Exp ?? 0), colore: p.colore || '#888'}));

  // 2) exp.json → sovrascrive exp per nome
  let expMap = new Map();
  try{
    const expRes = await fetch(EXP_URL, { cache: 'no-store' });
    if(expRes.ok){
      const expRaw = await expRes.json();
      const list = Array.isArray(expRaw) ? expRaw : (expRaw.exp || expRaw.piloti || []);
      for(const e of list){
        const nome = (e.nome ?? e.Nome ?? '').trim();
        if(!nome) continue;
        const expVal = Number(e.Exp ?? e.exp ?? e.EXP ?? 0) || 0;
        expMap.set(nome.toLowerCase(), expVal);
      }
    }
  }catch(_){ }

  // 3) merge per nome
  PILOTI = PILOTI.map(p => {
    let exp = expMap.has((p.nome||'').toLowerCase())
      ? expMap.get((p.nome||'').toLowerCase())
      : (p.Exp ?? 0);
    return {...p, Exp: Number(exp) || 0};
  });

  render(PILOTI);
}

function render(list){
  grid.innerHTML = '';
  if(!list.length){ empty.hidden = false; return; }
  empty.hidden = true;

  for(const p of list){
    const exp = Number(p.Exp) || 0;
    const skill = p.skill;
    const { level: lvl, mult: m } = levelFromExpWithSkill(exp, skill);
    const nextLvl = Math.min(MAX_LEVEL, lvl+1);
    const curBaseBase = baseExpCum(lvl);
    const nextNeedBase = nextLvl > lvl ? baseExpNeeded(nextLvl) : 0;
    const curBase = Math.floor(curBaseBase * m);
    const toNext = Math.floor(nextNeedBase * m);
    const inLevel = exp - curBase;
    const progress = toNext ? Math.max(0, Math.min(100, Math.floor((inLevel / toNext) * 100))) : 100;

    const card = document.createElement('article');
    card.className = 'card';
    card.style.borderColor = p.colore || '#888';
    card.innerHTML = `
      <div class="card-header">
        <div>
          <div class="title" style="color:${p.colore||'#e8ecf1'}">${escapeHtml(p.nome||'Pilota')}</div>
          <div class="subtitle">${escapeHtml(p.scuderia||'Team')} · Skill <b>${escapeHtml(p.skill)}</b> · Livello <b>${lvl}</b> · EXP totali: <b>${exp.toLocaleString('it-IT')}</b></div>
          <div class="tags">
            <span class="tag">Moltiplicatore Skill: ×${m.toFixed(2)}</span>
            <span class="tag">Base livello (cum.): ${curBase.toLocaleString('it-IT')}</span>
            <span class="tag">Per salire: ${toNext ? (toNext - Math.max(0,inLevel)).toLocaleString('it-IT') : '—'} EXP</span>
          </div>
          <div class="bar"><div class="fill" style="width:${progress}%; background:${p.colore||'#00d2ff'};"></div></div>
          <div class="meta">
            <span>Progresso livello: ${progress}%</span>
            <span>${Math.max(0,inLevel).toLocaleString('it-IT')} / ${toNext.toLocaleString('it-IT')} EXP</span>
          </div>
        </div>
      </div>
    `;
    grid.appendChild(card);
  }
}

function escapeHtml(str){ return String(str ?? '').replace(/[&<>"]+/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])); }

load();
</script></body>
</html>

<script>
(function(){
  const grid = document.getElementById('newsGrid');
  if(!grid) return;

  // ðŸ”§ METTI QUI IL TUO ID FOGLIO e (facoltativo) il GID della scheda "News Fantaballa"
  const GOOGLE_SHEET_ID = '1CDWSrcwrntK-Zvzy5gJCqqwhZjA5MDXkksuC9P1icz8';
  const GID = ''; // es. '123456789' se la scheda non Ã¨ la prima
  const GVIZ = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json${GID ? `&gid=${GID}` : ''}`;

  // Ordine: prima il foglio, poi i fallback JSON
  const SOURCES = [
    { type:'gviz', url: GVIZ },
    { type:'json', url:'./news.json' },
    { type:'json', url:'https://raw.githubusercontent.com/pavoniingrifati/vetrina-carte/main/news.json' }
  ];

  function fmtDate(iso){
    try{
      const d = new Date(iso);
      return isNaN(d) ? iso : d.toLocaleDateString('it-IT', { day:'2-digit', month:'short', year:'numeric' });
    }catch{ return iso || ''; }
  }

  function render(items){
    grid.innerHTML = '';
    const list = items.slice().sort((a,b)=> new Date(b.date||0) - new Date(a.date||0));
    if(!list.length){ grid.innerHTML = '<p>Nessuna notizia al momento.</p>'; return; }

    for(const art of list){
      const img = art.image || art.img || 'https://images.unsplash.com/photo-1493397212122-2b85dda8106b?q=80&w=1200&auto=format&fit=crop';
      const cat = art.category || art.tag || 'News';
      const title = art.title || 'Senza titolo';
      const excerpt = art.excerpt || art.summary || '';
      const date = art.date ? fmtDate(art.date) : '';
      const url = art.url || art.link || '#';

      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <img class="card__image" src="${img}" alt="${title}" loading="lazy"/>
        <div class="card__body">
          <span class="chip">${cat}</span>
          <h4>${title}</h4>
          <p>${excerpt}</p>
          <div class="meta"><span>${date}</span><a href="${url}" target="_blank" rel="noopener">Leggi</a></div>
        </div>
      `;
      grid.appendChild(card);
    }
  }

  async function fetchGViz(url){
    const txt = await fetch(url, { cache:'no-store' }).then(r=>r.text());
    // GViz risponde con "google.visualization.Query.setResponse(...)"
    const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
    const rows = json?.table?.rows || [];
    // L'ordine delle colonne Ã¨ quello che scrive il tuo Apps Script: [title, category, date, image, excerpt, url, timestamp]
    return rows.map(r=>{
      const c = r.c || [];
      return {
        title:   c[0]?.v || '',
        category:c[1]?.v || 'News',
        date:    c[2]?.v || '',
        image:   c[3]?.v || '',
        excerpt: c[4]?.v || '',
        url:     c[5]?.v || '#'
      };
    }).filter(x=>x.title);
  }

  async function load(){
    for(const src of SOURCES){
      try{
        if(src.type==='gviz'){
          const data = await fetchGViz(src.url);
          if(data.length){ console.info('News source: Google Sheets'); render(data); return; }
        }else{
          const res = await fetch(src.url, { cache:'no-store' });
          if(res.ok){
            const data = await res.json();
            if(Array.isArray(data) && data.length){ console.info('News source:', src.url); render(data); return; }
          }
        }
      }catch(e){
        // passa al prossimo
      }
    }
    grid.innerHTML = '<p>Nessuna notizia al momento.</p>';
  }

  load();
})();
</script>

<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Indovina il Risultato — Live</title>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@500;700&family=Inter:wght@500;700;900&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg1:#0f0f1a;
      --bg2:#141428;
      --txt:#E6E7EE;
      --muted:#9aa0b3;
      --acc1:#7C3AED;
      --acc2:#22D3EE;
      --good:#22c55e;
      --bad:#ef4444;
      --warn:#f59e0b;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0; font-family:"Inter",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--txt); background: radial-gradient(1200px 1200px at 20% -10%, rgba(124,58,237,.18), transparent 60%),
                             radial-gradient(1000px 800px at 120% 20%, rgba(34,211,238,.14), transparent 55%),
                             linear-gradient(180deg, #0b0b14 0%, #0f1021 100%);
      min-height:100dvh; display:flex; justify-content:center; align-items:center;
    }
    .phone{
      width:100%; max-width:480px; aspect-ratio:9/16; height:100dvh; max-height:100dvh;
      padding: env(safe-area-inset-top) 14px env(safe-area-inset-bottom) 14px;
      display:grid; grid-template-rows: auto 1fr auto; gap:12px;
      position:relative;
    }
    .grain:before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.07;
      background-image: radial-gradient(circle at 25% 25%, rgba(255,255,255,.08) 0 2px, transparent 3px),
                        radial-gradient(circle at 75% 75%, rgba(255,255,255,.06) 0 2px, transparent 3px);
      background-size: 24px 24px, 32px 32px; mix-blend-mode:overlay;
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{ display:flex; align-items:center; gap:10px; }
    .logo{ width:34px; height:34px; border-radius:10px; background:linear-gradient(135deg, var(--acc1), var(--acc2));
           box-shadow:0 6px 24px rgba(124,58,237,.35), inset 0 1px 0 rgba(255,255,255,.15); }
    .title{ font-family:"Barlow Condensed", sans-serif; letter-spacing:.5px; font-size:22px; font-weight:800; text-transform:uppercase; }

    .live-pill{ font-weight:800; font-size:12px; letter-spacing:.6px; padding:8px 10px; border-radius:999px;
                display:inline-flex; align-items:center; gap:8px; border:1px solid rgba(255,255,255,.1);
                background:rgba(255,255,255,.04); backdrop-filter: blur(8px); }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--warn); box-shadow:0 0 0 0 rgba(245,158,11,.8); animation:pulse 1.6s infinite; }
    .live{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.25); }
    .live .dot{ background:var(--good); box-shadow:0 0 0 0 rgba(34,197,94,.8); }
    @keyframes pulse{ to{ box-shadow:0 0 0 10px rgba(0,0,0,0); } }

    .card{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
           border:1px solid rgba(255,255,255,.10); border-radius:22px; padding:16px; box-shadow:0 10px 40px rgba(0,0,0,.35);
           position:relative; overflow:hidden; }

    .cta{ text-align:center; }
    .cta h2{ margin:0 0 4px; font-weight:900; font-size:28px; letter-spacing:-.4px; }
    .cta p{ margin:0; color:var(--muted); font-weight:600; font-size:14px; }

    .versus{
      margin:14px 0;
      display:flex;
      justify-content:center;
      gap:20px;
      align-items:center;
      text-align:center;
    }
    .team-img { max-width: 100%; max-height: 80px; object-fit: contain; border-radius: 10px; background: rgba(255,255,255,0.06); padding: 4px; }

    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .btn{ appearance:none; border:none; border-radius:14px; padding:12px 14px; font-weight:900; letter-spacing:.3px;
          text-transform:uppercase; cursor:pointer; color:white; box-shadow:0 6px 18px rgba(0,0,0,.25);
          transition: transform .05s ease, box-shadow .2s ease; }
    .btn:active{ transform:translateY(1px); box-shadow:0 4px 10px rgba(0,0,0,.2); }
    .btn-open{ background: linear-gradient(135deg, #22c55e, #16a34a); }
    .btn-close{ background: linear-gradient(135deg, #ef4444, #b91c1c); }
    .btn-check{ grid-column:1/-1; background: linear-gradient(135deg, var(--acc1), var(--acc2)); }

    .result{
      margin:10px 0 2px; display:flex; gap:10px; align-items:center;
    }
    input[type="text"]{
      flex:1; height:48px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06); color:var(--txt); font-size:18px; font-weight:800; text-align:center;
      outline:none; padding:0 10px; caret-color:#fff;
    }
    input[type="text"]::placeholder{ color:rgba(230,231,238,.55); font-weight:700; }

    .chips{
      display:flex; flex-wrap:wrap; gap:8px; max-height:110px; overflow:auto; padding:6px 2px; margin-top:6px;
      scrollbar-width:thin; scrollbar-color: rgba(255,255,255,.25) transparent; border-top:1px dashed rgba(255,255,255,.12);
    }
    .chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.14); padding:6px 10px; border-radius:999px; font-weight:800; font-size:13px; }

    .winner{ margin-top:10px; font-weight:900; text-align:center; }
    .winner.good{ color:var(--good); }
    .winner.bad{ color:var(--muted); }

    .footer{
      display:grid; grid-template-columns:1fr; align-items:center; gap:10px;
    }
    .hint{ color:var(--muted); font-size:13px; }

    .safe{ position:absolute; inset:0; pointer-events:none; display:none; }
    .safe.on{ display:block; }
    .safe:before{ content:""; position:absolute; inset:10% 6%; border:2px dashed rgba(255,255,255,.25); border-radius:24px; }
  </style>
</head>
<body class="grain">
  <audio id="openSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
  <audio id="closeSound" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>

  <main class="phone card" id="app">
    <div class="safe" id="safeGuide"></div>

    <header class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">Indovina il Risultato</div>
      </div>
      <div id="livePill" class="live-pill"><span class="dot"></span><span id="liveTxt">NO LIVE</span></div>
    </header>

    <section class="card" style="display:flex; flex-direction:column; gap:10px;">
      <div class="cta">
        <h2>100 PUNTI A CHI INDOVINA</h2>
        <p>Scrivi in chat: <strong>1-0</strong>, <strong>2-1</strong>, <strong>3-2</strong>…</p>
      </div>

      <div class="versus">
        <img src="img/fantaballa.png" alt="Fantaballa" class="team-img">
        <img src="img/gotham.png" alt="Gotham" class="team-img">
      </div>

      <div class="actions">
        <button id="btnOpen" class="btn btn-open" type="button">Apri pronostico</button>
        <button id="btnClose" class="btn btn-close" type="button">Chiudi</button>
        <button id="btnCheck" class="btn btn-check" type="button">Controlla vincitori</button>
      </div>

      <div class="result">
        <input id="finalResult" type="text" inputmode="numeric" pattern="\\d{1,2}-\\d{1,2}" placeholder="Risultato finale es. 2-1" autocomplete="off" />
      </div>

      <div class="chips" id="recentPredictions" aria-live="polite" aria-relevant="additions text"></div>

      <div id="winnerList" class="winner"></div>
    </section>

    <footer class="footer">
      <div class="hint">Stato: <span id="status">Disconnected</span></div>
    </footer>
  </main>

  <script>
    let websocket = null;
    let bettingOpen = false;
    let predictions = Object.create(null);

    const statusEl = document.getElementById('status');
    const pill = document.getElementById('livePill');
    const pillTxt = document.getElementById('liveTxt');
    const btnOpen = document.getElementById('btnOpen');
    const btnClose = document.getElementById('btnClose');
    const btnCheck = document.getElementById('btnCheck');
    const chips = document.getElementById('recentPredictions');
    const winnerList = document.getElementById('winnerList');
    const finalResultInput = document.getElementById('finalResult');
    const safeGuide = document.getElementById('safeGuide');

    function setStatus(text, live=false){
      statusEl.textContent = text;
      if(live){
        pill.classList.add('live'); pillTxt.textContent = 'LIVE';
      } else {
        pill.classList.remove('live'); pillTxt.textContent = 'NO LIVE';
      }
    }
    function addChip(user, msg){
      const el = document.createElement('span');
      el.className = 'chip';
      el.textContent = `@${user} ${msg}`;
      chips.prepend(el);
      if(chips.children.length > 24) chips.lastChild.remove();
    }
    function play(id){ const el = document.getElementById(id); el && el.play && el.play().catch(()=>{}); }

    function startBets(){
      bettingOpen = true;
      predictions = {};
      winnerList.textContent = '';
      btnOpen.textContent = 'Pronostico Aperto';
      play('openSound');
      setStatus('Pronostici aperti!', true);
    }
    function stopBets(){
      bettingOpen = false;
      btnOpen.textContent = 'Apri pronostico';
      play('closeSound');
      setStatus('Pronostici chiusi', false);
    }
    function checkWinners(){
      const val = finalResultInput.value.trim();
      if(!/^\\d{1,2}-\\d{1,2}$/.test(val)){
        alert('Inserisci un risultato valido nel formato X-Y');
        return;
      }
      const winners = Object.entries(predictions).filter(([_,r]) => r === val).map(([u])=>u);
      if(winners.length){
        winnerList.className = 'winner good';
        winnerList.innerHTML = 'Hanno indovinato:<br>' + winners.map(u=>`@${u}`).join(', ');
        triggerConfetti();
      } else {
        winnerList.className = 'winner bad';
        winnerList.textContent = 'Nessuno ha indovinato il risultato esatto.';
      }
    }

    function connect(){
      setStatus('Connecting...', false);
      try{
        websocket = new WebSocket('ws://localhost:21213/');
      }catch(e){ setTimeout(connect, 2000); return; }

      websocket.onopen = ()=> setStatus('Connected', true);
      websocket.onclose = ()=>{ setStatus('Disconnected', false); websocket = null; setTimeout(connect, 2000); };
      websocket.onerror = ()=>{ setStatus('Errore di connessione', false); websocket = null; setTimeout(connect, 2000); };

      websocket.onmessage = (event)=>{
        try{
          const data = JSON.parse(event.data);
          if(data.event === 'chat'){
            const id = data.data?.uniqueId || 'utente';
            const msg = (data.data?.comment || '').trim();
            if(bettingOpen && /^\\d{1,2}-\\d{1,2}$/.test(msg) && !predictions[id]){
              predictions[id] = msg; addChip(id, msg);
            }
          }
        }catch(_){}
      };
    }

    function triggerConfetti(){
      const holder = document.createElement('div');
      holder.style.position = 'fixed'; holder.style.inset = 0; holder.style.pointerEvents='none';
      holder.innerHTML = '<canvas id=\"confettiCanvas\"></canvas>';
      document.body.appendChild(holder);
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js';
      s.onload = ()=>{ const my = window.confetti.create(document.getElementById('confettiCanvas'), { resize:true });
        my({ particleCount: 180, spread: 100, origin: { y: 0.6 } }); setTimeout(()=> holder.remove(), 2800);
      };
      document.body.appendChild(s);
    }

    btnOpen.addEventListener('click', startBets);
    btnClose.addEventListener('click', stopBets);
    btnCheck.addEventListener('click', checkWinners);

    window.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase()==='s') safeGuide.classList.toggle('on');
      if(e.key.toLowerCase()==='o') startBets();
      if(e.key.toLowerCase()==='c') stopBets();
    });

    window.addEventListener('load', connect);
  </script>
</body>
</html>
